<!DOCTYPE html>
<!--
================================================================================
ì œì•ˆì œë„ ì‹œìŠ¤í…œ - ë¦¬ë” ëŒ€ì‹œë³´ë“œ
================================================================================

ë³€ê²½ ì´ë ¥:
--------------------------------------------------------------------------------
ë²„ì „: 2.1.0
ë‚ ì§œ: 2025-01-27
ì‘ì„±ì: Claude AI Assistant

[ì£¼ìš” ë³€ê²½ ì‚¬í•­]

1. ìì²´í‰ê°€ í‘œì‹œ ê°„ì†Œí™”
   - ìœ„ì¹˜: í‰ê°€ ëª¨ë‹¬ (ë¼ì¸ 851-867)
   - ë³€ê²½ ì „: ë…¸ë ¥ë„/ì°½ì˜ì„±/ìœ ë¬´í˜•íš¨ê³¼ ê°œë³„ ì ìˆ˜ í‘œì‹œ
   - ë³€ê²½ í›„: ì´ì ê³¼ ë“±ê¸‰ë§Œ í‘œì‹œ
   - ì‚¬ìœ : í‰ê°€ìì—ê²Œ í•„ìš”í•œ í•µì‹¬ ì •ë³´ë§Œ ì œê³µ
   - ì˜í–¥: UI ê°„ê²°í™” ë° í‰ê°€ ì§‘ì¤‘ë„ í–¥ìƒ

2. í‰ê°€í•­ëª© í…ìŠ¤íŠ¸ ìƒì„¸í™”
   - ìœ„ì¹˜: ë…¸ë ¥ë„ (ë¼ì¸ 876-887), ì°½ì˜ì„± (ë¼ì¸ 890-902)
   - ë…¸ë ¥ë„: ì¼ìˆ˜ ê¸°ì¤€ ëª…ì‹œ
     * 30ì : 8ì¼ ì´ìƒì˜ ë…¸ë ¥, ë§¤ìš° ë†’ì€ ì—…ë¬´ ë‚œì´ë„
     * 25ì : 4~7ì¼ ì •ë„ì˜ ë…¸ë ¥, ë†’ì€ ì—…ë¬´ ë‚œì´ë„
     * 20ì : 2~3ì¼ ì •ë„ì˜ ë…¸ë ¥
     * 15ì : 1ì¼ ì •ë„ì˜ ë…¸ë ¥
     * 10ì : 1ì¼ ì´í•˜ì˜ ë…¸ë ¥
     * 0ì : ë…¸ë ¥ ë¯¸í¡
   - ì°½ì˜ì„±: ìœ ì‚¬ ì‚¬ë¡€ ê¸°ì¤€ ëª…ì‹œ
     * 15ì : ì—…ê³„ ìµœì´ˆì˜ í˜ì‹ ì  ì•„ì´ë””ì–´
     * 12ì : íƒ€ íšŒì‚¬ì— ìœ ì‚¬ ì‚¬ë¡€ê°€ ìˆìŒ (ìµœì´ˆ ë„ì…)
     * 10ì : ìš°ë¦¬ íŒ€ì— ìœ ì‚¬ ì‚¬ë¡€ê°€ ìˆìŒ
     * 7ì : íƒ€ íŒ€ì— ìœ ì‚¬ ì‚¬ë¡€ê°€ ìˆìŒ
     * 5ì : ì°½ì˜ì„± ë‚®ìŒ
     * 0ì : ì°½ì˜ì„± ì—†ìŒ
   - ì˜í–¥: í‰ê°€ ê¸°ì¤€ì˜ ê°ê´€ì„± ë° ì¼ê´€ì„± í™•ë³´

3. ìœ í˜•íš¨ê³¼ ê²€ì¦ ê²°ê³¼ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€
   - ìœ„ì¹˜: í‰ê°€ ëª¨ë‹¬ (ë¼ì¸ 869-891), í‘œì‹œ ë¡œì§ (ë¼ì¸ 1643-1664)
   - ë‚´ìš©: ìœ í˜•íš¨ê³¼ ê²€ì¦ì´ ì™„ë£Œëœ ì œì•ˆì„œì˜ ê²½ìš° ê²€ì¦ ì •ë³´ í‘œì‹œ
   - í‘œì‹œ ì •ë³´:
     * ì œì•ˆì ì˜ˆìƒ ê¸ˆì•¡
     * ê²€ì¦ì í™•ì • ê¸ˆì•¡ (ê°•ì¡° í‘œì‹œ)
     * ê²€ì¦ ì˜ê²¬
     * ê²€ì¦ì ì •ë³´ (ì´ë¦„, ê²€ì¦ì¼)
   - ì¡°ê±´: hasTypicalEffect === true && effectVerification.status === 'verified'
   - ì˜í–¥: í‰ê°€ìê°€ ê²€ì¦ëœ ê¸ˆì•¡ì„ ê¸°ì¤€ìœ¼ë¡œ í‰ê°€ ê°€ëŠ¥

4. ì˜¤ë¥˜ ìˆ˜ì •
   - ë°˜ë ¤ ë²„íŠ¼ ì˜¤ë¥˜ ìˆ˜ì • (ë¼ì¸ 1828)
     * ë¬¸ì œ: reviewScore ìš”ì†Œê°€ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜
     * í•´ê²°: ë°˜ë ¤ ì‹œ ì ìˆ˜ë¥¼ 0ìœ¼ë¡œ ê³ ì •
   - loadAllData í•¨ìˆ˜ ì¶”ê°€ (ë¼ì¸ 1579-1585)
     * ë¬¸ì œ: ìŠ¹ì¸/ìˆ˜ì •ìš”ì²­ í›„ loadAllData í•¨ìˆ˜ê°€ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜
     * í•´ê²°: ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ëŠ” loadAllData í•¨ìˆ˜ êµ¬í˜„
     * ì˜í–¥: ìŠ¹ì¸/ìˆ˜ì •ìš”ì²­ ë²„íŠ¼ ì •ìƒ ì‘ë™

[ê¸°ìˆ ì  ë³€ê²½]
- loadAllData() í•¨ìˆ˜ ì‹ ê·œ ì¶”ê°€
- ìì²´í‰ê°€ í‘œì‹œ UI êµ¬ì¡° ë³€ê²½
- ê²€ì¦ ì •ë³´ ì„¹ì…˜ ì¶”ê°€ (verificationInfoSection)
- í‰ê°€ í•­ëª© option ê°’ ë° í…ìŠ¤íŠ¸ ê°œì„ 

[ë²„ê·¸ ìˆ˜ì •]
- ë°˜ë ¤ ë²„íŠ¼ í´ë¦­ ì‹œ "Cannot read properties of null (reading 'value')" ì˜¤ë¥˜ í•´ê²°
- ìˆ˜ì •ìš”ì²­ ë²„íŠ¼ í´ë¦­ ì‹œ "loadAllData is not defined" ì˜¤ë¥˜ í•´ê²°
- ìŠ¹ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ "loadAllData is not defined" ì˜¤ë¥˜ í•´ê²°

[í˜¸í™˜ì„±]
- ê¸°ì¡´ ì œì•ˆì„œ ë°ì´í„°ì™€ í˜¸í™˜
- Firestore ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ìŒ
- effectVerification í•„ë“œê°€ ì—†ëŠ” ê¸°ì¡´ ì œì•ˆì„œë„ ì •ìƒ ì²˜ë¦¬

================================================================================
-->
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ë” ì‹œìŠ¤í…œ - ì œì•ˆì œë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ëª¨ë°”ì¼ í—¤ë” */
        .mobile-header {
            display: none;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .user-info {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 15px 25px;
            background: none;
            border: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #495057;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-secondary {
            background: #6c757d;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: white;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 600;
            color: #667eea;
        }

        /* ì¹´ë“œ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-body {
            padding: 25px;
        }

        /* í…Œì´ë¸” */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ì½˜í…ì¸  ì„¹ì…˜ */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close-btn {
            float: right;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        /* í¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* ì •ë³´ ë°•ìŠ¤ */
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-box strong {
            color: #667eea;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.info {
            border-left: 4px solid #17a2b8;
        }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .logout-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 80px 20px 20px;
            }

            .mobile-header {
                display: flex;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 12px;
            }

            .table th, .table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ëª¨ë°”ì¼ í—¤ë” -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
        <h2 style="font-size: 18px;">ë¦¬ë” ì‹œìŠ¤í…œ</h2>
        <div style="width: 30px;"></div>
    </div>

    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>âœï¸ ë¦¬ë” ì‹œìŠ¤í…œ</h2>
                <div class="user-info" id="userInfo">
                    ë¡œë”© ì¤‘...
                </div>
            </div>

            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    <span>ğŸ“Š ëŒ€ì‹œë³´ë“œ</span>
                </button>
                <button class="nav-item" onclick="showSection('newSuggestion')">
                    <span>âœï¸ ì œì•ˆì„œ ì‘ì„±</span>
                </button>
                <button class="nav-item" onclick="showSection('mySuggestions')">
                    <span>ğŸ“ ë‚´ ì œì•ˆ</span>
                </button>
                <button class="nav-item" onclick="showSection('pending')">
                    <span>â° ê²°ì¬ ëŒ€ê¸°</span>
                    <span class="badge badge-danger" id="pendingCount">0</span>
                </button>
                <button class="nav-item" onclick="showSection('reviewing')">
                    <span>ğŸ“‹ ê²€í†  ì¤‘</span>
                    <span class="badge badge-warning" id="reviewingCount">0</span>
                </button>
                <button class="nav-item" onclick="showSection('completed')">
                    <span>âœ… ì²˜ë¦¬ ì™„ë£Œ</span>
                </button>
                <button class="nav-item" onclick="showSection('allSuggestions')">
                    <span>ğŸ“‹ ì „ì²´ ì œì•ˆ</span>
                </button>
                <button class="nav-item" onclick="showSection('stats')">
                    <span>ğŸ“Š í†µê³„</span>
                </button>
            </div>

            <div style="padding: 0 20px;">
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboard" class="content-section active">
                <div class="page-header">
                    <h1>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
                    <p>ë‚˜ì˜ ê²°ì¬ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ê²°ì¬ ëŒ€ê¸°</h3>
                        <div class="number" id="statPending">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì¦‰ì‹œ ê²€í†  í•„ìš”</p>
                    </div>
                    <div class="stat-card">
                        <h3>ì´ë²ˆ ì£¼ ì²˜ë¦¬</h3>
                        <div class="number" style="color: #28a745;" id="statWeek">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ìµœê·¼ 7ì¼</p>
                    </div>
                    <div class="stat-card">
                        <h3>ì´ë²ˆ ë‹¬ ì²˜ë¦¬</h3>
                        <div class="number" style="color: #17a2b8;" id="statMonth">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì´ë²ˆ ë‹¬ ì´í•©</p>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ì²˜ë¦¬ ì‹œê°„</h3>
                        <div class="number" style="color: #ffc107; font-size: 28px;" id="statAvgTime">0ì¼</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì œì¶œ~ìŠ¹ì¸</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ìµœê·¼ ê²°ì¬ ëŒ€ê¸° ì œì•ˆì„œ</h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('pending')">ì „ì²´ ë³´ê¸°</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ì ‘ìˆ˜ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="recentPendingList">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        ê²°ì¬ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì œì•ˆì„œ ì‘ì„± ì„¹ì…˜ - showSectionì—ì„œ ëŒ€ì‹œë³´ë“œë¡œ ìë™ ì´ë™ -->
            <div id="newSuggestion" class="content-section"></div>

            <!-- ë‚´ ì œì•ˆ ì„¹ì…˜ - showSectionì—ì„œ ëŒ€ì‹œë³´ë“œë¡œ ìë™ ì´ë™ -->
            <div id="mySuggestions" class="content-section"></div>

            <!-- ê²°ì¬ ëŒ€ê¸° ì„¹ì…˜ -->
            <div id="pending" class="content-section">
                <div class="page-header">
                    <h1>â° ê²°ì¬ ëŒ€ê¸°</h1>
                    <p>ë‚´ê°€ ê²°ì¬í•´ì•¼ í•  ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ê²°ì¬ ëŒ€ê¸° ì œì•ˆì„œ</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadPendingSuggestions()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">ì œì•ˆë²ˆí˜¸</th>
                                    <th style="width: 100px;">ì œì•ˆì</th>
                                    <th style="width: 100px;">ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th style="width: 100px;">ì ‘ìˆ˜ì¼</th>
                                    <th style="width: 80px;">ìì²´í‰ê°€</th>
                                    <th style="width: 150px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="pendingList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ê²€í†  ì¤‘ ì„¹ì…˜ -->
            <div id="reviewing" class="content-section">
                <div class="page-header">
                    <h1>ğŸ“‹ ê²€í†  ì¤‘</h1>
                    <p>ë‹¤ìŒ ê²°ì¬ì ê²€í†  ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ë‚˜ì˜ ê²°ì¬</th>
                                    <th>í˜„ì¬ ë‹¨ê³„</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="reviewingList">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì²˜ë¦¬ ì™„ë£Œ ì„¹ì…˜ -->
            <div id="completed" class="content-section">
                <div class="page-header">
                    <h1>âœ… ì²˜ë¦¬ ì™„ë£Œ</h1>
                    <p>ë‚´ê°€ ì²˜ë¦¬í•œ ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ë‚˜ì˜ í‰ê°€</th>
                                    <th>ìµœì¢… ìƒíƒœ</th>
                                    <th>ì²˜ë¦¬ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="completedList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì „ì²´ ì œì•ˆ ì„¹ì…˜ -->
            <div id="allSuggestions" class="content-section">
                <div class="page-header">
                    <h1>ğŸ“‹ ì „ì²´ ì œì•ˆ</h1>
                    <p>ëª¨ë“  ì‚¬ìš©ìì˜ ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì ‘ìˆ˜ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="allSuggestionsList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- í†µê³„ ì„¹ì…˜ -->
            <div id="stats" class="content-section">
                <div class="page-header">
                    <h1>ğŸ“Š í†µê³„</h1>
                    <p>ë‚˜ì˜ ê²°ì¬ í™œë™ í†µê³„ì…ë‹ˆë‹¤</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ì´ ì²˜ë¦¬ ê±´ìˆ˜</h3>
                        <div class="number" id="statsTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ìŠ¹ì¸ ê±´ìˆ˜</h3>
                        <div class="number" style="color: #28a745;" id="statsApproved">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ë°˜ë ¤ ê±´ìˆ˜</h3>
                        <div class="number" style="color: #dc3545;" id="statsRejected">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ìŠ¹ì¸ìœ¨</h3>
                        <div class="number" style="color: #17a2b8;" id="statsApprovalRate">0%</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ì›”ë³„ ì²˜ë¦¬ í˜„í™©</h3>
                    </div>
                    <div class="card-body">
                        <div id="monthlyStats" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #999;">
                            í†µê³„ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í‰ê°€ ëª¨ë‹¬ -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì œì•ˆì„œ í‰ê°€</h3>
                <button class="close-btn" onclick="closeReviewModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- ì œì•ˆì„œ ì •ë³´ -->
                <div class="info-box">
                    <strong>ì œì•ˆë²ˆí˜¸:</strong> <span id="modalSugNumber"></span><br>
                    <strong>ì œì•ˆì:</strong> <span id="modalProposer"></span><br>
                    <strong>ë¶€ì„œ:</strong> <span id="modalDepartment"></span><br>
                    <strong>ì ‘ìˆ˜ì¼:</strong> <span id="modalSubmitDate"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">ì œì•ˆë‚´ìš©</label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p id="modalTitle" style="font-weight: 600; margin-bottom: 10px;"></p>
                        <p id="modalCurrentSituation" style="color: #666; font-size: 14px;"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ë³€ê²½(ì‹ ê·œ)ë‚´ìš©</label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p id="modalImprovementPlan" style="color: #666; font-size: 14px;"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ìì²´í‰ê°€</label>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">ì¢…í•©ì ìˆ˜ì— ë”°ë¥¸ ë“±ê¸‰</div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                            <div>
                                <div style="font-size: 14px; color: #666;">ì´ì </div>
                                <div style="font-size: 32px; font-weight: 700; color: #667eea;" id="modalTotalScore">0</div>
                            </div>
                            <div style="font-size: 40px; color: #ddd;">â†’</div>
                            <div>
                                <div style="font-size: 14px; color: #666;">ë“±ê¸‰</div>
                                <div style="font-size: 32px; font-weight: 700; color: #28a745;" id="modalSelfGrade">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìœ í˜•íš¨ê³¼ ê²€ì¦ ì •ë³´ (ê²€ì¦ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ) -->
                <div id="verificationInfoSection" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ’° ìœ í˜•íš¨ê³¼ ê²€ì¦ ê²°ê³¼</label>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border: 2px solid #ffc107;">
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #856404; margin-bottom: 5px;">ì œì•ˆì ì˜ˆìƒ ê¸ˆì•¡</div>
                                <div style="font-size: 20px; font-weight: 600; color: #856404;" id="modalOriginalAmount">-</div>
                            </div>
                            <div style="border-top: 1px solid #ffc107; padding-top: 15px;">
                                <div style="font-size: 12px; color: #28a745; margin-bottom: 5px;">ê²€ì¦ì í™•ì • ê¸ˆì•¡</div>
                                <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="modalVerifiedAmount">-</div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ffc107;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ê²€ì¦ ì˜ê²¬</div>
                                <div style="font-size: 14px; color: #333;" id="modalVerifierComment">-</div>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #856404;">
                                ê²€ì¦ì: <span id="modalVerifierName">-</span> | ê²€ì¦ì¼: <span id="modalVerifiedAt">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í‰ê°€ ì…ë ¥ -->
                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e9ecef;">

                <h4 style="margin-bottom: 20px; color: #333;">ğŸ“ í‰ê°€ í•­ëª©</h4>

                <!-- ë…¸ë ¥ë„ -->
                <div class="form-group">
                    <label class="form-label">ë…¸ë ¥ë„ (0~15ì ) *</label>
                    <select class="form-input" id="reviewEffortScore" required onchange="calculateReviewScore()">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="15">15ì  - 80ì‹œê°„ ì´ìƒì˜ ë…¸ë ¥</option>
                        <option value="10">10ì  - 80ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥</option>
                        <option value="5">5ì  - 8ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥</option>
                        <option value="0">0ì  - ë…¸ë ¥ ë¯¸í¡</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">íˆ¬ì…ëœ ë…¸ë ¥ ì‹œê°„</div>
                </div>

                <!-- ì°½ì˜ì„± -->
                <div class="form-group">
                    <label class="form-label">ì°½ì˜ì„± (0~15ì ) *</label>
                    <select class="form-input" id="reviewCreativityScore" required onchange="calculateReviewScore()">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="15">15ì  - ë³¸ë¶€ì— ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ì—†ë‹¤</option>
                        <option value="10">10ì  - ë³¸ë¶€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤</option>
                        <option value="5">5ì  - íŒ€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤</option>
                        <option value="0">0ì  - ì°½ì˜ì„± ì—†ìŒ</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ì•„ì´ë””ì–´ì˜ ë…ì°½ì„±</div>
                </div>

                <!-- ë¬´í˜•íš¨ê³¼ - í’ˆì§ˆ -->
                <div class="form-group">
                    <label class="form-label">ë¬´í˜•íš¨ê³¼ - í’ˆì§ˆ (0~10ì )</label>
                    <select class="form-input" id="reviewQualityScore" onchange="calculateReviewScore()">
                        <option value="0">0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ</option>
                        <option value="5">5ì  - í˜„ì¬ë³´ë‹¤ í’ˆì§ˆìˆ˜ì¤€ì´ ì˜¬ë¼ê°„ë‹¤</option>
                        <option value="7">7ì  - ê²½ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤</option>
                        <option value="10">10ì  - ì¤‘ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">í’ˆì§ˆ ê°œì„ , ë¶ˆëŸ‰ ì˜ˆë°© íš¨ê³¼</div>
                </div>

                <!-- ë¬´í˜•íš¨ê³¼ - ì•ˆì „ -->
                <div class="form-group">
                    <label class="form-label">ë¬´í˜•íš¨ê³¼ - ì•ˆì „ (0~10ì )</label>
                    <select class="form-input" id="reviewSafetyScore" onchange="calculateReviewScore()">
                        <option value="0">0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ</option>
                        <option value="5">5ì  - í˜„ì¬ì˜ ìƒíƒœë³´ë‹¤ ì•ˆì „í•œ ì‘ì—…í™˜ê²½ì„ êµ¬ì¶•í•œë‹¤</option>
                        <option value="7">7ì  - ê²½ë¯¸í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ê³µìƒ, ë„ë‚œ ë“±)</option>
                        <option value="10">10ì  - ì¤‘ëŒ€í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ì‚°ì—…ì¬í•´, í™”ì¬ ë“±)</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">ì•ˆì „ í™˜ê²½ ê°œì„ , ì‚¬ê³  ì˜ˆë°© íš¨ê³¼</div>
                </div>

                <!-- ì¢…í•© ì ìˆ˜ í‘œì‹œ -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>í‰ê°€ ì´ì :</strong>
                        <span id="reviewTotalScore" style="font-size: 24px; font-weight: 700; color: #667eea;">0ì </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <strong>ë“±ê¸‰:</strong>
                        <span id="reviewGradeDisplay" style="font-size: 20px; font-weight: 600; color: #28a745;">-</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">í‰ê°€ ì˜ê²¬</label>
                    <textarea class="form-textarea" id="reviewComment" placeholder="ì œì•ˆì„œì— ëŒ€í•œ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReviewModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="rejectSuggestion()">ë°˜ë ¤</button>
                <button class="btn btn-warning" onclick="requestRevision()">ìˆ˜ì •ìš”ì²­</button>
                <button class="btn btn-success" onclick="approveSuggestion()">ìŠ¹ì¸</button>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì œì•ˆì„œ ìƒì„¸ë³´ê¸°</h3>
                <button class="close-btn" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <!-- Toast ì•Œë¦¼ -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAv0y8cF86kDC-saDZA6K0Q5fZd6dk9H1Y",
            authDomain: "suggestion-system-58def.firebaseapp.com",
            projectId: "suggestion-system-58def",
            storageBucket: "suggestion-system-58def.firebasestorage.app",
            messagingSenderId: "755050605021",
            appId: "1:755050605021:web:befd52c5516c3a3d3e2e34"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firebase ìºì‹± í™œì„±í™” (ì½ê¸° íšŸìˆ˜ ëŒ€í­ ê°ì†Œ)
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open - caching disabled
                } else if (err.code == 'unimplemented') {
                    // Browser doesn't support caching
                }
            });

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentLeader = null;
        let currentSuggestion = null;
        let allSuggestions = [];

        // ì¸ì¦ í™•ì¸
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = user;

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    auth.signOut();
                    return;
                }

                const userData = userDoc.data();

                // roles ë°°ì—´ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜)
                if (!userData.roles || userData.roles.length === 0) {
                    const defaultRoles = ['user'];
                    if (userData.role === 'admin') defaultRoles.push('admin');
                    if (userData.isEvaluator) {
                        if (userData.leaderLevel === 1) defaultRoles.push('firstReviewer');
                        else if (userData.leaderLevel === 2) defaultRoles.push('secondReviewer');
                        else defaultRoles.push('firstReviewer'); // ê¸°ë³¸ê°’
                    }
                    try {
                        await db.collection('users').doc(user.uid).update({ roles: defaultRoles });
                        userData.roles = defaultRoles;
                    } catch (updateError) {
                        userData.roles = defaultRoles;
                    }
                }

                // employees ì»¬ë ‰ì…˜ì—ì„œ employeeId ê°€ì ¸ì˜¤ê¸°
                let employeeId = userData.employeeId; // users ì»¬ë ‰ì…˜ì— ìˆìœ¼ë©´ ì‚¬ìš©

                if (!employeeId) {
                    const employeeQuery = await db.collection('employees')
                        .where('email', '==', user.email)
                        .where('isActive', '==', true)
                        .get();

                    if (!employeeQuery.empty) {
                        employeeId = employeeQuery.docs[0].id;
                    } else {
                        console.error('Employee not found in employees collection');
                    }
                }

                // currentLeader ê°ì²´ ëª…ì‹œì  êµ¬ì„± (dashboard.htmlê³¼ ë™ì¼í•œ ë°©ì‹)
                currentLeader = {
                    uid: user.uid,
                    email: user.email,
                    displayName: userData.displayName,
                    department: userData.department,
                    employeeId: employeeId,
                    role: userData.role,
                    roles: userData.roles || ['user'],
                    isEvaluator: userData.isEvaluator,
                    leaderLevel: userData.leaderLevel
                };

                // ë¦¬ë” ê¶Œí•œ í™•ì¸ (roles ë°°ì—´ ë˜ëŠ” isEvaluator í™•ì¸)
                const hasReviewerRole = userData.roles.includes('firstReviewer') ||
                                       userData.roles.includes('secondReviewer') ||
                                       userData.isEvaluator === true;

                if (!hasReviewerRole) {
                    showToast('í‰ê°€ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    return;
                }

                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                document.getElementById('userInfo').innerHTML = `
                    <strong>${userData.displayName}</strong><br>
                    ${userData.department || ''}<br>
                    ${userData.jobTitle || 'ë¦¬ë”'}
                `;

                // ë°ì´í„° ë¡œë“œ
                loadDashboard();
                loadPendingSuggestions();
                loadReviewingSuggestions();
                loadCompletedSuggestions();
                loadStats();

            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                // ê²°ì¬ ëŒ€ê¸° ê±´ìˆ˜
                const pendingSnapshot = await db.collection('suggestions')
                    .where('currentApproverId', '==', currentLeader.employeeId)
                    .where('status', '==', 'pending')
                    .get();

                const pendingCount = pendingSnapshot.size;
                document.getElementById('statPending').textContent = pendingCount;
                document.getElementById('pendingCount').textContent = pendingCount;

                // ì´ë²ˆ ì£¼ ì²˜ë¦¬ ê±´ìˆ˜
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);

                const weekSnapshot = await db.collection('suggestions')
                    .where('level1Approval.approverId', '==', currentLeader.employeeId)
                    .where('level1Approval.approvedAt', '>=', weekAgo)
                    .get();

                document.getElementById('statWeek').textContent = weekSnapshot.size;

                // ì´ë²ˆ ë‹¬ ì²˜ë¦¬ ê±´ìˆ˜
                const monthStart = new Date();
                monthStart.setDate(1);
                monthStart.setHours(0, 0, 0, 0);

                const monthSnapshot = await db.collection('suggestions')
                    .where('level1Approval.approverId', '==', currentLeader.employeeId)
                    .where('level1Approval.approvedAt', '>=', monthStart)
                    .get();

                document.getElementById('statMonth').textContent = monthSnapshot.size;

                // ìµœê·¼ ê²°ì¬ ëŒ€ê¸° ì œì•ˆì„œ (ìµœëŒ€ 5ê°œ)
                const recentDocs = pendingSnapshot.docs.slice(0, 5);
                displayRecentPending(recentDocs);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìµœê·¼ ê²°ì¬ ëŒ€ê¸° ì œì•ˆì„œ í‘œì‹œ
        function displayRecentPending(docs) {
            const tbody = document.getElementById('recentPendingList');

            if (docs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            ê²°ì¬ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = docs.map(doc => {
                const data = doc.data();
                return `
                    <tr>
                        <td>${data.suggestionNumber}</td>
                        <td>${data.proposer}</td>
                        <td>${data.department}</td>
                        <td>${data.title}</td>
                        <td>${formatDate(data.createdAt)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm recent-review-btn" data-suggestion-id="${doc.id}">
                                í‰ê°€í•˜ê¸°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.querySelectorAll('.recent-review-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const suggestionId = this.getAttribute('data-suggestion-id');
                    openReviewModal(suggestionId);
                });
            });
        }

        // ê²°ì¬ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ
        async function loadPendingSuggestions() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('currentApproverId', '==', currentLeader.employeeId)
                    .where('status', '==', 'pending')
                    .get();

                const tbody = document.getElementById('pendingList');

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                const myPending = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });

                if (myPending.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ê²°ì¬ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = myPending.map(doc => {
                    const data = doc.data();
                    const selfScore = data.scores?.self?.total || 0;
                    const selfGrade = data.scores?.self?.grade || '-';
                    return `
                        <tr>
                            <td>${data.suggestionNumber || '-'}</td>
                            <td>${data.proposer || '-'}</td>
                            <td>${data.department || '-'}</td>
                            <td><strong>${data.title || '-'}</strong></td>
                            <td>${formatDate(data.createdAt)}</td>
                            <td>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${selfScore}</div>
                                    <div style="font-size: 11px; color: #999;">${selfGrade}</div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm review-btn" data-suggestion-id="${doc.id}">
                                    í‰ê°€í•˜ê¸°
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSuggestion('${doc.id}')" style="margin-left: 5px;">
                                    ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì´ì „ ë¦¬ìŠ¤ë„ˆëŠ” innerHTMLë¡œ ì´ë¯¸ ì œê±°ë¨)
                // DOMì´ ì—…ë°ì´íŠ¸ë  ì‹œê°„ì„ ì£¼ê¸° ìœ„í•´ setTimeout ì‚¬ìš©
                setTimeout(() => {
                    const reviewButtons = document.querySelectorAll('#pendingList .review-btn');

                    if (reviewButtons.length === 0) {
                        return;
                    }

                    reviewButtons.forEach((btn, index) => {
                        const suggestionId = btn.getAttribute('data-suggestion-id');

                        // í´ë¦­ í•¸ë“¤ëŸ¬ ì •ì˜
                        const clickHandler = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const id = this.getAttribute('data-suggestion-id');

                            if (typeof window.openReviewModal === 'function') {
                                try {
                                    window.openReviewModal(id);
                                } catch (err) {
                                    console.error('openReviewModal call error:', err);
                                }
                            } else {
                                console.error('openReviewModal function not found on window object');
                            }
                        };

                        btn.addEventListener('click', clickHandler);
                    });
                }, 100);

            } catch (error) {
                console.error('ê²°ì¬ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì œì•ˆì„œ ì‚­ì œ (ê´€ë¦¬ììš©)
        async function deleteSuggestion(suggestionId) {
            try {
                const docRef = db.collection('suggestions').doc(suggestionId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();

                if (!confirm(`"${data.title}" ì œì•ˆì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì œì•ˆì„œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    return;
                }

                // Firestoreì—ì„œ ì‚­ì œ
                await docRef.delete();

                showToast('ì œì•ˆì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadPendingSuggestions();
                await loadStats();

            } catch (error) {
                console.error('ì œì•ˆì„œ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ê²€í†  ì¤‘ ëª©ë¡ ë¡œë“œ
        async function loadReviewingSuggestions() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('approvalStatus', 'in', ['level1', 'level2'])
                    .get();

                const tbody = document.getElementById('reviewingList');

                // ë‚´ê°€ ì´ë¯¸ ìŠ¹ì¸í•œ ì œì•ˆì„œë§Œ í•„í„°ë§
                let myReviewing = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return (data.level1Approval && data.level1Approval.approverId === currentLeader.employeeId) ||
                           (data.level2Approval && data.level2Approval.approverId === currentLeader.employeeId);
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                myReviewing = myReviewing.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });

                if (myReviewing.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                ê²€í†  ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    document.getElementById('reviewingCount').textContent = '0';
                    return;
                }

                document.getElementById('reviewingCount').textContent = myReviewing.length;

                tbody.innerHTML = myReviewing.map(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentLeader.employeeId 
                        ? data.level1Approval 
                        : data.level2Approval;

                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.title}</td>
                            <td>
                                <span class="badge badge-success">ìŠ¹ì¸</span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ì ìˆ˜: ${myApproval.score}ì </div>
                            </td>
                            <td>
                                <span class="badge badge-warning">
                                    ${data.approvalStatus === 'level1' ? '2ì°¨ ê²°ì¬ ëŒ€ê¸°' : 'ìµœì¢… ê²°ì¬ ëŒ€ê¸°'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ê²€í†  ì¤‘ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì²˜ë¦¬ ì™„ë£Œ ëª©ë¡ ë¡œë“œ
        async function loadCompletedSuggestions() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('approvalStatus', 'in', ['approved', 'rejected'])
                    .get();

                const tbody = document.getElementById('completedList');

                // ë‚´ê°€ ì²˜ë¦¬í•œ ì œì•ˆì„œë§Œ í•„í„°ë§
                let myCompleted = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return (data.level1Approval && data.level1Approval.approverId === currentLeader.employeeId) ||
                           (data.level2Approval && data.level2Approval.approverId === currentLeader.employeeId) ||
                           (data.finalApproval && data.finalApproval.approverId === currentLeader.employeeId);
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ
                myCompleted = myCompleted.sort((a, b) => {
                    const timeA = a.data().updatedAt?.toDate?.() || new Date(0);
                    const timeB = b.data().updatedAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                }).slice(0, 50);

                if (myCompleted.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ì²˜ë¦¬ ì™„ë£Œëœ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = myCompleted.map(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentLeader.employeeId 
                        ? data.level1Approval 
                        : (data.level2Approval?.approverId === currentLeader.employeeId 
                            ? data.level2Approval 
                            : data.finalApproval);

                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.title}</td>
                            <td>
                                <span class="badge ${myApproval.status === 'approved' ? 'badge-success' : 'badge-danger'}">
                                    ${myApproval.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                                </span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ì ìˆ˜: ${myApproval.score}ì </div>
                            </td>
                            <td>
                                <span class="badge ${data.approvalStatus === 'approved' ? 'badge-success' : 'badge-danger'}">
                                    ${data.approvalStatus === 'approved' ? 'ìµœì¢… ìŠ¹ì¸' : 'ë°˜ë ¤'}
                                </span>
                            </td>
                            <td>${formatDate(myApproval.approvedAt)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì²˜ë¦¬ ì™„ë£Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì „ì²´ ì œì•ˆ ë¡œë“œ
        async function loadAllSuggestions() {
            try {
                // ëª¨ë“  ì‚¬ìš©ìì˜ ì œì•ˆ ì¡°íšŒ (orderBy ì œê±°í•˜ì—¬ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
                const snapshot = await db.collection('suggestions')
                    .limit(1000)
                    .get();

                const tbody = document.getElementById('allSuggestionsList');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ (ìµœì‹ ìˆœ)
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });

                tbody.innerHTML = sortedDocs.map(doc => {
                    const data = doc.data();
                    const statusText = {
                        'draft': 'ì„ì‹œì €ì¥',
                        'pending': 'ê²°ì¬ëŒ€ê¸°',
                        'reviewing': 'ê²€í† ì¤‘',
                        'approved': 'ìŠ¹ì¸',
                        'rejected': 'ë°˜ë ¤'
                    }[data.status] || data.status;

                    const statusClass = {
                        'draft': 'badge-secondary',
                        'pending': 'badge-warning',
                        'reviewing': 'badge-info',
                        'approved': 'badge-success',
                        'rejected': 'badge-danger'
                    }[data.status] || 'badge-secondary';

                    return `
                        <tr>
                            <td>${data.suggestionNumber || '-'}</td>
                            <td>${data.proposer || '-'}</td>
                            <td>${data.department || '-'}</td>
                            <td>${data.title || '-'}</td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${formatDate(data.createdAt)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì „ì²´ ì œì•ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tbody = document.getElementById('allSuggestionsList');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            ì „ì²´ ì œì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const snapshot = await db.collection('suggestions').get();

                // ë‚´ê°€ ì²˜ë¦¬í•œ ì œì•ˆì„œ í•„í„°ë§
                const myProcessed = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return (data.level1Approval && data.level1Approval.approverId === currentLeader.employeeId) ||
                           (data.level2Approval && data.level2Approval.approverId === currentLeader.employeeId) ||
                           (data.finalApproval && data.finalApproval.approverId === currentLeader.employeeId);
                });

                const total = myProcessed.length;
                const approved = myProcessed.filter(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentLeader.employeeId 
                        ? data.level1Approval 
                        : (data.level2Approval?.approverId === currentLeader.employeeId 
                            ? data.level2Approval 
                            : data.finalApproval);
                    return myApproval && myApproval.status === 'approved';
                }).length;

                const rejected = myProcessed.filter(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentLeader.employeeId 
                        ? data.level1Approval 
                        : (data.level2Approval?.approverId === currentLeader.employeeId 
                            ? data.level2Approval 
                            : data.finalApproval);
                    return myApproval && myApproval.status === 'rejected';
                }).length;

                const approvalRate = total > 0 ? Math.round((approved / total) * 100) : 0;

                document.getElementById('statsTotal').textContent = total;
                document.getElementById('statsApproved').textContent = approved;
                document.getElementById('statsRejected').textContent = rejected;
                document.getElementById('statsApprovalRate').textContent = approvalRate + '%';

            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ëª¨ë“  ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        function loadAllData() {
            loadDashboard();
            loadPendingSuggestions();
            loadReviewingSuggestions();
            loadCompletedSuggestions();
            loadStats();
        }

        // í‰ê°€ ëª¨ë‹¬ ì—´ê¸°
        async function openReviewModal(suggestionId) {
            try {
                if (!db) {
                    showToast('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const doc = await db.collection('suggestions').doc(suggestionId).get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();
                currentSuggestion = { id: suggestionId, ...data };

                // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
                try {
                    document.getElementById('modalSugNumber').textContent = data.suggestionNumber || '-';
                    document.getElementById('modalProposer').textContent = `${data.proposer || '-'} (${data.department || '-'})`;
                    document.getElementById('modalDepartment').textContent = data.department || '-';
                    document.getElementById('modalSubmitDate').textContent = formatDate(data.createdAt);
                    document.getElementById('modalTitle').textContent = data.title || '-';
                    document.getElementById('modalCurrentSituation').textContent = data.currentSituation || '-';
                    document.getElementById('modalImprovementPlan').textContent = data.improvementPlan || '-';
                    document.getElementById('modalTotalScore').textContent = data.scores?.self?.total || 0;
                    document.getElementById('modalSelfGrade').textContent = data.scores?.self?.grade || '-';

                    // ìœ í˜•íš¨ê³¼ ê²€ì¦ ì •ë³´ í‘œì‹œ
                    const verificationSection = document.getElementById('verificationInfoSection');
                    if (data.hasTypicalEffect && data.effectVerification && data.effectVerification.status === 'verified') {
                        // ê²€ì¦ì´ ì™„ë£Œëœ ê²½ìš° ê²€ì¦ ì •ë³´ í‘œì‹œ
                        verificationSection.style.display = 'block';

                        document.getElementById('modalOriginalAmount').textContent =
                            (data.effectVerification.originalAmount || 0).toLocaleString() + 'ì›/ë…„';
                        document.getElementById('modalVerifiedAmount').textContent =
                            (data.effectVerification.verifiedAmount || 0).toLocaleString() + 'ì›/ë…„';
                        document.getElementById('modalVerifierComment').textContent =
                            data.effectVerification.verifierComment || '-';
                        document.getElementById('modalVerifierName').textContent =
                            data.effectVerification.verifierName || '-';

                        const verifiedAt = data.effectVerification.verifiedAt?.toDate?.();
                        document.getElementById('modalVerifiedAt').textContent =
                            verifiedAt ? verifiedAt.toLocaleDateString('ko-KR') : '-';
                    } else {
                        // ìœ í˜•íš¨ê³¼ê°€ ì—†ê±°ë‚˜ ê²€ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš° ìˆ¨ê¹€
                        verificationSection.style.display = 'none';
                    }
                } catch (elemError) {
                    console.error('Modal element update error:', elemError);
                }

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                const reviewEffort = document.getElementById('reviewEffortScore');
                const reviewCreativity = document.getElementById('reviewCreativityScore');
                const reviewQuality = document.getElementById('reviewQualityScore');
                const reviewSafety = document.getElementById('reviewSafetyScore');
                const reviewComment = document.getElementById('reviewComment');
                const reviewTotalScore = document.getElementById('reviewTotalScore');
                const reviewGradeDisplay = document.getElementById('reviewGradeDisplay');

                if (reviewEffort) reviewEffort.value = '';
                if (reviewCreativity) reviewCreativity.value = '';
                if (reviewQuality) reviewQuality.value = '0';
                if (reviewSafety) reviewSafety.value = '0';
                if (reviewComment) reviewComment.value = '';
                if (reviewTotalScore) reviewTotalScore.textContent = '0ì ';
                if (reviewGradeDisplay) reviewGradeDisplay.textContent = '-';

                // ëª¨ë‹¬ í‘œì‹œ
                const modal = document.getElementById('reviewModal');
                if (modal) {
                    modal.classList.add('show');
                } else {
                    console.error('reviewModal element not found');
                }

            } catch (error) {
                console.error('âŒ ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // í‰ê°€ ì ìˆ˜ ê³„ì‚°
        function calculateReviewScore() {
            const effort = parseInt(document.getElementById('reviewEffortScore').value) || 0;
            const creativity = parseInt(document.getElementById('reviewCreativityScore').value) || 0;
            const quality = parseInt(document.getElementById('reviewQualityScore').value) || 0;
            const safety = parseInt(document.getElementById('reviewSafetyScore').value) || 0;

            // í’ˆì§ˆê³¼ ì•ˆì „ ì¤‘ ë” ë†’ì€ ì ìˆ˜ ì‚¬ìš© (OR ì¡°ê±´)
            const intangibleEffect = Math.max(quality, safety);

            const total = effort + creativity + intangibleEffect;

            document.getElementById('reviewTotalScore').textContent = total + 'ì ';

            // ë“±ê¸‰ ê³„ì‚°
            const grade = calculateGrade(total);
            document.getElementById('reviewGradeDisplay').textContent = grade || '-';
        }

        // ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜
        function calculateGrade(score) {
            const gradeRanges = [
                { grade: 'íŠ¹ê¸‰', min: 91, max: 100 },
                { grade: '1ê¸‰', min: 81, max: 90 },
                { grade: '2ê¸‰', min: 71, max: 80 },
                { grade: '3ê¸‰', min: 61, max: 70 },
                { grade: '4ê¸‰', min: 56, max: 60 },
                { grade: '5ê¸‰', min: 51, max: 55 },
                { grade: '6ê¸‰', min: 45, max: 50 },
                { grade: '7ê¸‰', min: 41, max: 44 },
                { grade: '8ê¸‰', min: 31, max: 40 },
                { grade: '9ê¸‰', min: 21, max: 30 },
                { grade: '10ê¸‰', min: 0, max: 20 }
            ];

            for (let range of gradeRanges) {
                if (score >= range.min && score <= range.max) {
                    return range.grade;
                }
            }
            return null;
        }

        // í‰ê°€ ëª¨ë‹¬ ë‹«ê¸°
        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('show');
            currentSuggestion = null;
        }

        // ìŠ¹ì¸ ì²˜ë¦¬
        async function approveSuggestion() {
            const effort = parseInt(document.getElementById('reviewEffortScore').value);
            const creativity = parseInt(document.getElementById('reviewCreativityScore').value);
            const quality = parseInt(document.getElementById('reviewQualityScore').value) || 0;
            const safety = parseInt(document.getElementById('reviewSafetyScore').value) || 0;
            const comment = document.getElementById('reviewComment').value;

            if (!effort || !creativity) {
                showToast('ë…¸ë ¥ë„ì™€ ì°½ì˜ì„±ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            const intangibleEffect = Math.max(quality, safety);
            const totalScore = effort + creativity + intangibleEffect;
            const grade = calculateGrade(totalScore);

            if (!confirm('ì´ ì œì•ˆì„œë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const suggestionRef = db.collection('suggestions').doc(currentSuggestion.id);
                const suggestionData = currentSuggestion;

                // Get the approval line to find the next approver
                const approvalLineDoc = await db.collection('approvalLines').doc(suggestionData.approvalLineId).get();
                if (!approvalLineDoc.exists) {
                    throw new Error('ê²°ì¬ ë¼ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                const approvalLineData = approvalLineDoc.data();
                const approvers = approvalLineData.approvers || []; // Firestoreì—ì„œ approvers ë°°ì—´ì„ ì§ì ‘ ì‚¬ìš©

                // ê²°ì¬ì„  ë¬´ê²°ì„± ê²€ì¦
                if (approvers.length === 0) {
                    throw new Error('ê²°ì¬ì„ ì— í‰ê°€ìê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                const currentStage = suggestionData.stage || 1;
                const nextApprover = approvers.find(a => a.level === currentStage + 1);

                const newHistoryEntry = {
                    approverId: currentLeader.employeeId,
                    approverName: currentLeader.displayName,
                    status: 'approved',
                    level: currentStage,
                    approvedAt: new Date(),
                    scores: {
                        effort: effort,
                        creativity: creativity,
                        quality: quality,
                        safety: safety,
                        intangibleEffect: intangibleEffect,
                        total: totalScore,
                        grade: grade
                    },
                    comment: comment
                };

                const stageKey = `stage${currentStage}`;
                const updateData = {
                    approvalHistory: firebase.firestore.FieldValue.arrayUnion(newHistoryEntry),
                    [`scores.${stageKey}`]: {
                        effort: effort,
                        creativity: creativity,
                        quality: quality,
                        safety: safety,
                        intangibleEffect: intangibleEffect,
                        total: totalScore,
                        grade: grade,
                        comment: comment,
                        evaluatorId: currentLeader.employeeId,
                        evaluatorName: currentLeader.displayName,
                        evaluatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    totalScore: totalScore,
                    grade: grade,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // ì†Œìœ„ì›íšŒ(1ë‹¨ê³„) í‰ê°€ì¸ ê²½ìš°, 60ì  ê¸°ì¤€ìœ¼ë¡œ íë¦„ ê²°ì •
                if (currentStage === 1) {
                    if (totalScore <= 60) {
                        // 60ì  ì´í•˜: í‰ê°€ ì¢…ë£Œ (ì œì•ˆìœ„ì›íšŒë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ)
                        updateData.currentApproverId = null;
                        updateData.status = 'approved';
                        showToast('ì†Œìœ„ì›íšŒ í‰ê°€ ì™„ë£Œ! (60ì  ì´í•˜ë¡œ í‰ê°€ ì¢…ë£Œ)', 'success');
                    } else if (nextApprover && nextApprover.id) {
                        // 60ì  ì´ˆê³¼: ì œì•ˆìœ„ì›íšŒë¡œ ì „ë‹¬
                        updateData.currentApproverId = nextApprover.id;
                        updateData.stage = currentStage + 1;
                        showToast('ì†Œìœ„ì›íšŒ ìŠ¹ì¸ ì™„ë£Œ! (60ì  ì´ˆê³¼ë¡œ ì œì•ˆìœ„ì›íšŒ í‰ê°€ ì§„í–‰)', 'success');
                    } else {
                        // ì œì•ˆìœ„ì›íšŒ ì„¤ì •ì´ ì—†ëŠ” ê²½ìš°ì—ë„ ì¢…ë£Œ
                        updateData.currentApproverId = null;
                        updateData.status = 'approved';
                        showToast('ì†Œìœ„ì›íšŒ í‰ê°€ ì™„ë£Œ! (ë‹¤ìŒ í‰ê°€ì ì—†ìŒ)', 'success');
                    }
                } else if (nextApprover && nextApprover.id) {
                    // ì œì•ˆìœ„ì›íšŒ(2ë‹¨ê³„) ì´ìƒ: ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                    updateData.currentApproverId = nextApprover.id;
                    updateData.stage = currentStage + 1;
                    showToast('ìŠ¹ì¸ ì™„ë£Œ! ë‹¤ìŒ ê²°ì¬ìì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    // ìµœì¢… ìŠ¹ì¸ (ë” ì´ìƒì˜ ìŠ¹ì¸ì ì—†ìŒ)
                    updateData.currentApproverId = null;
                    updateData.status = 'approved';
                    showToast('ìµœì¢… ìŠ¹ì¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }

                await suggestionRef.update(updateData);

                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: suggestionData.userId,
                    title: 'ì œì•ˆì„œ ìŠ¹ì¸',
                    message: `${currentLeader.displayName}ë‹˜ì´ ì œì•ˆì„œë¥¼ ìŠ¹ì¸í–ˆìŠµë‹ˆë‹¤.`,
                    type: 'evaluation',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeReviewModal();
                loadAllData(); // Reload all data to reflect changes

            } catch (error) {
                console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ë°˜ë ¤ ì²˜ë¦¬
        async function rejectSuggestion() {
            const comment = document.getElementById('reviewComment').value;

            if (!comment) {
                showToast('ë°˜ë ¤ ì‚¬ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ì´ ì œì•ˆì„œë¥¼ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const suggestionRef = db.collection('suggestions').doc(currentSuggestion.id);
                const suggestionData = currentSuggestion;

                const newHistoryEntry = {
                    approverId: currentLeader.employeeId,
                    approverName: currentLeader.displayName,
                    status: 'rejected',
                    level: suggestionData.stage || 1,
                    score: 0,  // ë°˜ë ¤ ì‹œ ì ìˆ˜ëŠ” 0
                    comment: comment,
                    approvedAt: new Date()
                };

                await suggestionRef.update({
                    status: 'rejected',
                    currentApproverId: null,
                    approvalHistory: firebase.firestore.FieldValue.arrayUnion(newHistoryEntry),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: suggestionData.userId,
                    title: 'ì œì•ˆì„œ ë°˜ë ¤',
                    message: `${currentLeader.displayName}ë‹˜ì´ ì œì•ˆì„œë¥¼ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${comment}`,
                    type: 'evaluation',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ì œì•ˆì„œë¥¼ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤.', 'success');
                closeReviewModal();
                loadAllData();

            } catch (error) {
                console.error('ë°˜ë ¤ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìˆ˜ì • ìš”ì²­
        async function requestRevision() {
            const comment = document.getElementById('reviewComment').value;

            if (!comment) {
                showToast('ìˆ˜ì • ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ìˆ˜ì •ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const suggestionRef = db.collection('suggestions').doc(currentSuggestion.id);
                const suggestionData = currentSuggestion;

                const newHistoryEntry = {
                    approverId: currentLeader.employeeId,
                    approverName: currentLeader.displayName,
                    status: 'revision_requested',
                    level: suggestionData.stage || 1,
                    comment: comment,
                    approvedAt: new Date()
                };

                await suggestionRef.update({
                    status: 'revision_requested',
                    currentApproverId: suggestionData.userId, // Re-assign to the original proposer
                    approvalHistory: firebase.firestore.FieldValue.arrayUnion(newHistoryEntry),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: suggestionData.userId,
                    title: 'ì œì•ˆì„œ ìˆ˜ì • ìš”ì²­',
                    message: `${currentLeader.displayName}ë‹˜ì´ ìˆ˜ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ìˆ˜ì • ì‚¬í•­: ${comment}`,
                    type: 'evaluation',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ìˆ˜ì •ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.', 'success');
                closeReviewModal();
                loadAllData();

            } catch (error) {
                console.error('ìˆ˜ì • ìš”ì²­ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì œì•ˆì„œ ìƒì„¸ë³´ê¸° (ì½ê¸° ì „ìš©)
        async function viewSuggestion(suggestionId) {
            try {
                // Firestoreì—ì„œ ì œì•ˆì„œ ì¡°íšŒ
                const doc = await db.collection('suggestions').doc(suggestionId).get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const s = { id: doc.id, ...doc.data() };

                const detailHtml = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <strong>ì œì•ˆë²ˆí˜¸:</strong> ${s.suggestionNumber || s.id.substring(0, 8)}<br>
                                <strong>ì œì•ˆì:</strong> ${s.proposer}<br>
                                <strong>ì œì•ˆë¶€ì„œ:</strong> ${s.department}<br>
                                <strong>ì ‘ìˆ˜ì¼:</strong> ${formatDate(s.createdAt)}
                            </div>
                            <div>
                                <strong>ì¹´í…Œê³ ë¦¬:</strong> ${s.category || '-'}<br>
                                <strong>ìš°ì„ ìˆœìœ„:</strong> ${s.priority || '-'}<br>
                                <strong>ì‹¤ì‹œì:</strong> ${s.implementor || '-'}<br>
                                <strong>ì‹¤ì‹œë¶€ì„œ:</strong> ${s.implementDept || '-'}
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ì œì•ˆ ë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">${s.title}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ê¸°ì¡´ì‹¤ì‹œë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.currentSituation}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ë³€ê²½(ì‹ ê·œ)ë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.improvementPlan}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ìì²´í‰ê°€</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div><strong>ë…¸ë ¥ë„:</strong> ${s.scores?.self?.effort || 0}ì </div>
                                <div><strong>ì°½ì˜ì„±:</strong> ${s.scores?.self?.creativity || 0}ì </div>
                                <div><strong>ìœ ë¬´í˜•íš¨ê³¼:</strong> ${s.scores?.self?.effect || 0}ì </div>
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
                                    <strong>ì´ì :</strong> ${s.scores?.self?.total || 0}ì 
                                    <strong style="margin-left: 20px;">ë“±ê¸‰:</strong> ${s.scores?.self?.grade || '-'}
                                </div>
                            </div>
                        </div>

                        ${s.contributors && s.contributors.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">ì°¸ì—¬ì ê¸°ì—¬ë„</h4>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ì´ë¦„</th>
                                            <th>ì—­í• </th>
                                            <th>ê¸°ì—¬ë„</th>
                                            <th>ë¶€ì„œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${s.contributors.map(c => `
                                            <tr>
                                                <td>${c.name}</td>
                                                <td>${c.role}</td>
                                                <td>${c.pct}%</td>
                                                <td>${c.department}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;

                document.getElementById('detailContent').innerHTML = detailHtml;
                document.getElementById('detailModal').classList.add('show');

            } catch (error) {
                console.error('ìƒì„¸ë³´ê¸° ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ko-KR');
        }

        function showSection(sectionId) {
            // ì œì•ˆì„œ ì‘ì„±/ë‚´ ì œì•ˆì€ ëŒ€ì‹œë³´ë“œë¡œ ë°”ë¡œ ì´ë™
            if (sectionId === 'newSuggestion') {
                window.location.href = 'dashboard.html?action=newSuggestion';
                return;
            }
            if (sectionId === 'mySuggestions') {
                window.location.href = 'dashboard.html?action=mySuggestions';
                return;
            }

            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionId).classList.add('active');

            // ë©”ë‰´ í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ
            if (sectionId === 'allSuggestions') {
                loadAllSuggestions();
            }

            // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ë‹«ê¸°
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    showToast('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        }

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (onclick ì´ë²¤íŠ¸ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        window.openReviewModal = openReviewModal;
        window.closeReviewModal = closeReviewModal;
        window.calculateReviewScore = calculateReviewScore;
        window.approveSuggestion = approveSuggestion;
        window.rejectSuggestion = rejectSuggestion;
        window.requestRevision = requestRevision;
        window.showSection = showSection;
        window.viewSuggestion = viewSuggestion;
        window.closeDetailModal = closeDetailModal;
        window.logout = logout;
    </script>
</body>
</html>
