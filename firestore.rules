rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // 보안 강화 버전 (2026-01-14)
    // ============================================================

    // 직원 정보 - 로그인 검증을 위해 읽기는 허용
    // (로그인 시 employeeId 존재 여부 확인 필요)
    match /employees/{employeeId} {
      allow read: if true;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 사용자 정보 - 본인 문서만 생성 가능하도록 강화
    match /users/{userId} {
      allow read: if request.auth != null && (
                    request.auth.uid == userId ||
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                  );
      // 생성: 인증된 사용자가 본인 문서만 생성 가능
      allow create: if request.auth != null &&
                    request.auth.uid == userId &&
                    request.resource.data.uid == request.auth.uid;
      allow update: if request.auth != null && (
                      request.auth.uid == userId ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                    );
      allow delete: if request.auth != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 결재 라인 - 인증 필수
    match /approvalLines/{lineId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 제안서 - 역할 기반 접근 제어 강화
    match /suggestions/{suggestionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isEvaluator == true ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['firstReviewer', 'secondReviewer', 'thirdReviewer', 'effectVerifier'])
      );
      allow delete: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // 알림 - 본인 알림만 읽기, 인증된 사용자만 생성
    match /notifications/{notificationId} {
      allow read: if request.auth != null &&
                  request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && (
                      request.auth.uid == resource.data.userId ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                    );
    }

    // 공지사항 - 인증 필수
    match /notices/{noticeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 카테고리 - 인증 필수
    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 평가 기준 - 인증 필수
    match /evaluationCriteria/{criteriaId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 우선순위 - 인증 필수
    match /priorities/{priorityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 시스템 설정 - 인증 필수
    match /systemSettings/{settingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // 계정 생성 요청 (조직도 업로드 시 사용)
    match /accountCreationRequests/{requestId} {
      allow read: if request.auth != null &&
                  get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow write: if request.auth != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
