# 변경 이력 (Changelog)

제안제도 시스템의 모든 주요 변경 사항을 이 파일에 기록합니다.

---

## [버전 2.1.1] - 2025-10-27

### 🐛 버그 수정

#### 📋 사용자 대시보드 (dashboard.html)

##### 수정됨
- **initializeForm 오류 수정** (라인 1868-1872)
  - **문제**: currentUser가 null인 상태에서 displayName을 읽으려고 시도하여 오류 발생
  - **오류 메시지**: `Cannot read properties of null (reading 'displayName')`
  - **해결**: initializeForm 함수 시작 시 currentUser null 체크 추가
  - **영향**: 제안서 작성 페이지 접근 시 오류 없이 정상 작동

##### 개선됨
- **자체평가 노력도/창의성 선택 옵션 간소화** (라인 856-875)
  - **변경 전**: 0점, 5점, 10점, 15점 (4개 옵션)
  - **변경 후**: 5점, 10점, 15점 (3개 옵션)
  - **이유**: 제안서를 작성하는 시점에서 노력과 창의성이 전혀 없는 경우는 없으므로 0점 옵션 제거
  - **영향**: 선택 기준 명확화

#### 👔 리더 대시보드 (leader.html)

##### 수정됨
- **결재 대기 목록 0건 표시 오류 수정** (라인 1135-1167)
  - **문제**: 리더 페이지에서 실제로 결재 대기 제안서가 있음에도 0건으로 표시됨
  - **원인**: `currentLeader` 객체에 `employeeId` 필드가 누락되어 Firestore 쿼리가 undefined로 검색됨
  - **해결**:
    1. users 컬렉션에서 `employeeId` 확인
    2. 없는 경우 employees 컬렉션에서 email로 검색하여 employeeId 획득
    3. dashboard.html과 동일한 방식으로 `currentLeader` 객체 명시적 구성
  - **영향**: 결재 대기 목록이 정상적으로 표시됨

- **자체평가 상세 내용 표시 오류 수정** (dashboard.html 라인 2442-2534)
  - **문제**: 제안서 상세보기에서 노력도/창의성 등 평가 항목이 점수만 표시되고 설명 텍스트가 표시되지 않음
  - **해결**:
    1. 평가 텍스트 변환 헬퍼 함수 4개 추가:
       - `getEffortText()`: 노력도 점수를 설명 텍스트로 변환
       - `getCreativityText()`: 창의성 점수를 설명 텍스트로 변환
       - `getQualityText()`: 품질 점수를 설명 텍스트로 변환
       - `getSafetyText()`: 안전 점수를 설명 텍스트로 변환
    2. `viewSuggestion()` 함수에서 헬퍼 함수 사용하여 전체 텍스트 표시
    3. 유무형효과를 품질/안전으로 분리 표시
  - **영향**: 제안서 상세보기에서 평가 기준을 명확히 확인 가능

### 🔧 기술적 변경 사항

#### 신규 함수
- `getEffortText()` (dashboard.html): 노력도 점수를 설명 텍스트로 변환
- `getCreativityText()` (dashboard.html): 창의성 점수를 설명 텍스트로 변환
- `getQualityText()` (dashboard.html): 품질 점수를 설명 텍스트로 변환
- `getSafetyText()` (dashboard.html): 안전 점수를 설명 텍스트로 변환

#### 수정된 함수
- `onAuthStateChanged()` (leader.html): employeeId 확인 및 currentLeader 객체 명시적 구성 로직 추가
- `viewSuggestion()` (dashboard.html): 평가 텍스트 헬퍼 함수 사용하도록 수정

### 📝 변경 파일 목록

1. `dashboard.html` - 자체평가 노력도/창의성 0점 옵션 제거, 텍스트 표시 헬퍼 함수 추가
2. `leader.html` - employeeId 확인 및 currentLeader 객체 구성 개선
3. `dist/` - 모든 수정 사항 반영하여 배포 파일 업데이트
4. `CHANGELOG.md` - 변경 이력 업데이트

### 🔄 호환성

- ✅ 기존 제안서 데이터와 완전 호환
- ✅ Firestore 스키마 변경 없음
- ✅ users 컬렉션에 employeeId가 없어도 employees 컬렉션에서 자동 조회
- ✅ 브라우저 호환성 유지

---

## [버전 2.1.0] - 2025-01-27

### 🎯 주요 개선 사항

#### 📋 사용자 대시보드 (dashboard.html)

##### ✨ 추가됨
- **리더 결재라인 선택 기능**
  - 리더 권한 사용자는 제안서 작성 시 상위 결재라인을 직접 선택할 수 있습니다
  - 일반 사용자: 자신의 부서 결재라인 자동 선택
  - 리더 사용자: 드롭다운에서 결재라인 직접 선택
  - 위치: HTML (라인 680-691), `populateApprovalLines()` (라인 1477-1497)
  - 영향: 리더의 결재라인 유연성 확보

##### 🔧 개선됨
- **실시자 디폴트 설정**
  - 제안서 작성 시 실시자 항목에 제안자 정보가 자동으로 입력됨
  - 위치: `initializeForm()` 함수 (라인 1815-1823)
  - 영향: 사용자 편의성 향상

- **유형효과 안내 멘트 명확화**
  - 변경 전: "검증담당자의 검증 완료 후 평가가 진행됩니다"
  - 변경 후: "검증 담당자의 검증금액으로 최종평가 됩니다"
  - 위치: 라인 747

- **자체평가 항목 텍스트 상세화**
  - **노력도**: 일수 기준 명시 (1일 이하, 2~3일, 4~7일, 8일 이상)
  - **창의성**: 유사 사례 기준 명시 (타 팀, 우리 팀, 타 회사, 업계 최초)
  - 위치: 노력도 (라인 784-793), 창의성 (라인 796-805)
  - 영향: 평가 기준 명확화 및 객관성 향상

##### ❌ 제거됨
- **우선순위 항목 완전 제거**
  - 제안제도에서 불필요한 항목으로 판단
  - 위치: HTML 폼 (라인 696-704), 관련 함수 제거

- **유형효과 산출근거 500자 제한 제거**
  - 유연한 입력을 위해 글자 수 제한 해제
  - 위치: 산출근거 입력 (라인 758), 검증 로직 (라인 1925)

---

#### 👔 리더 대시보드 (leader.html)

##### ✨ 추가됨
- **유형효과 검증 결과 표시 기능**
  - 유형효과 검증이 완료된 제안서의 경우 평가 모달에서 검증 정보 확인 가능
  - 표시 정보:
    * 제안자 예상 금액
    * 검증자 확정 금액 (강조 표시)
    * 검증 의견
    * 검증자 정보 (이름, 검증일)
  - 위치: 평가 모달 (라인 869-891), 표시 로직 (라인 1643-1664)
  - 조건: `hasTypicalEffect === true && effectVerification.status === 'verified'`
  - 영향: 평가자가 검증된 금액을 기준으로 평가 가능

##### 🔧 개선됨
- **자체평가 표시 간소화**
  - 변경 전: 노력도/창의성/유무형효과 개별 점수 표시
  - 변경 후: 총점과 등급만 표시
  - 위치: 평가 모달 (라인 851-867)
  - 사유: 평가자에게 필요한 핵심 정보만 제공
  - 영향: UI 간결화 및 평가 집중도 향상

- **평가항목 텍스트 상세화**
  - **노력도** (라인 876-887):
    * 30점: 8일 이상의 노력, 매우 높은 업무 난이도
    * 25점: 4~7일 정도의 노력, 높은 업무 난이도
    * 20점: 2~3일 정도의 노력
    * 15점: 1일 정도의 노력
    * 10점: 1일 이하의 노력
    * 0점: 노력 미흡
  - **창의성** (라인 890-902):
    * 15점: 업계 최초의 혁신적 아이디어
    * 12점: 타 회사에 유사 사례가 있음 (최초 도입)
    * 10점: 우리 팀에 유사 사례가 있음
    * 7점: 타 팀에 유사 사례가 있음
    * 5점: 창의성 낮음
    * 0점: 창의성 없음
  - 영향: 평가 기준의 객관성 및 일관성 확보

##### 🐛 버그 수정
- **반려 버튼 오류 수정** (라인 1828)
  - 오류: `Cannot read properties of null (reading 'value')`
  - 원인: reviewScore DOM 요소가 존재하지 않음
  - 해결: 반려 시 점수를 0으로 고정

- **승인/수정요청 버튼 오류 수정**
  - 오류: `ReferenceError: loadAllData is not defined`
  - 원인: loadAllData 함수가 정의되지 않음
  - 해결: `loadAllData()` 함수 구현 (라인 1579-1585)

---

### 🔧 기술적 변경 사항

#### 신규 함수
- `populateApprovalLines()` (dashboard.html): 결재라인 목록을 드롭다운에 채우는 함수
- `loadAllData()` (leader.html): 모든 데이터를 다시 로드하는 함수

#### 수정된 함수
- `initializeForm()` (dashboard.html): 리더 권한 체크 및 결재라인 선택 섹션 표시/숨김 로직 추가
- `handleFormSubmit()` (dashboard.html): 리더 선택 결재라인 우선 사용 로직 추가
- `openReviewModal()` (leader.html): 검증 정보 표시 로직 추가
- `rejectSuggestion()` (leader.html): reviewScore 요소 참조 제거

#### 삭제된 코드
- 우선순위 관련 모든 코드 (데이터 로드, UI 표시, 검증 등)
- 산출근거 500자 검증 로직

---

### 📝 변경 파일 목록

1. `dashboard.html` - 사용자 대시보드 개선 및 리더 결재라인 선택 기능 추가
2. `leader.html` - 리더 평가 화면 개선 및 검증 결과 표시 기능 추가
3. `CHANGELOG.md` - 변경 이력 업데이트

---

### 🔄 호환성

- ✅ 기존 제안서 데이터와 완전 호환
- ✅ Firestore 스키마 변경 없음
- ✅ effectVerification 필드가 없는 기존 제안서도 정상 처리
- ✅ 브라우저 호환성 유지

---

### 📌 참고 사항

1. **리더 결재라인 선택 기능**은 다음 권한을 가진 사용자에게만 표시됩니다:
   - `firstReviewer`
   - `secondReviewer`
   - `thirdReviewer`

2. **유형효과 검증 결과**는 다음 조건을 모두 만족할 때만 표시됩니다:
   - 제안서에 유형효과가 있음 (`hasTypicalEffect === true`)
   - 검증이 완료됨 (`effectVerification.status === 'verified'`)

3. **평가 기준 상세화**로 인해 기존 평가자들은 새로운 기준을 숙지해야 합니다.

---

## 2025-10-24

### 추가 (Added)
- **leader.html**: 제안서 작성 메뉴 추가
  - 네비게이션에 "✍️ 제안서 작성" 메뉴 항목 추가
  - dashboard.html로 이동하는 링크 제공
  - 위치: leader.html:518-525, 609-625

- **leader.html**: 내 제안 보기 메뉴 추가
  - 네비게이션에 "📝 내 제안" 메뉴 항목 추가
  - dashboard.html로 이동하는 링크 제공
  - 위치: leader.html:521-523, 627-643

### 수정 (Changed)
- **dashboard.html**: 전체 제안 메뉴 권한 확장
  - 기존: 일반 사용자는 본인 제안만 조회 가능
  - 변경: 모든 사용자가 전체 제안 조회 가능
  - 위치: dashboard.html:2523-2528
  - 관련 Firebase 보안 규칙도 업데이트 필요:
    ```javascript
    match /suggestions/{suggestionId} {
      allow read: if request.auth != null;  // 모든 인증된 사용자
    }
    ```

- **index.html**: 로그인 로직 전면 개선
  - **문제**: 기존 비밀번호 입력 시 "ajupharm을 입력하세요" 메시지 무한 반복
  - **원인**: 계정 존재 여부 확인과 비밀번호 검증 로직이 혼재
  - **해결**: 로그인 순서 재구성
    1. Firestore에서 직원 정보 확인
    2. Firebase Auth 계정 존재 여부 확인 (`fetchSignInMethodsForEmail`)
    3. 계정 존재 시 → 입력한 비밀번호로 로그인 시도
    4. 계정 없음 시 → 초기 비밀번호(ajupharm)인 경우만 계정 생성
  - 위치: index.html:407-511

- **index.html**: 자동 로그인 방지 기능 추가
  - **문제**: 페이지 새로고침/재접속 시 자동으로 이전 페이지로 리다이렉트
  - **해결**: `isLoginAttempt` 플래그 도입
    - 명시적 로그인 시도가 있을 때만 리다이렉트 실행
    - `onAuthStateChanged`에서 플래그 확인 후 조건부 리다이렉트
  - 위치: index.html:366-392, 418

### 수정된 파일 목록
1. `leader.html` - 제안서 작성/내 제안 메뉴 추가
2. `dashboard.html` - 전체 제안 권한 확장
3. `index.html` - 로그인 로직 개선 및 자동 로그인 방지
4. `dist/` - 모든 수정 사항 반영하여 배포 파일 업데이트

### Firebase 보안 규칙 업데이트 필요
```javascript
// suggestions 컬렉션의 read 규칙 수정
match /suggestions/{suggestionId} {
  allow read: if request.auth != null;  // 변경됨
  // 기존: allow read: if request.auth != null && (본인 또는 관리자/평가자만)
}
```

### 기술적 세부사항
- **로그인 개선**: `fetchSignInMethodsForEmail()` API 활용하여 계정 존재 여부를 먼저 확인
- **자동 로그인 방지**: 상태 플래그 패턴을 사용하여 의도하지 않은 리다이렉트 차단
- **전체 제안 조회**: 클라이언트 측 정렬 유지 (Firestore 복합 인덱스 불필요)

### 테스트 필요 사항
1. ✅ 기존 사용자 로그인 (변경된 비밀번호 사용)
2. ✅ 신규 사용자 첫 로그인 (ajupharm 사용)
3. ✅ 페이지 새로고침 시 자동 리다이렉트 안 됨 확인
4. ✅ 일반 사용자 대시보드에서 전체 제안 조회 가능 확인
5. ✅ 리더 페이지에서 제안서 작성/내 제안 메뉴 동작 확인

---
