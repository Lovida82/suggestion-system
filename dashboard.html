<!DOCTYPE html>
<!--
================================================================================
ì œì•ˆì œë„ ì‹œìŠ¤í…œ - ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ
================================================================================

ë³€ê²½ ì´ë ¥:
--------------------------------------------------------------------------------
ë²„ì „: 2.1.0
ë‚ ì§œ: 2025-01-27
ì‘ì„±ì: Claude AI Assistant

[ì£¼ìš” ë³€ê²½ ì‚¬í•­]

1. ì‹¤ì‹œì ë””í´íŠ¸ ì„¤ì •
   - ìœ„ì¹˜: initializeForm() í•¨ìˆ˜ (ë¼ì¸ 1815-1823)
   - ë‚´ìš©: ì œì•ˆì„œ ì‘ì„± ì‹œ ì‹¤ì‹œì í•­ëª©ì— ì œì•ˆì ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë¨
   - ì˜í–¥: ì‚¬ìš©ì í¸ì˜ì„± í–¥ìƒ

2. ìš°ì„ ìˆœìœ„ í•­ëª© ì‚­ì œ
   - ìœ„ì¹˜: HTML í¼ (ë¼ì¸ 696-704), ê´€ë ¨ í•¨ìˆ˜ ì œê±°
   - ë‚´ìš©: ìš°ì„ ìˆœìœ„ ì„ íƒ í•„ë“œ ì™„ì „ ì œê±°
   - ì‚¬ìœ : ì œì•ˆì œë„ì—ì„œ ë¶ˆí•„ìš”í•œ í•­ëª©ìœ¼ë¡œ íŒë‹¨

3. ìœ í˜•íš¨ê³¼ ì•ˆë‚´ ë©˜íŠ¸ ìˆ˜ì •
   - ìœ„ì¹˜: ìœ í˜•íš¨ê³¼ ì„¹ì…˜ (ë¼ì¸ 747)
   - ë³€ê²½ ì „: "ê²€ì¦ë‹´ë‹¹ìì˜ ê²€ì¦ ì™„ë£Œ í›„ í‰ê°€ê°€ ì§„í–‰ë©ë‹ˆë‹¤"
   - ë³€ê²½ í›„: "ê²€ì¦ ë‹´ë‹¹ìì˜ ê²€ì¦ê¸ˆì•¡ìœ¼ë¡œ ìµœì¢…í‰ê°€ ë©ë‹ˆë‹¤"

4. ìì²´í‰ê°€ í•­ëª© í…ìŠ¤íŠ¸ ìƒì„¸í™”
   - ìœ„ì¹˜: ë…¸ë ¥ë„ (ë¼ì¸ 784-793), ì°½ì˜ì„± (ë¼ì¸ 796-805)
   - ë…¸ë ¥ë„: ì¼ìˆ˜ ê¸°ì¤€ ëª…ì‹œ (1ì¼ ì´í•˜, 2-3ì¼, 4-7ì¼, 8ì¼ ì´ìƒ)
   - ì°½ì˜ì„±: ìœ ì‚¬ ì‚¬ë¡€ ê¸°ì¤€ ëª…ì‹œ (íƒ€ íŒ€, ìš°ë¦¬ íŒ€, íƒ€ íšŒì‚¬, ì—…ê³„ ìµœì´ˆ)
   - ì˜í–¥: í‰ê°€ ê¸°ì¤€ ëª…í™•í™”

5. ìœ í˜•íš¨ê³¼ ì‚°ì¶œê·¼ê±° 500ì ì œí•œ ì œê±°
   - ìœ„ì¹˜: ì‚°ì¶œê·¼ê±° ì…ë ¥ (ë¼ì¸ 758), ê²€ì¦ ë¡œì§ (ë¼ì¸ 1925)
   - ë‚´ìš©: 500ì ì´ìƒ í•„ìˆ˜ ì…ë ¥ ì œí•œ ì œê±°
   - ì˜í–¥: ìœ ì—°í•œ ì…ë ¥ ê°€ëŠ¥

6. ë¦¬ë” ê²°ì¬ë¼ì¸ ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€
   - ìœ„ì¹˜: HTML (ë¼ì¸ 680-691), populateApprovalLines() (ë¼ì¸ 1477-1497),
           initializeForm() (ë¼ì¸ 1859-1872), handleFormSubmit() (ë¼ì¸ 1910-1958)
   - ë‚´ìš©: ë¦¬ë” ê¶Œí•œ ì‚¬ìš©ìëŠ” ìƒìœ„ ê²°ì¬ë¼ì¸ ì„ íƒ ê°€ëŠ¥
   - ë™ì‘:
     * ì¼ë°˜ ì‚¬ìš©ì: ìì‹ ì˜ ë¶€ì„œ ê²°ì¬ë¼ì¸ ìë™ ì„ íƒ
     * ë¦¬ë” ì‚¬ìš©ì: ë“œë¡­ë‹¤ìš´ì—ì„œ ê²°ì¬ë¼ì¸ ì§ì ‘ ì„ íƒ
   - ì˜í–¥: ë¦¬ë”ì˜ ê²°ì¬ë¼ì¸ ìœ ì—°ì„± í™•ë³´

[ê¸°ìˆ ì  ë³€ê²½]
- ìš°ì„ ìˆœìœ„ ê´€ë ¨ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì œê±°
- populateApprovalLines() í•¨ìˆ˜ ì‹ ê·œ ì¶”ê°€
- ê²°ì¬ë¼ì¸ ì„ íƒ ë¡œì§ ê°œì„ 
- ë¦¬ë” ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€

[í˜¸í™˜ì„±]
- ê¸°ì¡´ ì œì•ˆì„œ ë°ì´í„°ì™€ í˜¸í™˜
- Firestore ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ìŒ

================================================================================
-->
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì œì•ˆì œë„ ì‹œìŠ¤í…œ - ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            line-height: 1.5;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(45, 212, 191, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
            padding: 16px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            z-index: 1100;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
        }

        .sidebar-close {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #333;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: rgba(14, 165, 233, 0.08);
            color: #0ea5e9;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }

        .main-content {
            flex: 1;
            padding: 0;
            margin-top: 70px;
        }

        .page-section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f5;
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
        }

        .form-control:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
            background: white;
        }

        .form-control:hover {
            border-color: #cbd5e1;
        }

        .form-control:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-icon {
            background: none;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            color: #667eea;
        }

        .btn-icon:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 25px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .contributor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .contributor-table th,
        .contributor-table td {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: left;
        }

        .contributor-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .contributor-row {
            background: #fff;
        }

        .auto-calc {
            background: #e8f5e8 !important;
            font-weight: 600;
            color: #2d5016;
        }

        .validation-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-stage1 {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-stage2 {
            background: #e7d4f7;
            color: #5a1a8b;
        }

        .grade-display {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 10px;
        }

        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }

            .sidebar {
                position: relative;
                left: 0;
                width: 280px;
            }

            .sidebar-overlay {
                display: none !important;
            }

            .main-content {
                margin-top: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
        <div>ì œì•ˆì œë„ ì‹œìŠ¤í…œ</div>
        <div style="width: 40px;"></div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="closeSidebar()">Ã—</button>
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h3 id="userName">ë¡œë”©ì¤‘...</h3>
                        <p id="userDept">ë¡œë”©ì¤‘...</p>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <button class="menu-item active" data-page="dashboard" onclick="showPage('dashboard')">
                    ğŸ“Š ëŒ€ì‹œë³´ë“œ
                </button>
                <button class="menu-item" data-page="create" onclick="showPage('create')">
                    âœï¸ ì œì•ˆì„œ ì‘ì„±
                </button>
                <button class="menu-item" data-page="mysuggestions" onclick="showPage('mysuggestions')">
                    ğŸ“‹ ë‚´ ì œì•ˆì„œ
                </button>
                <button class="menu-item" data-page="allsuggestions" onclick="showPage('allsuggestions')">
                    ğŸ“š ì „ì²´ ì œì•ˆ
                </button>

                <!-- ê²°ì¬ì ì „ìš© ë©”ë‰´ (ì¡°ê±´ë¶€ í‘œì‹œ) -->
                <div id="approverMenu" style="display: none;">
                    <div style="margin: 20px 15px 10px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #999; font-weight: 600; margin-bottom: 10px;">ê²°ì¬ ê´€ë¦¬</div>
                    </div>
                    <button class="menu-item" data-page="pending" onclick="showPage('pending')">
                        â° ê²°ì¬ ëŒ€ê¸° <span class="badge" id="pendingBadge" style="background: #dc3545;">0</span>
                    </button>
                    <button class="menu-item" data-page="reviewing" onclick="showPage('reviewing')">
                        ğŸ” ê²€í†  ì¤‘
                    </button>
                    <button class="menu-item" data-page="completed" onclick="showPage('completed')">
                        âœ… ì²˜ë¦¬ ì™„ë£Œ
                    </button>
                </div>

                <!-- ê²€ì¦ì ì „ìš© ë©”ë‰´ (ì¡°ê±´ë¶€ í‘œì‹œ) -->
                <div id="verifierMenu" style="display: none;">
                    <div style="margin: 20px 15px 10px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #999; font-weight: 600; margin-bottom: 10px;">ìœ í˜•íš¨ê³¼ ê²€ì¦</div>
                    </div>
                    <button class="menu-item" onclick="window.location.href='verifier.html'">
                        ğŸ”¬ ìœ í˜•íš¨ê³¼ ê²€ì¦ í˜ì´ì§€
                    </button>
                </div>

                <button class="menu-item" data-page="notifications" onclick="showPage('notifications')">
                    ğŸ”” ì•Œë¦¼
                </button>
                <button class="menu-item" onclick="logout()">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </nav>

        <main class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ -->
            <section id="dashboard" class="page-section active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ëŒ€ì‹œë³´ë“œ</h2>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="totalSuggestions">0</div>
                            <div>ì œì¶œí•œ ì œì•ˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="approvedSuggestions">0</div>
                            <div>ìŠ¹ì¸ëœ ì œì•ˆ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="pendingSuggestions">0</div>
                            <div>ê²€í†  ì¤‘</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="approvalRate">0%</div>
                            <div>ìŠ¹ì¸ìœ¨</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <div class="card">
                            <h3>ìµœê·¼ ì œì•ˆì„œ</h3>
                            <div id="recentSuggestions">ìµœê·¼ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                        
                        <div class="card">
                            <h3>ì‹œìŠ¤í…œ ê³µì§€ì‚¬í•­</h3>
                            <div id="systemNotices">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì œì•ˆì„œ ì‘ì„± -->
            <section id="create" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ì œì•ˆì„œ ì‘ì„±</h2>
                    </div>
                    
                    <form id="suggestionForm" onsubmit="handleFormSubmit(event)">
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">ì œì•ˆë²ˆí˜¸</label>
                                <input type="text" class="form-control" name="suggestionNumber" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì ‘ìˆ˜ì¼</label>
                                <input type="date" class="form-control" name="submitDate" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì œì•ˆì</label>
                                <input type="text" class="form-control" name="proposer" disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì œì•ˆë¶€ì„œ</label>
                                <input type="text" class="form-control" name="department" disabled>
                            </div>
                        </div>

                        <!-- ê²°ì¬ë¼ì¸ ì„ íƒ (ë¦¬ë” ì „ìš©) - ë¹„í™œì„±í™” -->
                        <!--
                        <div id="approvalLineSection" style="display: none; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">ê²°ì¬ë¼ì¸ ì„ íƒ *</label>
                                <select class="form-control" id="approvalLineSelect" name="approvalLineSelect">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    ë¦¬ë”ëŠ” ìƒìœ„ ê²°ì¬ë¼ì¸ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                        -->

                        <!-- ì‹¤ì‹œì ì„ íƒ -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">ì‹¤ì‹œì *</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" name="implementor" id="implementorName" placeholder="ì‹¤ì‹œìë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly>
                                    <input type="hidden" name="implementorId" id="implementorId">
                                    <button type="button" class="btn btn-icon" onclick="openImplementorModal()">ğŸ” ê²€ìƒ‰</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì‹¤ì‹œë¶€ì„œ *</label>
                                <input type="text" class="form-control" name="implementDept" id="implementDept" placeholder="ì‹¤ì‹œì ì„ íƒ ì‹œ ìë™ ì…ë ¥">
                            </div>
                        </div>

                        <!-- ì¹´í…Œê³ ë¦¬ -->
                        <div style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
                                <select class="form-control" name="category" id="categorySelect" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>

                        <!-- ì œì•ˆ ë‚´ìš© -->
                        <div class="form-group">
                            <label class="form-label">ì œì•ˆë‚´ìš© *</label>
                            <input type="text" class="form-control" name="title" required 
                                placeholder="ì œì•ˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 5ì)">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ê¸°ì¡´ì‹¤ì‹œë‚´ìš© *</label>
                            <textarea class="form-control" name="currentSituation" rows="6" required 
                                placeholder="í˜„í™© ë° ì •ë¹„ì´ë ¥ ë˜ëŠ” íŠ¹ì´ì‚¬í•­ì„ ê¸°ìˆ í•˜ì—¬ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. (ìµœì†Œ 10ì)"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ë³€ê²½(ì‹ ê·œ)ë‚´ìš© *</label>
                            <textarea class="form-control" name="improvementPlan" rows="6" required 
                                placeholder="ë³€ê²½ ë˜ëŠ” ì‹ ê·œ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ìˆ í•´ì£¼ì„¸ìš”. (ìµœì†Œ 10ì)"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">íˆ¬ìë¹„ìš©</label>
                            <input type="text" class="form-control" name="investmentCost" placeholder="ì˜ˆ: 0ì›">
                        </div>

                        <!-- ìœ í˜•íš¨ê³¼ ì…ë ¥ -->
                        <div class="form-group">
                            <label class="form-label" style="margin-bottom: 15px;">ğŸ’° ìœ í˜•íš¨ê³¼ (ê¸ˆì•¡ ì ˆê°)</label>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                                        <input type="radio" name="hasTypicalEffect" value="no" checked onchange="toggleTypicalEffect(); calculateSelfScore();">
                                        ë¬´í˜•íš¨ê³¼ë§Œ ìˆìŒ (ê¸ˆì•¡ ì ˆê° ì—†ìŒ)
                                    </label>
                                    <label style="display: block; font-weight: 600;">
                                        <input type="radio" name="hasTypicalEffect" value="yes" onchange="toggleTypicalEffect(); calculateSelfScore();">
                                        ìœ í˜•íš¨ê³¼ ìˆìŒ (ê¸ˆì•¡ ì ˆê° ë°œìƒ)
                                    </label>
                                </div>

                                <div id="typicalEffectSection" style="display: none;">
                                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                        <strong>âš ï¸ ì•ˆë‚´:</strong> ìœ í˜•íš¨ê³¼ê°€ ìˆëŠ” ì œì•ˆì€ ê²€ì¦ ë‹´ë‹¹ìì˜ ê²€ì¦ê¸ˆì•¡ìœ¼ë¡œ ìµœì¢…í‰ê°€ ë©ë‹ˆë‹¤.
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">ì˜ˆìƒ ì ˆê° ê¸ˆì•¡ (ì›/ë…„) *</label>
                                        <input type="text" class="form-control" id="expectedSaving" name="expectedSaving"
                                            placeholder="ì˜ˆ: 1,000,000" inputmode="numeric"
                                            oninput="formatSavingInput(this); calculateSelfScore();">
                                        <div id="savingAmountDisplay" style="margin-top: 5px; color: #28a745; font-weight: 600;"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">ì‚°ì¶œ ê·¼ê±° *</label>
                                        <textarea class="form-control" id="savingBasis" name="savingBasis" rows="6"
                                            placeholder="ê¸ˆì•¡ ì ˆê°ì´ ë°œìƒí•˜ëŠ” êµ¬ì²´ì ì¸ ê·¼ê±°ë¥¼ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ:&#10;- ê¸°ì¡´ ë°©ì‹: ì›” 100ê°œ ë¶ˆëŸ‰ ë°œìƒ (ê°œë‹¹ 10,000ì› ì†ì‹¤)&#10;- ê°œì„  ë°©ì‹: ì›” 10ê°œ ë¶ˆëŸ‰ìœ¼ë¡œ ê°ì†Œ&#10;- ì ˆê°ì•¡: (100-10) Ã— 10,000ì› Ã— 12ê°œì›” = 10,800,000ì›/ë…„"></textarea>
                                        <div id="basisCharCount" style="margin-top: 5px; font-size: 12px; color: #666;">0ì</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">ì¦ë¹™ ìë£Œ ì²¨ë¶€ (ì„ íƒ)</label>
                                        <input type="file" class="form-control" id="evidenceFiles" multiple
                                            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                                            onchange="handleEvidenceFiles(event)">
                                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                            ê³„ì‚° ê·¼ê±°, ì°¸ê³  ìë£Œ ë“± (ìµœëŒ€ 3ê°œ íŒŒì¼)
                                        </div>
                                        <div id="evidenceFileList" style="margin-top: 10px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ìì²´í‰ê°€ (ì„ íƒì‹) -->
                        <div class="form-group">
                            <label class="form-label" style="margin-bottom: 15px;">ìì²´ í‰ê°€ (ë‹¨ìˆ˜ ì°¸ì—¬ì ì‹œ)</label>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600;">ë…¸ë ¥ë„</label>
                                        <select class="form-control" name="effortScore" id="effortScore" onchange="calculateSelfScore()">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="5">5ì  - 8ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥</option>
                                            <option value="10">10ì  - 80ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥</option>
                                            <option value="15">15ì  - 80ì‹œê°„ ì´ìƒì˜ ë…¸ë ¥</option>
                                        </select>
                                        <div style="font-size: 11px; color: #666; margin-top: 3px;">íˆ¬ì…ëœ ë…¸ë ¥ ì‹œê°„</div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600;">ì°½ì˜ì„±</label>
                                        <select class="form-control" name="creativityScore" id="creativityScore" onchange="calculateSelfScore()">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="5">5ì  - íŒ€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤</option>
                                            <option value="10">10ì  - ë³¸ë¶€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤</option>
                                            <option value="15">15ì  - ë³¸ë¶€ì— ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ì—†ë‹¤</option>
                                        </select>
                                        <div style="font-size: 11px; color: #666; margin-top: 3px;">ì•„ì´ë””ì–´ì˜ ë…ì°½ì„±</div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600;">ë¬´í˜•íš¨ê³¼ - í’ˆì§ˆ</label>
                                        <select class="form-control" name="qualityScore" id="qualityScore" onchange="calculateSelfScore()">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="0">0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ</option>
                                            <option value="5">5ì  - í˜„ì¬ë³´ë‹¤ í’ˆì§ˆìˆ˜ì¤€ì´ ì˜¬ë¼ê°„ë‹¤</option>
                                            <option value="7">7ì  - ê²½ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤</option>
                                            <option value="10">10ì  - ì¤‘ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤</option>
                                        </select>
                                        <div style="font-size: 11px; color: #666; margin-top: 3px;">í’ˆì§ˆ ê°œì„ , ë¶ˆëŸ‰ ì˜ˆë°© íš¨ê³¼</div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 600;">ë¬´í˜•íš¨ê³¼ - ì•ˆì „</label>
                                        <select class="form-control" name="safetyScore" id="safetyScore" onchange="calculateSelfScore()">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="0">0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ</option>
                                            <option value="5">5ì  - í˜„ì¬ì˜ ìƒíƒœë³´ë‹¤ ì•ˆì „í•œ ì‘ì—…í™˜ê²½ì„ êµ¬ì¶•í•œë‹¤</option>
                                            <option value="7">7ì  - ê²½ë¯¸í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ê³µìƒ, ë„ë‚œ ë“±)</option>
                                            <option value="10">10ì  - ì¤‘ëŒ€í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ì‚°ì—…ì¬í•´, í™”ì¬ ë“±)</option>
                                        </select>
                                        <div style="font-size: 11px; color: #666; margin-top: 3px;">ì•ˆì „ í™˜ê²½ ê°œì„ , ì‚¬ê³  ì˜ˆë°© íš¨ê³¼</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 20px; padding: 15px; background: white; border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <strong>ì´ì :</strong> 
                                        <span id="totalScoreDisplay" style="font-size: 20px; font-weight: 700; color: #667eea;">0ì </span>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>ë“±ê¸‰:</strong> 
                                        <span id="gradeDisplay" class="grade-display">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ê¸°ì—¬ë„ í‰ê°€ (ë‹¤ìˆ˜ ì°¸ì—¬ì‹œ) -->
                        <div class="form-group">
                            <label class="form-label">ê¸°ì—¬ë„ í‰ê°€ (ë‹¤ìˆ˜ ì°¸ì—¬ì‹œ)</label>
                            <div style="margin-bottom: 10px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addContributor()">+ ì°¸ì—¬ì ì¶”ê°€</button>
                            </div>
                            <table class="contributor-table" id="contributorTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30%;">ì´ë¦„</th>
                                        <th style="width: 20%;">ì—­í• </th>
                                        <th style="width: 20%;">ê¸°ì—¬ë„(%)</th>
                                        <th style="width: 30%;">ë¶€ì„œ</th>
                                        <th style="width: 80px;">ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="contributorTableBody">
                                    <!-- ë™ì  ìƒì„± -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2"><strong>í•©ê³„</strong></td>
                                        <td class="auto-calc" id="contributorTotal">0%</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="validation-error" id="contributorError">
                                âš ï¸ ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                            </div>
                        </div>

                        <!-- íŠ¹ì´ì‚¬í•­ -->
                        <div class="form-group">
                            <label class="form-label">íŠ¹ì´ì‚¬í•­</label>
                            <textarea class="form-control" name="specialNotes" rows="3" 
                                placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì¶”ê°€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <!-- ì²¨ë¶€íŒŒì¼ -->
                        <div class="form-group">
                            <label class="form-label">ì²¨ë¶€íŒŒì¼</label>
                            <div style="border: 2px dashed #cbd5e0; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                                <div>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                                <div style="font-size: 14px; color: #666; margin-top: 10px;">
                                    ìµœëŒ€ 5ê°œ íŒŒì¼, ê°œë³„ 10MB ì´ë‚´
                                </div>
                            </div>
                            <input type="file" id="fileInput" multiple style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.hwp,.jpg,.jpeg,.png,.gif" onchange="handleFileSelect(event)">
                            <div id="fileList" style="margin-top: 15px;"></div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary">ì œì¶œí•˜ê¸°</button>
                            <button type="button" class="btn" onclick="saveDraft()" style="background: #ffc107; color: #000;">ì„ì‹œì €ì¥</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">ì´ˆê¸°í™”</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- ë‚´ ì œì•ˆì„œ -->
            <section id="mysuggestions" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ë‚´ ì œì•ˆì„œ</h2>
                        <button class="btn btn-sm btn-primary" onclick="showPage('create')">
                            ìƒˆ ì œì•ˆì„œ ì‘ì„±
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table" id="suggestionsTable">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œëª©</th>
                                    <th style="width: 40%;">ì§„í–‰ í˜„í™©</th>
                                    <th>ì œì¶œì¼</th>
                                    <th>ìì²´ì ìˆ˜</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="suggestionsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        ì œì¶œí•œ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ì „ì²´ ì œì•ˆ -->
            <section id="allsuggestions" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ğŸ“š ì „ì²´ ì œì•ˆì„œ</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="filterDepartment" class="form-control" style="width: 200px;" onchange="loadAllSuggestions()">
                                <option value="">ì „ì²´ ë¶€ì„œ</option>
                            </select>
                            <select id="filterStatus" class="form-control" style="width: 150px;" onchange="loadAllSuggestions()">
                                <option value="">ì „ì²´ ìƒíƒœ</option>
                                <option value="pending">ê²€í†  ì¤‘</option>
                                <option value="approved">ìŠ¹ì¸</option>
                                <option value="rejected">ë°˜ë ¤</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="loadAllSuggestions()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">ì œì•ˆë²ˆí˜¸</th>
                                    <th style="width: 100px;">ì œì•ˆì</th>
                                    <th style="width: 120px;">ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th style="width: 100px;">ì ‘ìˆ˜ì¼</th>
                                    <th style="width: 100px;">ìƒíƒœ</th>
                                    <th style="width: 80px;">ë“±ê¸‰</th>
                                    <th style="width: 100px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="allSuggestionsList">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                        ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ê²°ì¬ ëŒ€ê¸° -->
            <section id="pending" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">â° ê²°ì¬ ëŒ€ê¸°</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadPendingSuggestions()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">ì œì•ˆë²ˆí˜¸</th>
                                    <th style="width: 100px;">ì œì•ˆì</th>
                                    <th style="width: 100px;">ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th style="width: 100px;">ì ‘ìˆ˜ì¼</th>
                                    <th style="width: 80px;">ìì²´í‰ê°€</th>
                                    <th style="width: 150px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="pendingList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ê²€í†  ì¤‘ -->
            <section id="reviewing" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ğŸ“‹ ê²€í†  ì¤‘</h2>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ë‚˜ì˜ ê²°ì¬</th>
                                    <th>í˜„ì¬ ë‹¨ê³„</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="reviewingList">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ì²˜ë¦¬ ì™„ë£Œ -->
            <section id="completed" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">âœ… ì²˜ë¦¬ ì™„ë£Œ</h2>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ë‚˜ì˜ í‰ê°€</th>
                                    <th>ìµœì¢… ìƒíƒœ</th>
                                    <th>ì²˜ë¦¬ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="completedList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ì•Œë¦¼ -->
            <section id="notifications" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">ì•Œë¦¼</h2>
                    </div>
                    <div id="notificationsList">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ì‹¤ì‹œì ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="implementorModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="margin: 0;">ì‹¤ì‹œì ê²€ìƒ‰</h3>
                <button class="close-btn" onclick="closeImplementorModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="search-box">
                    <input type="text" class="search-input" id="implementorSearch" placeholder="ì´ë¦„ ë˜ëŠ” ë¶€ì„œë¡œ ê²€ìƒ‰..." oninput="searchImplementors()">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <div class="user-list" id="implementorList">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì œì•ˆì„œ ìƒì„¸ë³´ê¸°</h3>
                <button class="close-btn" onclick="closeModal('detailModal')">Ã—</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAv0y8cF86kDC-saDZA6K0Q5fZd6dk9H1Y",
            authDomain: "suggestion-system-58def.firebaseapp.com",
            projectId: "suggestion-system-58def",
            storageBucket: "suggestion-system-58def.firebasestorage.app",
            messagingSenderId: "755050605021",
            appId: "1:755050605021:web:befd52c5516c3a3d3e2e34"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase ìºì‹± í™œì„±í™” (ì½ê¸° íšŸìˆ˜ ëŒ€í­ ê°ì†Œ)
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open - caching disabled
                } else if (err.code == 'unimplemented') {
                    // Browser doesn't support caching
                }
            });

        let currentUser = null;
        let suggestions = [];
        let uploadedFiles = [];
        let employees = [];
        let categories = [];
        let priorities = [];
        let evaluationCriteria = null;
        let systemSettings = null;
        let contributors = [];
        let approvalLinesMap = {}; // ê²°ì¬ ë¼ì¸ ë°ì´í„° ìºì‹œ
        let evidenceFiles = []; // ìœ í˜•íš¨ê³¼ ì¦ë¹™ íŒŒì¼
        let editingData = null; // í¸ì§‘ ì¤‘ì¸ ì œì•ˆì„œ ë°ì´í„°
        let editingSuggestionId = null; // í¸ì§‘ ì¤‘ì¸ ì œì•ˆì„œ ID

        // ì¸ì¦ ì²´í¬
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (!userDoc.exists) {
                    throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const userData = userDoc.data();

                // roles ë°°ì—´ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜)
                if (!userData.roles || userData.roles.length === 0) {
                    const defaultRoles = ['user'];
                    if (userData.role === 'admin') defaultRoles.push('admin');
                    if (userData.isEvaluator) {
                        if (userData.leaderLevel === 1) defaultRoles.push('firstReviewer');
                        else if (userData.leaderLevel === 2) defaultRoles.push('secondReviewer');
                        else if (userData.leaderLevel === 3) defaultRoles.push('thirdReviewer');
                        else defaultRoles.push('firstReviewer'); // ê¸°ë³¸ê°’
                    }

                    // roles ë°°ì—´ ì—…ë°ì´íŠ¸
                    try {
                        await db.collection('users').doc(user.uid).update({
                            roles: defaultRoles
                        });
                        userData.roles = defaultRoles;
                    } catch (updateError) {
                        console.error('âŒ roles ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', updateError);
                        userData.roles = defaultRoles; // ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ë©”ëª¨ë¦¬ì—ëŠ” ì €ì¥
                    }
                }

                // ê´€ë¦¬ìëŠ” ê´€ë¦¬ì í˜ì´ì§€ë¡œ (roles ë°°ì—´ í™•ì¸)
                if (userData.roles && (userData.roles.includes('admin') || userData.role === 'admin')) {
                    window.location.href = 'admin.html';
                    return;
                }

                // ëª¨ë“  ì‚¬ìš©ì dashboard ë¡œë“œ (ê¶Œí•œì— ë”°ë¼ ë©”ë‰´ë§Œ ë‹¤ë¥´ê²Œ í‘œì‹œ)
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: userData.displayName,
                    department: userData.department,
                    employeeId: userData.employeeId,
                    role: userData.role,
                    roles: userData.roles || ['user']
                };

                updateUserInfo();
                showMenuByRole(); // ê¶Œí•œë³„ ë©”ë‰´ í‘œì‹œ
                await loadMasterData();
                loadInitialData();
                initializeForm();

                // URL íŒŒë¼ë¯¸í„°ë¡œ íŠ¹ì • ì„¹ì…˜ ìë™ ì—´ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const action = urlParams.get('action');
                if (action === 'newSuggestion') {
                    showSection('newSuggestion');
                } else if (action === 'mySuggestions') {
                    showSection('mySuggestions');
                }
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                setTimeout(() => {
                    auth.signOut();
                    window.location.href = 'index.html';
                }, 2000);
            }
        });

        function updateUserInfo() {
            try {
                const userNameEl = document.getElementById('userName');
                const userDeptEl = document.getElementById('userDept');
                const userAvatarEl = document.getElementById('userAvatar');

                if (!userNameEl || !userDeptEl || !userAvatarEl) {
                    console.error('âŒ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', {
                        userName: !!userNameEl,
                        userDept: !!userDeptEl,
                        userAvatar: !!userAvatarEl
                    });
                    throw new Error('í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                userNameEl.textContent = currentUser.displayName || 'ì‚¬ìš©ì';
                userDeptEl.textContent = currentUser.department || 'ì¼ë°˜ë¶€';
                userAvatarEl.textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            } catch (error) {
                console.error('âŒ updateUserInfo ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ê¶Œí•œë³„ ë©”ë‰´ í‘œì‹œ
        function showMenuByRole() {
            if (!currentUser || !currentUser.roles) return;

            const roles = currentUser.roles;

            // ê²°ì¬ì ë©”ë‰´ í‘œì‹œ (1ì°¨, 2ì°¨, 3ì°¨ í‰ê°€ì)
            const isApprover = roles.includes('firstReviewer') ||
                              roles.includes('secondReviewer') ||
                              roles.includes('thirdReviewer');

            if (isApprover) {
                const approverMenu = document.getElementById('approverMenu');
                if (approverMenu) {
                    approverMenu.style.display = 'block';
                }
            }

            // ê²€ì¦ì ë©”ë‰´ í‘œì‹œ
            const isVerifier = roles.includes('effectVerifier');
            if (isVerifier) {
                const verifierMenu = document.getElementById('verifierMenu');
                if (verifierMenu) {
                    verifierMenu.style.display = 'block';
                }
            }
        }

        // ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ
        async function loadMasterData() {
            try {
                // ì¡°ì§ë„
                try {
                    const empSnapshot = await db.collection('employees').where('isActive', '==', true).get();
                    employees = [];
                    empSnapshot.forEach(doc => {
                        employees.push({ id: doc.id, ...doc.data() });
                    });
                } catch (err) {
                    console.error('âŒ ì¡°ì§ë„ ë¡œë“œ ì‹¤íŒ¨:', err);
                }

                // ì¹´í…Œê³ ë¦¬
                try {
                    const catSnapshot = await db.collection('categories').where('active', '==', true).get();
                    categories = [];
                    catSnapshot.forEach(doc => {
                        categories.push({ id: doc.id, ...doc.data() });
                    });
                    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                    categories.sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
                } catch (err) {
                    categories = [];
                }

                // ìš°ì„ ìˆœìœ„ - ì œê±°ë¨ (ë¶ˆí•„ìš”í•œ í•­ëª©)

                // í‰ê°€ ê¸°ì¤€
                try {
                    const criteriaDoc = await db.collection('evaluationCriteria').doc('self').get();
                    if (criteriaDoc.exists) {
                        evaluationCriteria = criteriaDoc.data();
                    } else {
                        evaluationCriteria = getDefaultEvaluationCriteria();
                    }
                } catch (err) {
                    evaluationCriteria = getDefaultEvaluationCriteria();
                }

                // ì‹œìŠ¤í…œ ì„¤ì •
                try {
                    const settingsDoc = await db.collection('systemSettings').doc('general').get();
                    if (settingsDoc.exists) {
                        systemSettings = settingsDoc.data();
                    } else {
                        systemSettings = getDefaultSystemSettings();
                    }
                } catch (err) {
                    systemSettings = getDefaultSystemSettings();
                }

                // ê²°ì¬ ë¼ì¸
                try {
                    const alSnapshot = await db.collection('approvalLines').get();
                    alSnapshot.forEach(doc => {
                        approvalLinesMap[doc.id] = doc.data();
                    });
                } catch (err) {
                    // Approval lines not available
                }

                // UI ì—…ë°ì´íŠ¸
                populateCategories();
                // populatePriorities(); - ìš°ì„ ìˆœìœ„ ì œê±°ë¨
                // populateApprovalLines(); // ê²°ì¬ë¼ì¸ ëª©ë¡ ë¡œë“œ - ë¹„í™œì„±í™”
                populateEvaluationOptions();

            } catch (error) {
                console.error('âŒ ë§ˆìŠ¤í„° ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('ì—ëŸ¬ ìƒì„¸:', error.message, error.code);
                showToast('ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        function getDefaultEvaluationCriteria() {
            return {
                items: [
                    {
                        key: 'effort',
                        label: 'ë…¸ë ¥ë„',
                        options: [
                            { label: '8ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥', value: 5 },
                            { label: '80ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥', value: 10 },
                            { label: '80ì‹œê°„ ì´ìƒì˜ ë…¸ë ¥', value: 15 }
                        ]
                    },
                    {
                        key: 'creativity',
                        label: 'ì°½ì˜ì„±',
                        options: [
                            { label: 'íŒ€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤', value: 5 },
                            { label: 'ë³¸ë¶€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤', value: 10 },
                            { label: 'ë³¸ë¶€ì— ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ì—†ë‹¤', value: 15 }
                        ]
                    },
                    { 
                        key: 'effect', 
                        label: 'ìœ ë¬´í˜•íš¨ê³¼', 
                        options: [
                            { label: 'ì—†ìŒ', value: 0 },
                            { label: 'ë‚®ìŒ', value: 20 },
                            { label: 'ë³´í†µ', value: 40 },
                            { label: 'ë†’ìŒ', value: 60 },
                            { label: 'ë§¤ìš° ë†’ìŒ', value: 80 }
                        ]
                    }
                ]
            };
        }

        function getDefaultSystemSettings() {
            return {
                gradeCount: 11,
                maxScore: 100,
                gradeRanges: [
                    { grade: 'íŠ¹ê¸‰', min: 91, max: 100, reward: 1000000 },
                    { grade: '1ê¸‰', min: 81, max: 90, reward: 800000 },
                    { grade: '2ê¸‰', min: 71, max: 80, reward: 600000 },
                    { grade: '3ê¸‰', min: 61, max: 70, reward: 400000 },
                    { grade: '4ê¸‰', min: 56, max: 60, reward: 300000 },
                    { grade: '5ê¸‰', min: 51, max: 55, reward: 200000 },
                    { grade: '6ê¸‰', min: 45, max: 50, reward: 100000 },
                    { grade: '7ê¸‰', min: 41, max: 44, reward: 70000 },
                    { grade: '8ê¸‰', min: 31, max: 40, reward: 50000 },
                    { grade: '9ê¸‰', min: 21, max: 30, reward: 30000 },
                    { grade: '10ê¸‰', min: 0, max: 20, reward: 20000 }
                ]
            };
        }

        function populateCategories() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }

        // ê²°ì¬ë¼ì¸ ëª©ë¡ ì±„ìš°ê¸°
        function populateApprovalLines() {
            const select = document.getElementById('approvalLineSelect');
            if (!select) return;

            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            // approvalLinesMapì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ë¶€ì„œëª…ìœ¼ë¡œ ì •ë ¬
            const lines = Object.entries(approvalLinesMap).map(([id, data]) => ({
                id: id,
                department: data.department || 'ë¯¸ì§€ì •',
                ...data
            })).sort((a, b) => a.department.localeCompare(b.department));

            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line.id;
                option.textContent = `${line.department} ê²°ì¬ë¼ì¸`;
                select.appendChild(option);
            });
        }

        // populatePriorities() - ì œê±°ë¨ (ìš°ì„ ìˆœìœ„ í•­ëª© ì‚­ì œ)

        function populateEvaluationOptions() {
            if (!evaluationCriteria) return;

            evaluationCriteria.items.forEach(item => {
                const select = document.getElementById(item.key + 'Score');
                if (!select) return;

                select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                item.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = `${opt.label} (${opt.value}ì )`;
                    select.appendChild(option);
                });
            });
        }

        // ìœ í˜•íš¨ê³¼ ê¸ˆì•¡ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° (ì œì•ˆì‹¬ì‚¬í‘œ ê¸°ì¤€)
        function calculateTangibleEffectScore(amount) {
            if (!amount || amount <= 0) return 0;

            // ê¸ˆì•¡ ê¸°ì¤€í‘œ (ì›/ë…„) - ì œì•ˆì‹¬ì‚¬í‘œ ê¸°ì¤€
            const ranges = [
                { min: 50000000, score: 60 },   // 5,000ë§Œì› ì´ìƒ (ë³„ë„í¬ìƒì—¬ë¶€ ê²€í† )
                { min: 40000000, score: 50 },   // 4,000~5,000ë§Œì›/ë…„
                { min: 30000000, score: 45 },   // 3,000~4,000ë§Œì›/ë…„
                { min: 20000000, score: 40 },   // 2,000~3,000ë§Œì›/ë…„
                { min: 10000000, score: 35 },   // 1,000~2,000ë§Œì›/ë…„
                { min: 5000000, score: 30 },    // 500~1,000ë§Œì›/ë…„
                { min: 1000000, score: 25 },    // 100~500ë§Œì›/ë…„
                { min: 500000, score: 20 },     // 50~100ë§Œì›/ë…„
                { min: 0, score: 15 }           // 50ë§Œì›/ë…„ ì´í•˜
            ];

            for (let range of ranges) {
                if (amount >= range.min) {
                    return range.score;
                }
            }
            return 0;
        }

        // ìì²´í‰ê°€ ì ìˆ˜ ê³„ì‚°
        function calculateSelfScore() {
            try {
                const effortEl = document.getElementById('effortScore');
                const creativityEl = document.getElementById('creativityScore');
                const qualityEl = document.getElementById('qualityScore');
                const safetyEl = document.getElementById('safetyScore');

                const effort = effortEl ? (parseInt(effortEl.value) || 0) : 0;
                const creativity = creativityEl ? (parseInt(creativityEl.value) || 0) : 0;
                const quality = qualityEl ? (parseInt(qualityEl.value) || 0) : 0;
                const safety = safetyEl ? (parseInt(safetyEl.value) || 0) : 0;

                // ìœ í˜•íš¨ê³¼ ì—¬ë¶€ í™•ì¸
                const hasTypicalEffect = document.querySelector('input[name="hasTypicalEffect"]:checked')?.value === 'yes';

                let effectScore = 0;
                if (hasTypicalEffect) {
                    // ìœ í˜•íš¨ê³¼ê°€ ìˆëŠ” ê²½ìš°: ê¸ˆì•¡ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚°
                    const expectedSaving = parseInt(document.getElementById('expectedSaving')?.value?.replace(/[^\d]/g, '')) || 0;
                    effectScore = calculateTangibleEffectScore(expectedSaving);
                } else {
                    // ë¬´í˜•íš¨ê³¼ë§Œ ìˆëŠ” ê²½ìš°: í’ˆì§ˆê³¼ ì•ˆì „ ì¤‘ ë” ë†’ì€ ì ìˆ˜ ì‚¬ìš©
                    effectScore = Math.max(quality, safety);
                }

                const total = effort + creativity + effectScore;

                const totalScoreDisplay = document.getElementById('totalScoreDisplay');
                if (totalScoreDisplay) {
                    totalScoreDisplay.textContent = total + 'ì ';
                }

                // ë“±ê¸‰ ê³„ì‚°
                const grade = calculateGrade(total);
                const gradeDisplay = document.getElementById('gradeDisplay');
                if (gradeDisplay) {
                    gradeDisplay.textContent = grade || '-';
                }
            } catch (error) {
                console.error('âŒ calculateSelfScore ì˜¤ë¥˜:', error);
            }
        }

        function calculateGrade(score) {
            if (!systemSettings || !systemSettings.gradeRanges) return null;
            
            for (let range of systemSettings.gradeRanges) {
                if (score >= range.min && score <= range.max) {
                    return range.grade;
                }
            }
            return null;
        }

        // ì‹¤ì‹œì ê²€ìƒ‰ ëª¨ë‹¬
        function openImplementorModal() {
            document.getElementById('implementorModal').classList.add('show');
            document.getElementById('implementorSearch').value = '';
            document.getElementById('implementorSearch').focus();
            searchImplementors();
        }

        function closeImplementorModal() {
            document.getElementById('implementorModal').classList.remove('show');
        }

        function searchImplementors() {
            const searchTerm = document.getElementById('implementorSearch').value.toLowerCase();
            const listContainer = document.getElementById('implementorList');

            if (searchTerm.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
                return;
            }

            const filtered = employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                (emp.department && emp.department.toLowerCase().includes(searchTerm))
            );

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            listContainer.innerHTML = filtered.map(emp => `
                <div class="user-item" onclick="selectImplementor('${emp.employeeId}', '${emp.name}', '${emp.department || ''}')">
                    <div style="font-weight: 600;">${emp.name}</div>
                    <div style="font-size: 14px; color: #666;">${emp.department || '-'} | ${emp.jobTitle || '-'}</div>
                </div>
            `).join('');
        }

        function selectImplementor(id, name, dept) {
            const implementorId = document.getElementById('implementorId');
            const implementorName = document.getElementById('implementorName');
            const implementDept = document.getElementById('implementDept');

            if (implementorId) implementorId.value = id;
            if (implementorName) implementorName.value = name;
            if (implementDept) implementDept.value = dept;

            closeImplementorModal();
            showToast('ì‹¤ì‹œìê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ê¸°ì—¬ë„ ê´€ë¦¬
        function addContributor() {
            contributors.push({
                name: '',
                role: 'ë¶€ì œì•ˆì',
                pct: 0,
                department: ''
            });
            renderContributorTable();
        }

        function removeContributor(index) {
            contributors.splice(index, 1);
            renderContributorTable();
        }

        function renderContributorTable() {
            const tbody = document.getElementById('contributorTableBody');
            if (!tbody) {
                return;
            }

            if (contributors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">ì°¸ì—¬ìë¥¼ ì¶”ê°€í•˜ì„¸ìš”</td></tr>';
                updateContributorTotal();
                return;
            }

            tbody.innerHTML = contributors.map((c, idx) => `
                <tr class="contributor-row">
                    <td><input type="text" class="form-control" value="${c.name}" onchange="updateContributor(${idx}, 'name', this.value)"></td>
                    <td>
                        <select class="form-control" onchange="updateContributor(${idx}, 'role', this.value)">
                            <option value="ì£¼ì œì•ˆì" ${c.role === 'ì£¼ì œì•ˆì' ? 'selected' : ''}>ì£¼ì œì•ˆì</option>
                            <option value="ë¶€ì œì•ˆì" ${c.role === 'ë¶€ì œì•ˆì' ? 'selected' : ''}>ë¶€ì œì•ˆì</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-control" value="${c.pct}" min="0" max="100" onchange="updateContributor(${idx}, 'pct', this.value)"></td>
                    <td><input type="text" class="form-control" value="${c.department}" onchange="updateContributor(${idx}, 'department', this.value)"></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeContributor(${idx})">ì‚­ì œ</button></td>
                </tr>
            `).join('');

            updateContributorTotal();
        }

        function updateContributor(index, field, value) {
            contributors[index][field] = field === 'pct' ? parseFloat(value) || 0 : value;
            updateContributorTotal();
        }

        function updateContributorTotal() {
            const total = contributors.reduce((sum, c) => sum + (parseFloat(c.pct) || 0), 0);

            const contributorTotal = document.getElementById('contributorTotal');
            if (contributorTotal) {
                contributorTotal.textContent = total.toFixed(0) + '%';
            }

            const errorDiv = document.getElementById('contributorError');
            if (errorDiv) {
                if (contributors.length > 0 && total !== 100) {
                    errorDiv.classList.add('show');
                } else {
                    errorDiv.classList.remove('show');
                }
            }
        }

        // ë°ì´í„° ë¡œë“œ
        function loadInitialData() {
            try {
                // ì´ì „ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ í•´ì œ
                if (window.suggestionsUnsubscribe) {
                    window.suggestionsUnsubscribe();
                }
                if (window.notificationsUnsubscribe) {
                    window.notificationsUnsubscribe();
                }

                window.suggestionsUnsubscribe = db.collection('suggestions')
                    .where('userId', '==', currentUser.uid)
                    .onSnapshot((snapshot) => {
                        suggestions = [];
                        snapshot.forEach((doc) => {
                            suggestions.push({ id: doc.id, ...doc.data() });
                        });
                        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                        suggestions.sort((a, b) => {
                            const timeA = a.createdAt?.toDate?.() || new Date(0);
                            const timeB = b.createdAt?.toDate?.() || new Date(0);
                            return timeB - timeA; // ìµœì‹ ìˆœ
                        });
                        updateDashboard();
                        updateSuggestionsList();
                    }, (error) => {
                        console.error('âŒ suggestions ë¡œë“œ ì˜¤ë¥˜:', error);
                    });

                window.notificationsUnsubscribe = db.collection('notifications')
                    .where('userId', '==', currentUser.uid)
                    .onSnapshot((snapshot) => {
                        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ
                        const notifs = [];
                        snapshot.forEach((doc) => {
                            notifs.push({ id: doc.id, ...doc.data() });
                        });
                        notifs.sort((a, b) => {
                            const timeA = a.createdAt?.toDate?.() || new Date(0);
                            const timeB = b.createdAt?.toDate?.() || new Date(0);
                            return timeB - timeA; // ìµœì‹ ìˆœ
                        });
                        const limited = notifs.slice(0, 20);
                        updateNotificationsList(limited);
                    }, (error) => {
                        console.error('notifications load error:', error);
                    });
            } catch (error) {
                console.error('âŒ loadInitialData ì˜¤ë¥˜:', error);
                throw error;
            }

            loadNotices();
        }

        async function loadNotices() {
            try {
                const noticesSnapshot = await db.collection('notices').get();

                const notices = [];
                noticesSnapshot.forEach((doc) => {
                    notices.push({ id: doc.id, ...doc.data() });
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ
                notices.sort((a, b) => {
                    const timeA = a.createdAt?.toDate?.() || new Date(0);
                    const timeB = b.createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });
                const limited = notices.slice(0, 5);

                updateSystemNotices(limited);
            } catch (error) {
                console.error('âŒ ê³µì§€ì‚¬í•­ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function initializeForm() {
            try {
                // currentUserê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                if (!currentUser) {
                    return;
                }

                const form = document.getElementById('suggestionForm');
                if (!form) {
                    return;
                }

                const today = new Date().toISOString().split('T')[0];

                // Null ì²´í¬ í›„ ê°’ ì„¤ì •
                if (form.suggestionNumber) form.suggestionNumber.value = generateSuggestionNumber();
                if (form.submitDate) form.submitDate.value = today;
                if (form.proposer) form.proposer.value = currentUser.displayName;
                if (form.department) form.department.value = currentUser.department;

                // ì´ˆê¸°í™” - ê° ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (form.title) form.title.value = '';

                // ì‹¤ì‹œì ë””í´íŠ¸ë¡œ ì œì•ˆì ì„¤ì •
                const implementorId = document.getElementById('implementorId');
                if (implementorId) implementorId.value = currentUser.employeeId || '';

                const implementorName = document.getElementById('implementorName');
                if (implementorName) implementorName.value = currentUser.displayName || '';

                const implementDept = document.getElementById('implementDept');
                if (implementDept) implementDept.value = currentUser.department || '';

                if (form.currentSituation) form.currentSituation.value = '';
                if (form.improvementPlan) form.improvementPlan.value = '';
                if (form.investmentCost) form.investmentCost.value = '';
                if (form.specialNotes) form.specialNotes.value = '';

                const effortScore = document.getElementById('effortScore');
                if (effortScore) effortScore.value = '';

                const creativityScore = document.getElementById('creativityScore');
                if (creativityScore) creativityScore.value = '';

                const effectScore = document.getElementById('effectScore');
                if (effectScore) effectScore.value = '';

                calculateSelfScore();

                contributors = [];
                renderContributorTable();

                uploadedFiles = [];
                updateFileList();

                // ë¦¬ë” ê¶Œí•œì´ ìˆìœ¼ë©´ ê²°ì¬ë¼ì¸ ì„ íƒ ì„¹ì…˜ í‘œì‹œ - ë¹„í™œì„±í™”
                /*
                const approvalLineSection = document.getElementById('approvalLineSection');
                const isLeader = currentUser.roles && (
                    currentUser.roles.includes('firstReviewer') ||
                    currentUser.roles.includes('secondReviewer') ||
                    currentUser.roles.includes('thirdReviewer')
                );

                if (approvalLineSection && isLeader) {
                    approvalLineSection.style.display = 'block';
                    console.log('âœ… ë¦¬ë” ê¶Œí•œ í™•ì¸ - ê²°ì¬ë¼ì¸ ì„ íƒ í™œì„±í™”');
                } else if (approvalLineSection) {
                    approvalLineSection.style.display = 'none';
                }
                */

                // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš° ë°ì´í„° ë¡œë“œ
                if (editingData) {
                    loadEditingData();
                }

            } catch (error) {
                console.error('âŒ initializeForm ì˜¤ë¥˜:', error);
                // í¼ ì´ˆê¸°í™” ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ì—ëŸ¬ë¥¼ throwí•˜ì§€ ì•ŠìŒ
            }
        }

        // í¸ì§‘ ëª¨ë“œ ë°ì´í„° ë¡œë“œ
        function loadEditingData() {
            if (!editingData) return;

            try {
                const form = document.getElementById('suggestionForm');
                if (!form) return;

                // ê¸°ë³¸ ì •ë³´ ë¡œë“œ
                if (form.title) form.title.value = editingData.title || '';
                if (form.category) form.category.value = editingData.category || '';
                if (form.currentSituation) form.currentSituation.value = editingData.currentSituation || '';
                if (form.improvementPlan) form.improvementPlan.value = editingData.improvementPlan || '';
                if (form.effect) form.effect.value = editingData.effect || '';
                if (form.implementer) form.implementer.value = editingData.implementer || '';

                // ìì²´í‰ê°€
                if (editingData.effort) {
                    const effortRadio = document.querySelector(`input[name="effort"][value="${editingData.effort}"]`);
                    if (effortRadio) effortRadio.checked = true;
                }
                if (editingData.creativity) {
                    const creativityRadio = document.querySelector(`input[name="creativity"][value="${editingData.creativity}"]`);
                    if (creativityRadio) creativityRadio.checked = true;
                }

                // ìœ í˜•íš¨ê³¼
                if (editingData.hasTypicalEffect) {
                    const yesRadio = document.querySelector('input[name="hasTypicalEffect"][value="yes"]');
                    if (yesRadio) {
                        yesRadio.checked = true;
                        // ìœ í˜•íš¨ê³¼ ì„¹ì…˜ í‘œì‹œ
                        const typicalEffectSection = document.getElementById('typicalEffectSection');
                        if (typicalEffectSection) typicalEffectSection.style.display = 'block';
                    }

                    const expectedSaving = document.getElementById('expectedSaving');
                    if (expectedSaving) {
                        const amount = editingData.expectedSaving || 0;
                        expectedSaving.value = amount ? parseInt(amount).toLocaleString('ko-KR') : '';
                    }

                    const savingBasis = document.getElementById('savingBasis');
                    if (savingBasis) savingBasis.value = editingData.savingBasis || '';
                }

                // ê¸°ì—¬ì
                contributors = editingData.contributors || [];
                renderContributorTable();

                // ì²¨ë¶€íŒŒì¼
                if (editingData.attachments && editingData.attachments.length > 0) {
                    window.existingAttachments = editingData.attachments;
                }

                // ì œì¶œ ë²„íŠ¼ì„ ìˆ˜ì • ì™„ë£Œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                const submitBtn = document.querySelector('#suggestionForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        await updateSuggestion(editingSuggestionId);
                    };
                }

                showToast('ì œì•ˆì„œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
            } catch (error) {
                console.error('í¸ì§‘ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function generateSuggestionNumber() {
            const year = new Date().getFullYear();
            const timestamp = Date.now().toString().slice(-6);
            return `SUG${year}${timestamp}`;
        }

        // í¼ ì œì¶œ
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!validateForm(formData)) {
                return;
            }
            
            // ê¸°ì—¬ë„ ê²€ì¦
            if (contributors.length > 0) {
                const total = contributors.reduce((sum, c) => sum + (parseFloat(c.pct) || 0), 0);
                if (total !== 100) {
                    showToast('ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
            }
            
            try {
                showToast('ì œì•ˆì„œ ì €ì¥ ì¤‘...', 'info');

                // --- ê²°ì¬ ë¼ì¸ ì„ íƒ ë¡œì§ ---
                let activeLineDoc = null;
                let approvalLineId = null;

                // ë¦¬ë”ê°€ ê²°ì¬ë¼ì¸ì„ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸
                const selectedApprovalLineId = document.getElementById('approvalLineSelect')?.value;

                if (selectedApprovalLineId) {
                    // ë¦¬ë”ê°€ ê²°ì¬ë¼ì¸ì„ ì„ íƒí•œ ê²½ìš°
                    const selectedLineDoc = await db.collection('approvalLines').doc(selectedApprovalLineId).get();

                    if (selectedLineDoc.exists) {
                        activeLineDoc = selectedLineDoc;
                        approvalLineId = selectedApprovalLineId;
                    } else {
                        showToast('ì„ íƒí•œ ê²°ì¬ ë¼ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                } else {
                    // ì¼ë°˜ ì‚¬ìš©ì: ìì‹ ì˜ ë¶€ì„œ ê²°ì¬ë¼ì¸ ì‚¬ìš©
                    const approvalLineQuery = await db.collection('approvalLines')
                        .where('department', '==', currentUser.department)
                        .get();

                    if (approvalLineQuery.empty) {
                        console.error('ì˜¤ë¥˜: Firestoreì—ì„œ "' + currentUser.department + '" ë¶€ì„œì˜ ê²°ì¬ ë¼ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        showToast('í•´ë‹¹ ë¶€ì„œì˜ ê²°ì¬ ë¼ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                        return;
                    }

                    activeLineDoc = approvalLineQuery.docs.find(doc => doc.data().active === true);

                    if (!activeLineDoc) {
                        console.error('ì˜¤ë¥˜: í™œì„±(active) ìƒíƒœì¸ ê²°ì¬ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.');
                        showToast('í•´ë‹¹ ë¶€ì„œì— í™œì„±í™”ëœ ê²°ì¬ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                        return;
                    }

                    approvalLineId = activeLineDoc.id;
                }

                const approvalLine = activeLineDoc.data();
                const approvers = approvalLine.approvers || []; // Firestoreì—ì„œ approvers ë°°ì—´ì„ ì§ì ‘ ì‚¬ìš©

                const firstApprover = approvers.find(a => a.level === 1);

                if (!firstApprover || !firstApprover.id) {
                    showToast('ê²°ì¬ ë¼ì¸ì— 1ì°¨ ê²°ì¬ìê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                    return;
                }

                const currentApproverId = firstApprover.id;
                const approvalHistory = [{
                    approverId: firstApprover.id,
                    approverName: firstApprover.name,
                    status: 'pending',
                    level: 1,
                    assignedAt: new Date()
                }];
                
                const uploadedFileUrls = await uploadFiles();
                
                // ìœ í˜•íš¨ê³¼ ë°ì´í„°
                const hasTypicalEffect = document.querySelector('input[name="hasTypicalEffect"]:checked').value === 'yes';
                const expectedSaving = hasTypicalEffect ? (parseInt(document.getElementById('expectedSaving').value.replace(/[^\d]/g, '')) || 0) : 0;
                const savingBasis = hasTypicalEffect ? (document.getElementById('savingBasis').value || '') : '';

                // ìœ í˜•íš¨ê³¼ ê²€ì¦ í•„ìš” ì—¬ë¶€ í™•ì¸
                if (hasTypicalEffect && !expectedSaving) {
                    showToast('ì˜ˆìƒ ì ˆê° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ìœ í˜•íš¨ê³¼ ì‚°ì¶œê·¼ê±° í•„ìˆ˜ ì²´í¬ (500ì ì œí•œ ì œê±°ë¨)
                if (hasTypicalEffect && !savingBasis) {
                    showToast('ì‚°ì¶œ ê·¼ê±°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const effort = parseInt(document.getElementById('effortScore').value) || 0;
                const creativity = parseInt(document.getElementById('creativityScore').value) || 0;
                const quality = parseInt(document.getElementById('qualityScore').value) || 0;
                const safety = parseInt(document.getElementById('safetyScore').value) || 0;

                // ìœ í˜•íš¨ê³¼ ë˜ëŠ” ë¬´í˜•íš¨ê³¼ ì ìˆ˜ ê³„ì‚°
                let effectScore = 0;
                if (hasTypicalEffect) {
                    // ìœ í˜•íš¨ê³¼ê°€ ìˆëŠ” ê²½ìš°: ê¸ˆì•¡ ê¸°ë°˜ ì ìˆ˜
                    effectScore = calculateTangibleEffectScore(expectedSaving);
                } else {
                    // ë¬´í˜•íš¨ê³¼ë§Œ ìˆëŠ” ê²½ìš°: í’ˆì§ˆê³¼ ì•ˆì „ ì¤‘ ë” ë†’ì€ ì ìˆ˜
                    effectScore = Math.max(quality, safety);
                }

                const totalScore = effort + creativity + effectScore;
                const grade = calculateGrade(totalScore);

                const suggestion = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    suggestionNumber: formData.get('suggestionNumber'),
                    title: formData.get('title'),
                    implementor: formData.get('implementor'),
                    implementorId: document.getElementById('implementorId').value,
                    implementDept: formData.get('implementDept'),
                    category: formData.get('category'),
                    // priority ì œê±°ë¨
                    currentSituation: formData.get('currentSituation'),
                    improvementPlan: formData.get('improvementPlan'),
                    investmentCost: formData.get('investmentCost') || '0ì›',
                    // ìœ í˜•íš¨ê³¼ ê´€ë ¨
                    hasTypicalEffect: hasTypicalEffect,
                    expectedSaving: expectedSaving,
                    savingBasis: savingBasis,
                    scores: {
                        self: {
                            effort: effort,
                            creativity: creativity,
                            quality: quality,
                            safety: safety,
                            effect: effectScore,  // ìœ í˜•íš¨ê³¼ ë˜ëŠ” ë¬´í˜•íš¨ê³¼ ì ìˆ˜
                            tangibleEffect: hasTypicalEffect ? effectScore : 0,  // ìœ í˜•íš¨ê³¼ ì ìˆ˜
                            intangibleEffect: hasTypicalEffect ? 0 : effectScore,  // ë¬´í˜•íš¨ê³¼ ì ìˆ˜
                            total: totalScore,
                            grade: grade || '-'
                        }
                    },
                    selfScore: totalScore,
                    totalScore: totalScore,
                    grade: grade,
                    contributors: contributors.length > 0 ? contributors : null,
                    specialNotes: formData.get('specialNotes') || '',
                    proposer: currentUser.displayName,
                    department: currentUser.department,
                    submitDate: formData.get('submitDate'),
                    currentApproverId: currentApproverId,
                    approvalHistory: approvalHistory,
                    approvalLineId: activeLineDoc.id, // Save a reference to the approval line used
                    stage: 1, // Start at stage 1
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    attachments: uploadedFileUrls
                };

                // ìœ í˜•íš¨ê³¼ ê²€ì¦ ìƒíƒœ ì¶”ê°€
                if (hasTypicalEffect) {
                    suggestion.effectVerification = {
                        needsVerification: true,
                        status: 'pending',
                        originalAmount: expectedSaving,
                        verifiedAmount: 0,
                        typicalEffectScore: 0,
                        verificationNote: '',
                        adjustmentReason: '',
                        verifierId: null,
                        verifierName: null,
                        verifiedAt: null
                    };
                } else {
                    suggestion.effectVerification = {
                        needsVerification: false,
                        status: 'not_required',
                        originalAmount: 0,
                        verifiedAmount: 0,
                        typicalEffectScore: 0
                    };
                }
                
                await db.collection('suggestions').add(suggestion);
                showToast('ì œì•ˆì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                resetForm();
                setTimeout(() => showPage('mysuggestions'), 1000);
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        function validateForm(formData) {
            const title = formData.get('title');
            const currentSituation = formData.get('currentSituation');
            const improvementPlan = formData.get('improvementPlan');
            const category = formData.get('category');
            // const priority = formData.get('priority'); - ìš°ì„ ìˆœìœ„ ì œê±°ë¨

            if (!title || title.trim().length < 5) {
                showToast('ì œì•ˆë‚´ìš©ì€ ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return false;
            }

            if (!currentSituation || currentSituation.trim().length < 10) {
                showToast('ê¸°ì¡´ì‹¤ì‹œë‚´ìš©ì€ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return false;
            }

            if (!improvementPlan || improvementPlan.trim().length < 10) {
                showToast('ë³€ê²½(ì‹ ê·œ)ë‚´ìš©ì€ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return false;
            }

            if (!category) {
                showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return false;
            }

            // ìš°ì„ ìˆœìœ„ëŠ” ì„ íƒì‚¬í•­ìœ¼ë¡œ ë³€ê²½ë¨

            return true;
        }

        // íŒŒì¼ ì—…ë¡œë“œ
        async function uploadFiles() {
            if (uploadedFiles.length === 0) return [];

            const uploadPromises = uploadedFiles.map(async (file) => {
                try {
                    const timestamp = Date.now();
                    const fileName = `${currentUser.uid}/${timestamp}_${file.name}`;
                    const storageRef = storage.ref().child(`suggestions/${fileName}`);
                    
                    const response = await fetch(file.data);
                    const blob = await response.blob();
                    
                    await storageRef.put(blob);
                    const downloadURL = await storageRef.getDownloadURL();
                    
                    return {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        url: downloadURL,
                        path: fileName
                    };
                } catch (error) {
                    console.error(`íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜ (${file.name}):`, error);
                    return null;
                }
            });

            const results = await Promise.all(uploadPromises);
            return results.filter(result => result !== null);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function processFiles(files) {
            const maxFiles = 5;
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            for (let file of files) {
                if (uploadedFiles.length >= maxFiles) {
                    showToast(`ìµœëŒ€ ${maxFiles}ê°œ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'error');
                    break;
                }

                if (file.size > maxSize) {
                    showToast(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result
                    });
                    updateFileList();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            
            fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                    <div>
                        <strong>${file.name}</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">(${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeFile(${index})">ì‚­ì œ</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function resetForm() {
            const form = document.getElementById('suggestionForm');
            if (form) form.reset();
            uploadedFiles = [];
            contributors = [];
            editingData = null;
            editingSuggestionId = null;
            updateFileList();
            renderContributorTable();
            initializeForm();
        }

        // ì„ì‹œì €ì¥ ê¸°ëŠ¥
        async function saveDraft() {
            try {
                showToast('ì„ì‹œì €ì¥ ì¤‘...', 'info');

                // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘ (ìœ íš¨ì„± ê²€ì‚¬ ì—†ì´)
                const title = document.getElementById('title')?.value || '';
                const category = document.getElementById('category')?.value || '';
                const currentSituation = document.getElementById('currentSituation')?.value || '';
                const improvementPlan = document.getElementById('improvementPlan')?.value || '';
                const effect = document.getElementById('effect')?.value || '';
                const implementer = document.getElementById('implementer')?.value || '';

                // ìì²´í‰ê°€ ì •ë³´
                const effort = document.querySelector('input[name="effort"]:checked')?.value || '';
                const creativity = document.querySelector('input[name="creativity"]:checked')?.value || '';

                // ìœ í˜•íš¨ê³¼ ì •ë³´
                const hasTypicalEffect = document.querySelector('input[name="hasTypicalEffect"]:checked')?.value === 'yes';
                const expectedSaving = hasTypicalEffect ? (parseInt(document.getElementById('expectedSaving')?.value?.replace(/[^\d]/g, '')) || 0) : 0;
                const savingBasis = hasTypicalEffect ? (document.getElementById('savingBasis')?.value || '') : '';

                // íŒŒì¼ ì—…ë¡œë“œ (ìˆëŠ” ê²½ìš°)
                const uploadedFileUrls = await uploadFiles();

                // ì œì•ˆì„œ ë°ì´í„° ìƒì„±
                const suggestionData = {
                    userId: auth.currentUser.uid,
                    proposer: currentUser.displayName,
                    employeeId: currentUser.employeeId,
                    department: currentUser.department,
                    email: currentUser.email,
                    title: title,
                    category: category,
                    currentSituation: currentSituation,
                    improvementPlan: improvementPlan,
                    effect: effect,
                    implementer: implementer,
                    hasTypicalEffect: hasTypicalEffect,
                    expectedSaving: expectedSaving,
                    savingBasis: savingBasis,
                    effort: effort,
                    creativity: creativity,
                    contributors: contributors,
                    attachments: uploadedFileUrls,
                    status: 'draft',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Firestoreì— ì €ì¥
                const docRef = await db.collection('suggestions').add(suggestionData);

                showToast('ì„ì‹œì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // í¼ ì´ˆê¸°í™”
                resetForm();

                // ë‚´ ì œì•ˆì„œ í˜ì´ì§€ë¡œ ì´ë™
                showPage('mysuggestions');
                await loadMySuggestions();

            } catch (error) {
                console.error('ì„ì‹œì €ì¥ ì˜¤ë¥˜:', error);
                showToast('ì„ì‹œì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì„ì‹œì €ì¥ ì œì•ˆì„œ ì œì¶œ
        async function submitDraftSuggestion(suggestionId) {
            if (!confirm('ì„ì‹œì €ì¥ëœ ì œì•ˆì„œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                showToast('ì œì•ˆì„œ ì œì¶œ ì¤‘...', 'info');

                // ê¸°ì¡´ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                const docRef = db.collection('suggestions').doc(suggestionId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();

                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if (!data.title || !data.currentSituation || !data.improvementPlan) {
                    showToast('í•„ìˆ˜ í•­ëª©ì´ ëª¨ë‘ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì œì•ˆì„œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ê¸°ì—¬ë„ ê²€ì¦
                if (data.contributors && data.contributors.length > 0) {
                    const total = data.contributors.reduce((sum, c) => sum + (parseFloat(c.pct) || 0), 0);
                    if (total !== 100) {
                        showToast('ê¸°ì—¬ë„ í•©ê³„ê°€ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì œì•ˆì„œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                }

                // --- ê²°ì¬ ë¼ì¸ ì„ íƒ ë¡œì§ ---
                let activeLineDoc = null;
                let approvalLineId = null;

                // ì¼ë°˜ ì‚¬ìš©ì: ìì‹ ì˜ ë¶€ì„œ ê²°ì¬ë¼ì¸ ì‚¬ìš©
                const approvalLineQuery = await db.collection('approvalLines')
                    .where('department', '==', currentUser.department)
                    .get();

                if (approvalLineQuery.empty) {
                    console.error('ì˜¤ë¥˜: Firestoreì—ì„œ "' + currentUser.department + '" ë¶€ì„œì˜ ê²°ì¬ ë¼ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    showToast('í•´ë‹¹ ë¶€ì„œì˜ ê²°ì¬ ë¼ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                    return;
                }

                activeLineDoc = approvalLineQuery.docs.find(doc => doc.data().active === true);

                if (!activeLineDoc) {
                    console.error('ì˜¤ë¥˜: í™œì„±(active) ìƒíƒœì¸ ê²°ì¬ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.');
                    showToast('í•´ë‹¹ ë¶€ì„œì— í™œì„±í™”ëœ ê²°ì¬ ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                    return;
                }

                approvalLineId = activeLineDoc.id;

                const approvalLine = activeLineDoc.data();
                const approvers = approvalLine.approvers || [];

                const firstApprover = approvers.find(a => a.level === 1);

                if (!firstApprover || !firstApprover.id) {
                    showToast('ê²°ì¬ ë¼ì¸ì— 1ì°¨ ê²°ì¬ìê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                    return;
                }

                const currentApproverId = firstApprover.id;
                const approvalHistory = [{
                    approverId: firstApprover.id,
                    approverName: firstApprover.name,
                    status: 'pending',
                    level: 1,
                    assignedAt: new Date()
                }];

                // draft â†’ pendingìœ¼ë¡œ ìƒíƒœ ë³€ê²½ ë° ê²°ì¬ ì •ë³´ ì¶”ê°€
                await docRef.update({
                    status: 'pending',
                    approvalLineId: approvalLineId,
                    currentApproverId: currentApproverId,
                    approvalHistory: approvalHistory,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // ê²°ì¬ìì—ê²Œ ì•Œë¦¼ ì „ì†¡
                await db.collection('notifications').add({
                    userId: firstApprover.id,
                    title: 'ìƒˆë¡œìš´ ê²°ì¬ ìš”ì²­',
                    message: `${data.proposer}ë‹˜ì˜ "${data.title}" ì œì•ˆì„œê°€ ê²°ì¬ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.`,
                    type: 'approval',
                    suggestionId: suggestionId,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ì œì•ˆì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMySuggestions();

            } catch (error) {
                console.error('ì œì•ˆì„œ ì œì¶œ ì˜¤ë¥˜:', error);
                showToast('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ì œì•ˆì„œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        function canEditSuggestion(suggestion) {
            // ì„ì‹œì €ì¥ ìƒíƒœì´ê±°ë‚˜, ê²°ì¬ê°€ ì‹œì‘ë˜ì§€ ì•Šì€ ê²½ìš°
            if (suggestion.status === 'draft') return true;

            // ìˆ˜ì • ìš”ì²­ëœ ì œì•ˆì„œëŠ” ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
            if (suggestion.status === 'revision_requested') return true;

            // ê²°ì¬ ëŒ€ê¸° ìƒíƒœì´ê³  ê²°ì¬ íˆìŠ¤í† ë¦¬ê°€ ì—†ëŠ” ê²½ìš° (ê²°ì¬ê°€ ì•„ì§ ì‹œì‘ë˜ì§€ ì•ŠìŒ)
            if (suggestion.status === 'pending' && (!suggestion.approvalHistory || suggestion.approvalHistory.length === 0)) {
                return true;
            }

            // ê²°ì¬ íˆìŠ¤í† ë¦¬ê°€ ìˆì§€ë§Œ ëª¨ë‘ ëŒ€ê¸° ìƒíƒœì¸ ê²½ìš°
            if (suggestion.status === 'pending' && suggestion.approvalHistory) {
                const hasApproved = suggestion.approvalHistory.some(h => h.status === 'approved');
                if (!hasApproved) return true;
            }

            return false;
        }

        // ì œì•ˆì„œ ìˆ˜ì •
        async function editSuggestion(suggestionId) {
            try {
                const docRef = db.collection('suggestions').doc(suggestionId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();

                // ìˆ˜ì • ê¶Œí•œ í™•ì¸
                if (!canEditSuggestion(data)) {
                    showToast('ê²°ì¬ê°€ ì§„í–‰ ì¤‘ì¸ ì œì•ˆì„œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                // í¸ì§‘ ëª¨ë“œ ë°ì´í„° ì €ì¥
                editingData = data;
                editingSuggestionId = suggestionId;

                // ì œì•ˆì„œ ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™ (initializeFormì´ ìë™ í˜¸ì¶œë˜ê³ , ë°ì´í„°ë„ ë¡œë“œë¨)
                showPage('create');

            } catch (error) {
                console.error('ì œì•ˆì„œ ìˆ˜ì • ì¤€ë¹„ ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì œì•ˆì„œ ì—…ë°ì´íŠ¸
        async function updateSuggestion(suggestionId) {
            try {
                showToast('ì œì•ˆì„œ ìˆ˜ì • ì¤‘...', 'info');

                // ì•ˆì „í•œ ê°’ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
                const getValueSafely = (id) => {
                    const element = document.getElementById(id);
                    return element ? element.value : '';
                };

                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const title = getValueSafely('title');
                const category = getValueSafely('category');
                const currentSituation = getValueSafely('currentSituation');
                const improvementPlan = getValueSafely('improvementPlan');
                const effect = getValueSafely('effect');
                const implementer = getValueSafely('implementer');
                const effort = document.querySelector('input[name="effort"]:checked')?.value || '';
                const creativity = document.querySelector('input[name="creativity"]:checked')?.value || '';
                const hasTypicalEffect = document.querySelector('input[name="hasTypicalEffect"]:checked')?.value === 'yes';
                const expectedSaving = hasTypicalEffect ? (parseInt(getValueSafely('expectedSaving')) || 0) : 0;
                const savingBasis = hasTypicalEffect ? getValueSafely('savingBasis') : '';

                // í•„ìˆ˜ í•„ë“œ í™•ì¸
                if (!title) {
                    showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // íŒŒì¼ ì—…ë¡œë“œ (ìƒˆë¡œìš´ íŒŒì¼ì´ ìˆëŠ” ê²½ìš°)
                const uploadedFileUrls = await uploadFiles();

                // ê¸°ì¡´ ë¬¸ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const existingDoc = await db.collection('suggestions').doc(suggestionId).get();
                const existingData = existingDoc.data();
                const existingAttachments = existingData.attachments || [];
                const allAttachments = [...existingAttachments, ...uploadedFileUrls];

                // ê¸°ì¡´ ìƒíƒœ ìœ ì§€ (draftë©´ draftë¡œ, pendingì´ë©´ pendingìœ¼ë¡œ)
                const currentStatus = existingData.status;

                // ì—…ë°ì´íŠ¸ ë°ì´í„°
                const updateData = {
                    title: title,
                    category: category,
                    currentSituation: currentSituation,
                    improvementPlan: improvementPlan,
                    effect: effect,
                    implementer: implementer,
                    hasTypicalEffect: hasTypicalEffect,
                    expectedSaving: expectedSaving,
                    savingBasis: savingBasis,
                    effort: effort,
                    creativity: creativity,
                    contributors: contributors,
                    attachments: allAttachments,
                    status: currentStatus, // âœ… ê¸°ì¡´ ìƒíƒœ ìœ ì§€
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('suggestions').doc(suggestionId).update(updateData);

                showToast('ì œì•ˆì„œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // í¼ ì´ˆê¸°í™” ë° ë²„íŠ¼ ì›ìƒë³µêµ¬
                resetForm();
                const submitBtn = document.querySelector('#suggestionForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
                    submitBtn.onclick = null;
                }

                // ë‚´ ì œì•ˆì„œ í˜ì´ì§€ë¡œ ì´ë™
                showPage('mysuggestions');
                await loadMySuggestions();

            } catch (error) {
                console.error('ì œì•ˆì„œ ìˆ˜ì • ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì œì•ˆì„œ ì‚­ì œ
        async function deleteSuggestion(suggestionId) {
            try {
                const docRef = db.collection('suggestions').doc(suggestionId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();

                // ì‚­ì œ ê¶Œí•œ í™•ì¸
                if (!canEditSuggestion(data)) {
                    showToast('ê²°ì¬ê°€ ì§„í–‰ ì¤‘ì¸ ì œì•ˆì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                if (!confirm(`"${data.title}" ì œì•ˆì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì œì•ˆì„œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    return;
                }

                // Firestoreì—ì„œ ì‚­ì œ
                await docRef.delete();

                showToast('ì œì•ˆì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMySuggestions();

            } catch (error) {
                console.error('ì œì•ˆì„œ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // loadMySuggestions í•¨ìˆ˜ ì¶”ê°€
        async function loadMySuggestions() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('userId', '==', auth.currentUser.uid)
                    .get();

                suggestions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // ë‚ ì§œìˆœ ì •ë ¬
                suggestions.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(0);
                    const dateB = b.createdAt?.toDate?.() || new Date(0);
                    return dateB - dateA;
                });

                updateSuggestionsList();
                updateDashboard();

            } catch (error) {
                console.error('ì œì•ˆì„œ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            const total = suggestions.length;
            const approved = suggestions.filter(s => s.status === 'approved').length;
            const pending = suggestions.filter(s => ['pending', 'stage1', 'stage2'].includes(s.stage || s.status)).length;
            const rate = total > 0 ? Math.round((approved / total) * 100) : 0;

            document.getElementById('totalSuggestions').textContent = total;
            document.getElementById('approvedSuggestions').textContent = approved;
            document.getElementById('pendingSuggestions').textContent = pending;
            document.getElementById('approvalRate').textContent = rate + '%';

            updateRecentSuggestions();
        }

        function updateRecentSuggestions() {
            const recent = suggestions.slice(0, 5);
            const container = document.getElementById('recentSuggestions');
            
            if (!container) return;
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">ìµœê·¼ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = recent.map(suggestion => `
                <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer;" onclick="viewSuggestion('${suggestion.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <strong>${suggestion.title}</strong>
                        <span class="status-badge status-${suggestion.status}">${getStatusText(suggestion.status)}</span>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ${formatDate(suggestion.createdAt)} | ${suggestion.category || '-'} | ìì²´ì ìˆ˜: ${suggestion.scores?.self?.total || 0}ì 
                    </div>
                </div>
            `).join('');
        }

        function updateSystemNotices(notices) {
            const container = document.getElementById('systemNotices');
            if (!container) return;
            
            if (notices.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = notices.map(notice => `
                <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <strong>${notice.title}</strong>
                    <div style="color: #333; margin: 8px 0;">${notice.content}</div>
                    <div style="font-size: 12px; color: #666;">${formatDate(notice.createdAt)}</div>
                </div>
            `).join('');
        }

        function updateSuggestionsList() {
            const tbody = document.getElementById('suggestionsTableBody');
            if (!tbody) return;

            if (suggestions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">ì œì¶œí•œ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = suggestions.map(s => {
                let progressHtml = `<div style="color: #6c757d;">${getStatusText(s.status)}</div>`;
                const approvalLine = approvalLinesMap[s.approvalLineId];

                if (s.status === 'pending' && approvalLine && approvalLine.approvers) {
                    progressHtml = '<div style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">';
                    
                    approvalLine.approvers.sort((a, b) => a.level - b.level).forEach((approver, index) => {
                        const historyEntry = s.approvalHistory?.find(h => h.approverId === approver.id);
                        let icon = 'âšªï¸';
                        let textColor = '#6c757d';
                        let fontWeight = 'normal';
                        let bgColor = '#f8f9fa';
                        let borderColor = '#e9ecef';

                        if (historyEntry) {
                            icon = 'âœ…';
                            textColor = '#155724';
                            fontWeight = '600';
                            bgColor = '#d4edda';
                            borderColor = '#c3e6cb';
                        } else if (s.currentApproverId === approver.id) {
                            icon = 'â³';
                            textColor = '#856404';
                            fontWeight = 'bold';
                            bgColor = '#fff3cd';
                            borderColor = '#ffeeba';
                        }

                        if (index > 0) {
                            progressHtml += `<div style="flex-shrink: 0; color: #dee2e6; font-weight: bold;">â†’</div>`;
                        }

                        progressHtml += `
                            <div style="padding: 4px 8px; border-radius: 6px; background: ${bgColor}; border: 1px solid ${borderColor};">
                                <span style="font-weight: ${fontWeight}; color: ${textColor}; font-size: 13px;">${icon} ${approver.name}</span>
                            </div>
                        `;
                    });
                    progressHtml += '</div>';
                }

                return `
                    <tr>
                        <td>${s.suggestionNumber || s.id.substring(0, 8)}</td>
                        <td>${s.title}</td>
                        <td>${progressHtml}</td>
                        <td>${formatDate(s.createdAt)}</td>
                        <td>${s.scores?.self?.total || 0}ì </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewSuggestion('${s.id}')">ìƒì„¸</button>
                            ${s.status === 'draft' ? `
                                <button class="btn btn-sm btn-primary" onclick="submitDraftSuggestion('${s.id}')" style="margin-left: 5px;">ì œì¶œí•˜ê¸°</button>
                            ` : ''}
                            ${canEditSuggestion(s) ? `
                                <button class="btn btn-sm" onclick="editSuggestion('${s.id}')" style="background: #17a2b8; color: white; margin-left: 5px;">ìˆ˜ì •</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSuggestion('${s.id}')" style="margin-left: 5px;">ì‚­ì œ</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateNotificationsList(notificationsArray) {
            // ì´ë¯¸ ì •ë ¬ëœ ë°°ì—´ì„ ì§ì ‘ ë°›ìŒ
            const notifications = notificationsArray || [];

            const container = document.getElementById('notificationsList');
            if (!container) return;

            if (notifications.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = notifications.map(n => `
                <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <strong>${n.title}</strong>
                    <div style="color: #333; margin: 8px 0;">${n.message}</div>
                    <div style="font-size: 12px; color: #666;">${formatDate(n.createdAt)}</div>
                </div>
            `).join('');
        }

        // ë…¸ë ¥ë„ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getEffortText(score) {
            const texts = {
                0: '0ì  - ë…¸ë ¥ ë¯¸í¡',
                5: '5ì  - 8ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥',
                10: '10ì  - 80ì‹œê°„ ì´ë‚´ì˜ ë…¸ë ¥',
                15: '15ì  - 80ì‹œê°„ ì´ìƒì˜ ë…¸ë ¥'
            };
            return texts[score] || `${score}ì `;
        }

        // ì°½ì˜ì„± í…ìŠ¤íŠ¸ ë°˜í™˜
        function getCreativityText(score) {
            const texts = {
                0: '0ì  - ì°½ì˜ì„± ì—†ìŒ',
                5: '5ì  - íŒ€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤',
                10: '10ì  - ë³¸ë¶€ë‚´ ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ìˆë‹¤',
                15: '15ì  - ë³¸ë¶€ì— ìœ ì‚¬ ì‚¬ë¡€ì˜ ì œì•ˆì´ ì—†ë‹¤'
            };
            return texts[score] || `${score}ì `;
        }

        // í’ˆì§ˆ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getQualityText(score) {
            const texts = {
                0: '0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ',
                5: '5ì  - í˜„ì¬ë³´ë‹¤ í’ˆì§ˆìˆ˜ì¤€ì´ ì˜¬ë¼ê°„ë‹¤',
                7: '7ì  - ê²½ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤',
                10: '10ì  - ì¤‘ë¶ˆëŸ‰ì„ ì˜ˆë°©í•˜ê±°ë‚˜ í’ˆì§ˆìˆ˜ì¤€ì´ í–¥ìƒëœë‹¤'
            };
            return texts[score] || `${score}ì `;
        }

        // ì•ˆì „ í…ìŠ¤íŠ¸ ë°˜í™˜
        function getSafetyText(score) {
            const texts = {
                0: '0ì  - í•´ë‹¹ì‚¬í•­ì—†ìŒ',
                5: '5ì  - í˜„ì¬ì˜ ìƒíƒœë³´ë‹¤ ì•ˆì „í•œ ì‘ì—…í™˜ê²½ì„ êµ¬ì¶•í•œë‹¤',
                7: '7ì  - ê²½ë¯¸í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ê³µìƒ, ë„ë‚œ ë“±)',
                10: '10ì  - ì¤‘ëŒ€í•œ ì•ˆì „ì‚¬ê³ ë¥¼ ì˜ˆë°©í•˜ëŠ” íš¨ê³¼ê°€ ìˆë‹¤ (ì‚°ì—…ì¬í•´, í™”ì¬ ë“±)'
            };
            return texts[score] || `${score}ì `;
        }

        function viewSuggestion(id) {
            const s = suggestions.find(item => item.id === id);
            if (!s) return;
            
            const detailHtml = `
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <strong>ì œì•ˆë²ˆí˜¸:</strong> ${s.suggestionNumber || s.id.substring(0, 8)}<br>
                            <strong>ì œì•ˆì:</strong> ${s.proposer}<br>
                            <strong>ì œì•ˆë¶€ì„œ:</strong> ${s.department}<br>
                            <strong>ì ‘ìˆ˜ì¼:</strong> ${formatDate(s.createdAt)}
                        </div>
                        <div>
                            <strong>ì¹´í…Œê³ ë¦¬:</strong> ${s.category || '-'}<br>
                            <strong>ìš°ì„ ìˆœìœ„:</strong> ${s.priority || '-'}<br>
                            <strong>ì‹¤ì‹œì:</strong> ${s.implementor || '-'}<br>
                            <strong>ì‹¤ì‹œë¶€ì„œ:</strong> ${s.implementDept || '-'}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">ì œì•ˆ ë‚´ìš©</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">${s.title}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">ê¸°ì¡´ì‹¤ì‹œë‚´ìš©</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.currentSituation}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">ë³€ê²½(ì‹ ê·œ)ë‚´ìš©</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.improvementPlan}</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">ìì²´í‰ê°€</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div><strong>ë…¸ë ¥ë„:</strong> ${getEffortText(s.scores?.self?.effort || 0)}</div>
                            <div><strong>ì°½ì˜ì„±:</strong> ${getCreativityText(s.scores?.self?.creativity || 0)}</div>
                            <div><strong>í’ˆì§ˆ:</strong> ${getQualityText(s.scores?.self?.quality || 0)}</div>
                            <div><strong>ì•ˆì „:</strong> ${getSafetyText(s.scores?.self?.safety || 0)}</div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
                                <strong>ì´ì :</strong> ${s.scores?.self?.total || 0}ì 
                                <strong style="margin-left: 20px;">ë“±ê¸‰:</strong> ${s.scores?.self?.grade || '-'}
                            </div>
                        </div>
                    </div>

                    ${s.contributors && s.contributors.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ì°¸ì—¬ì ê¸°ì—¬ë„</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ì´ë¦„</th>
                                        <th>ì—­í• </th>
                                        <th>ê¸°ì—¬ë„</th>
                                        <th>ë¶€ì„œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${s.contributors.map(c => `
                                        <tr>
                                            <td>${c.name}</td>
                                            <td>${c.role}</td>
                                            <td>${c.pct}%</td>
                                            <td>${c.department}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('detailContent').innerHTML = detailHtml;
            document.getElementById('detailModal').classList.add('show');
        }

        // UI í—¬í¼
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            const targetMenuItem = document.querySelector(`[data-page="${pageId}"]`);
            if (targetMenuItem) {
                targetMenuItem.classList.add('active');
            }

            if (pageId === 'create') {
                initializeForm();
            }

            // í˜ì´ì§€ë³„ ë°ì´í„° ë¡œë“œ
            if (pageId === 'allsuggestions') {
                loadAllSuggestions();
            } else if (pageId === 'pending') {
                loadPendingSuggestions();
            } else if (pageId === 'reviewing') {
                loadReviewingSuggestions();
            } else if (pageId === 'completed') {
                loadCompletedSuggestions();
            }

            if (window.innerWidth < 768) {
                closeSidebar();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function getStatusText(status) {
            const map = {
                pending: 'ìŠ¹ì¸ ëŒ€ê¸°',
                stage1: '1ì°¨ í‰ê°€ì¤‘',
                stage2: '2ì°¨ í‰ê°€ì¤‘',
                approved: 'ìŠ¹ì¸ë¨',
                rejected: 'ë°˜ë ¤ë¨'
            };
            return map[status] || status;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp.seconds) {
                date = new Date(timestamp.seconds * 1000);
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleDateString('ko-KR');
        }

        // ì „ì²´ ì œì•ˆ ë¡œë“œ
        async function loadAllSuggestions() {
            try {
                const filterDept = document.getElementById('filterDepartment').value;
                const filterStatus = document.getElementById('filterStatus').value;

                if (!currentUser) {
                    return;
                }

                // ëª¨ë“  ì‚¬ìš©ìê°€ ì „ì²´ ì œì•ˆì„ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ ë³€ê²½
                const snapshot = await db.collection('suggestions')
                    .limit(1000)
                    .get();
                const tbody = document.getElementById('allSuggestionsList');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                let suggestions = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // í•„í„° ì ìš©
                    if (filterDept && data.department !== filterDept) return;
                    if (filterStatus && data.status !== filterStatus) return;
                    suggestions.push({ id: doc.id, ...data });
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ (ìµœì‹ ìˆœ)
                suggestions.sort((a, b) => {
                    const timeA = a.createdAt?.toDate?.() || new Date(0);
                    const timeB = b.createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });

                // ìƒìœ„ 100ê°œë§Œ í‘œì‹œ
                suggestions = suggestions.slice(0, 100);

                if (suggestions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                ì¡°ê±´ì— ë§ëŠ” ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = suggestions.map(s => {
                    const statusBadge = getStatusBadge(s.status);
                    const gradeBadge = s.grade ? `<span class="badge badge-success">${s.grade}</span>` : '-';

                    return `
                        <tr>
                            <td><strong>${s.suggestionNumber}</strong></td>
                            <td>${s.proposer || '-'}</td>
                            <td>${s.department || '-'}</td>
                            <td>
                                <div style="font-weight: 600; margin-bottom: 3px;">${s.title}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${s.category || '-'} | ${s.priority || '-'}
                                </div>
                            </td>
                            <td>${formatDate(s.createdAt)}</td>
                            <td>${statusBadge}</td>
                            <td>${gradeBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewSuggestion('${s.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // ë¶€ì„œ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
                updateDepartmentFilter(suggestions);

            } catch (error) {
                console.error('ì „ì²´ ì œì•ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¶€ì„œ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateDepartmentFilter(suggestions) {
            const filterDept = document.getElementById('filterDepartment');
            const departments = [...new Set(suggestions.map(s => s.department).filter(d => d))];
            const currentValue = filterDept.value;

            filterDept.innerHTML = '<option value="">ì „ì²´ ë¶€ì„œ</option>';
            departments.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                if (dept === currentValue) option.selected = true;
                filterDept.appendChild(option);
            });
        }

        // ìƒíƒœ ë±ƒì§€ ìƒì„±
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge badge-warning">ê²€í†  ì¤‘</span>',
                'approved': '<span class="badge badge-success">ìŠ¹ì¸</span>',
                'rejected': '<span class="badge badge-danger">ë°˜ë ¤</span>',
                'revision_requested': '<span class="badge badge-info">ìˆ˜ì • ìš”ì²­</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">ì•Œ ìˆ˜ ì—†ìŒ</span>';
        }

        // ìœ í˜•íš¨ê³¼ ì„¹ì…˜ í† ê¸€
        function toggleTypicalEffect() {
            const hasEffect = document.querySelector('input[name="hasTypicalEffect"]:checked').value;
            const section = document.getElementById('typicalEffectSection');
            const qualityScore = document.getElementById('qualityScore');
            const safetyScore = document.getElementById('safetyScore');

            if (hasEffect === 'yes') {
                section.style.display = 'block';
                // ìœ í˜•íš¨ê³¼ ì„ íƒ ì‹œ ë¬´í˜•íš¨ê³¼ë¥¼ 0ì ìœ¼ë¡œ ì„¤ì •
                if (qualityScore) qualityScore.value = '0';
                if (safetyScore) safetyScore.value = '0';
            } else {
                section.style.display = 'none';
                // ì…ë ¥ ê°’ ì´ˆê¸°í™”
                document.getElementById('expectedSaving').value = '';
                document.getElementById('savingBasis').value = '';
                document.getElementById('evidenceFiles').value = '';
                evidenceFiles = [];
                updateEvidenceFileList();
                updateBasisCharCount();
            }
        }

        // ê¸ˆì•¡ ì…ë ¥ ì‹œ ì²œ ë‹¨ìœ„ ì‰¼í‘œ ìë™ ì¶”ê°€
        function formatSavingInput(input) {
            // ìˆ«ìë§Œ ì¶”ì¶œ
            let value = input.value.replace(/[^\d]/g, '');

            // ì²œ ë‹¨ìœ„ ì‰¼í‘œ ì¶”ê°€
            if (value) {
                value = parseInt(value).toLocaleString('ko-KR');
            }

            input.value = value;

            // ê¸ˆì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
            formatSavingAmount();
        }

        // ê¸ˆì•¡ í¬ë§·íŒ… ë° ì ìˆ˜ í‘œì‹œ
        function formatSavingAmount() {
            const input = document.getElementById('expectedSaving');
            // ì‰¼í‘œ ì œê±° í›„ ìˆ«ìë¡œ ë³€í™˜
            const amount = parseInt(input.value.replace(/[^\d]/g, '')) || 0;
            const display = document.getElementById('savingAmountDisplay');

            if (amount > 0) {
                const score = calculateTangibleEffectScore(amount);
                display.innerHTML = `= ${formatNumber(amount)}ì›/ë…„ <span style="color: #667eea; margin-left: 10px;">â†’ ì˜ˆìƒ ì ìˆ˜: ${score}ì </span>`;
            } else {
                display.textContent = '';
            }
        }

        // ê¸ˆì•¡ ì…ë ¥ê°’ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function getSavingAmount() {
            const input = document.getElementById('expectedSaving');
            return parseInt(input.value.replace(/[^\d]/g, '')) || 0;
        }

        // ì‚°ì¶œ ê·¼ê±° ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        const savingBasisInput = document.getElementById('savingBasis');
        if (savingBasisInput) {
            savingBasisInput.addEventListener('input', updateBasisCharCount);
        }

        function updateBasisCharCount() {
            const input = document.getElementById('savingBasis');
            const count = document.getElementById('basisCharCount');
            const length = input ? input.value.length : 0;

            if (count) {
                count.textContent = length + 'ì';
                count.style.color = length > 0 ? '#666' : '#666';
            }
        }

        // ì¦ë¹™ íŒŒì¼ ì²˜ë¦¬
        function handleEvidenceFiles(e) {
            const files = Array.from(e.target.files);

            if (files.length > 3) {
                showToast('ìµœëŒ€ 3ê°œ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                e.target.value = '';
                return;
            }

            evidenceFiles = [];

            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name}ì€(ëŠ”) 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, 'error');
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    evidenceFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result
                    });
                    updateEvidenceFileList();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateEvidenceFileList() {
            const list = document.getElementById('evidenceFileList');
            if (!list) return;

            if (evidenceFiles.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = evidenceFiles.map((file, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 5px;">
                    <div>
                        <strong>${file.name}</strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">(${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeEvidenceFile(${index})">ì‚­ì œ</button>
                </div>
            `).join('');
        }

        function removeEvidenceFile(index) {
            evidenceFiles.splice(index, 1);
            updateEvidenceFileList();
            document.getElementById('evidenceFiles').value = '';
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    showToast('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
                });
            }
        }

        // ==================== ê²°ì¬ì ì „ìš© í•¨ìˆ˜ ====================

        // ê²°ì¬ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ
        async function loadPendingSuggestions() {
            if (!currentUser || !currentUser.employeeId) {
                return;
            }

            try {
                const snapshot = await db.collection('suggestions')
                    .where('currentApproverId', '==', currentUser.employeeId)
                    .where('status', '==', 'pending')
                    .get();

                const tbody = document.getElementById('pendingList');
                if (!tbody) {
                    return;
                }

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                const myPending = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });

                if (myPending.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ê²°ì¬ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;

                    // ë°°ì§€ ì—…ë°ì´íŠ¸
                    const badge = document.getElementById('pendingBadge');
                    if (badge) badge.textContent = '0';
                    return;
                }

                tbody.innerHTML = myPending.map(doc => {
                    const data = doc.data();
                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.department}</td>
                            <td><strong>${data.title}</strong></td>
                            <td>${formatDate(data.createdAt)}</td>
                            <td>
                                <div style="text-align: center;">
                                    <div style="font-size: 18px; font-weight: 600; color: #667eea;">${data.scores?.self?.total || 0}</div>
                                    <div style="font-size: 11px; color: #999;">${data.scores?.self?.grade || '-'}</div>
                                </div>
                            </td>
                            <td>
                                <a href="leader.html" class="btn btn-primary btn-sm">
                                    í‰ê°€í•˜ê¸°
                                </a>
                            </td>
                        </tr>
                    `;
                }).join('');

                // ë°°ì§€ ì—…ë°ì´íŠ¸
                const badge = document.getElementById('pendingBadge');
                if (badge) badge.textContent = myPending.length;

            } catch (error) {
                console.error('âŒ ê²°ì¬ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€í†  ì¤‘ ëª©ë¡ ë¡œë“œ
        async function loadReviewingSuggestions() {
            if (!currentUser || !currentUser.employeeId) return;

            try {
                const snapshot = await db.collection('suggestions')
                    .where('approvalStatus', 'in', ['level1', 'level2'])
                    .get();

                const tbody = document.getElementById('reviewingList');
                if (!tbody) return;

                // ë‚´ê°€ ì´ë¯¸ ìŠ¹ì¸í•œ ì œì•ˆì„œë§Œ í•„í„°ë§
                let myReviewing = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return (data.level1Approval && data.level1Approval.approverId === currentUser.employeeId) ||
                           (data.level2Approval && data.level2Approval.approverId === currentUser.employeeId);
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                myReviewing = myReviewing.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });

                if (myReviewing.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                ê²€í†  ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = myReviewing.map(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentUser.employeeId
                        ? data.level1Approval
                        : data.level2Approval;

                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.title}</td>
                            <td>
                                <span class="badge badge-success">ìŠ¹ì¸</span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ì ìˆ˜: ${myApproval.score}ì </div>
                            </td>
                            <td>
                                <span class="badge badge-warning">
                                    ${data.approvalStatus === 'level1' ? '2ì°¨ ê²°ì¬ ëŒ€ê¸°' : 'ìµœì¢… ê²°ì¬ ëŒ€ê¸°'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('âŒ ê²€í†  ì¤‘ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì²˜ë¦¬ ì™„ë£Œ ëª©ë¡ ë¡œë“œ
        async function loadCompletedSuggestions() {
            if (!currentUser || !currentUser.employeeId) return;

            try {
                const snapshot = await db.collection('suggestions')
                    .where('approvalStatus', 'in', ['approved', 'rejected'])
                    .get();

                const tbody = document.getElementById('completedList');
                if (!tbody) return;

                // ë‚´ê°€ ì²˜ë¦¬í•œ ì œì•ˆì„œë§Œ í•„í„°ë§
                let myCompleted = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return (data.level1Approval && data.level1Approval.approverId === currentUser.employeeId) ||
                           (data.level2Approval && data.level2Approval.approverId === currentUser.employeeId) ||
                           (data.finalApproval && data.finalApproval.approverId === currentUser.employeeId);
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ
                myCompleted = myCompleted.sort((a, b) => {
                    const timeA = a.data().updatedAt?.toDate?.() || new Date(0);
                    const timeB = b.data().updatedAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                }).slice(0, 50);

                if (myCompleted.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ì²˜ë¦¬ ì™„ë£Œëœ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = myCompleted.map(doc => {
                    const data = doc.data();
                    const myApproval = data.level1Approval?.approverId === currentUser.employeeId
                        ? data.level1Approval
                        : (data.level2Approval?.approverId === currentUser.employeeId
                            ? data.level2Approval
                            : data.finalApproval);

                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.title}</td>
                            <td>
                                <span class="badge ${myApproval.status === 'approved' ? 'badge-success' : 'badge-danger'}">
                                    ${myApproval.status === 'approved' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                                </span>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">ì ìˆ˜: ${myApproval.score}ì </div>
                            </td>
                            <td>
                                <span class="badge ${data.approvalStatus === 'approved' ? 'badge-success' : 'badge-danger'}">
                                    ${data.approvalStatus === 'approved' ? 'ìµœì¢… ìŠ¹ì¸' : 'ë°˜ë ¤'}
                                </span>
                            </td>
                            <td>${formatDate(myApproval.approvedAt)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('âŒ ì²˜ë¦¬ ì™„ë£Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ëª¨ë‹¬ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (onclickì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        window.viewSuggestion = viewSuggestion;
        window.closeModal = closeModal;
        window.showPage = showPage;
        window.logout = logout;
        window.toggleSidebar = toggleSidebar;
        window.closeSidebar = closeSidebar;
    </script>
</body>
</html>
