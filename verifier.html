<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ í˜•íš¨ê³¼ ê²€ì¦ë‹´ë‹¹ì ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .user-info {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 15px 25px;
            background: none;
            border: none;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            color: #495057;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #dc3545;
            color: white;
            margin-left: 10px;
        }

        .logout-btn {
            margin: 20px 25px;
            width: calc(100% - 50px);
            padding: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            color: white;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 600;
            color: #667eea;
        }

        /* ì¹´ë“œ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .card-body {
            padding: 25px;
        }

        /* í…Œì´ë¸” */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ì½˜í…ì¸  ì„¹ì…˜ */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            float: right;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        /* í¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-box strong {
            color: #667eea;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’° ìœ í˜•íš¨ê³¼ ê²€ì¦</h2>
                <div class="user-info" id="userInfo">
                    ë¡œë”© ì¤‘...
                </div>
            </div>

            <div class="nav-menu">
                <button class="nav-item active" onclick="showSection('dashboard')">
                    ğŸ“Š ëŒ€ì‹œë³´ë“œ
                </button>
                <button class="nav-item" onclick="showSection('pending')">
                    â° ê²€ì¦ ëŒ€ê¸° <span class="badge" id="pendingCount">0</span>
                </button>
                <button class="nav-item" onclick="showSection('completed')">
                    âœ… ê²€ì¦ ì™„ë£Œ
                </button>
                <button class="nav-item" onclick="showSection('allSuggestions')">
                    ğŸ“‹ ì „ì²´ ì œì•ˆ
                </button>
                <button class="nav-item" onclick="showSection('stats')">
                    ğŸ“ˆ í†µê³„
                </button>
            </div>

            <button class="logout-btn" onclick="window.location.href='dashboard.html'" style="background: #667eea; margin-bottom: 10px;">
                â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </button>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboard" class="content-section active">
                <div class="page-header">
                    <h1>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
                    <p>ìœ í˜•íš¨ê³¼ ê²€ì¦ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ê²€ì¦ ëŒ€ê¸°</h3>
                        <div class="number" id="statPending">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì¦‰ì‹œ ê²€ì¦ í•„ìš”</p>
                    </div>
                    <div class="stat-card">
                        <h3>ì˜¤ëŠ˜ ê²€ì¦</h3>
                        <div class="number" style="color: #28a745;" id="statToday">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì˜¤ëŠ˜ ê²€ì¦ ì™„ë£Œ</p>
                    </div>
                    <div class="stat-card">
                        <h3>ì›”ê°„ ê²€ì¦</h3>
                        <div class="number" style="color: #17a2b8;" id="statMonth">0</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">ì´ë²ˆ ë‹¬ ì´í•©</p>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ì¡°ì •ë¥ </h3>
                        <div class="number" style="color: #ffc107; font-size: 28px;" id="statAdjustRate">100%</div>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">í™•ì •/ì˜ˆìƒ ê¸ˆì•¡ ë¹„ìœ¨</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ìµœê·¼ ê²€ì¦ ëŒ€ê¸° ì œì•ˆì„œ</h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('pending')">ì „ì²´ ë³´ê¸°</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œëª©</th>
                                    <th>ì˜ˆìƒ ì ˆê°ì•¡</th>
                                    <th>ëŒ€ê¸°ì¼ìˆ˜</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="recentPendingList">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                        ê²€ì¦ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ê²€ì¦ ëŒ€ê¸° ì„¹ì…˜ -->
            <div id="pending" class="content-section">
                <div class="page-header">
                    <h1>â° ê²€ì¦ ëŒ€ê¸°</h1>
                    <p>ìœ í˜•íš¨ê³¼ ê²€ì¦ì´ í•„ìš”í•œ ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ê²€ì¦ ëŒ€ê¸° ì œì•ˆì„œ</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadPendingVerifications()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">ì œì•ˆë²ˆí˜¸</th>
                                    <th style="width: 100px;">ì œì•ˆì</th>
                                    <th style="width: 100px;">ë¶€ì„œ</th>
                                    <th>ì œëª©</th>
                                    <th style="width: 120px;">ì˜ˆìƒ ì ˆê°ì•¡</th>
                                    <th style="width: 100px;">ì œì¶œì¼</th>
                                    <th style="width: 80px;">ëŒ€ê¸°ì¼</th>
                                    <th style="width: 120px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="pendingList">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ê²€ì¦ ì™„ë£Œ ì„¹ì…˜ -->
            <div id="completed" class="content-section">
                <div class="page-header">
                    <h1>âœ… ê²€ì¦ ì™„ë£Œ</h1>
                    <p>ê²€ì¦ ì™„ë£Œëœ ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ì œëª©</th>
                                    <th>ì˜ˆìƒ ê¸ˆì•¡</th>
                                    <th>í™•ì • ê¸ˆì•¡</th>
                                    <th>ì¡°ì •ë¥ </th>
                                    <th>ê²€ì¦ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="completedList">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ì „ì²´ ì œì•ˆ ì„¹ì…˜ -->
            <div id="allSuggestions" class="content-section">
                <div class="page-header">
                    <h1>ğŸ“‹ ì „ì²´ ì œì•ˆ</h1>
                    <p>ëª¨ë“  ì‚¬ìš©ìì˜ ì œì•ˆì„œ ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ì œì•ˆë²ˆí˜¸</th>
                                    <th>ì œì•ˆì</th>
                                    <th>ë¶€ì„œ</th>
                                    <th>ì œì•ˆë‚´ìš©</th>
                                    <th>ìƒíƒœ</th>
                                    <th>ì ‘ìˆ˜ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="allSuggestionsList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                        ë¡œë”© ì¤‘...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- í†µê³„ ì„¹ì…˜ -->
            <div id="stats" class="content-section">
                <div class="page-header">
                    <h1>ğŸ“ˆ í†µê³„</h1>
                    <p>ìœ í˜•íš¨ê³¼ ê²€ì¦ í†µê³„ì…ë‹ˆë‹¤</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ì´ ê²€ì¦ ê±´ìˆ˜</h3>
                        <div class="number" id="statsTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  í™•ì • ê¸ˆì•¡</h3>
                        <div class="number" style="color: #28a745; font-size: 24px;" id="statsAvgAmount">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ì¡°ì •ë¥ </h3>
                        <div class="number" style="color: #17a2b8;" id="statsAvgAdjustRate">100%</div>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ì²˜ë¦¬ ì‹œê°„</h3>
                        <div class="number" style="color: #ffc107; font-size: 28px;" id="statsAvgTime">0ì¼</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ë¶€ì„œë³„ ì˜ˆìƒ ê¸ˆì•¡ ì •í™•ë„</h3>
                    </div>
                    <div class="card-body" id="deptStats">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            í†µê³„ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²€ì¦ ëª¨ë‹¬ -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’° ìœ í˜•íš¨ê³¼ ê²€ì¦</h3>
                <button class="close-btn" onclick="closeVerifyModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- ì œì•ˆì„œ ì •ë³´ -->
                <div class="info-box">
                    <strong>ì œì•ˆë²ˆí˜¸:</strong> <span id="modalSugNumber"></span><br>
                    <strong>ì œì•ˆì:</strong> <span id="modalProposer"></span><br>
                    <strong>ë¶€ì„œ:</strong> <span id="modalDepartment"></span><br>
                    <strong>ì œì¶œì¼:</strong> <span id="modalSubmitDate"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">ì œì•ˆ ë‚´ìš©</label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <p id="modalTitle" style="font-weight: 600; margin-bottom: 10px;"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">í˜„í™© ë° ê°œì„  ë‚´ìš©</label>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h4 style="font-size: 14px; margin-bottom: 5px;">ê¸°ì¡´ì‹¤ì‹œë‚´ìš©:</h4>
                        <p id="modalCurrentSituation" style="color: #666; font-size: 14px; white-space: pre-wrap;"></p>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4 style="font-size: 14px; margin-bottom: 5px;">ë³€ê²½(ì‹ ê·œ)ë‚´ìš©:</h4>
                        <p id="modalImprovementPlan" style="color: #666; font-size: 14px; white-space: pre-wrap;"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ì œì•ˆì ì…ë ¥ ì •ë³´</label>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <div><strong>ì˜ˆìƒ ì ˆê° ê¸ˆì•¡:</strong> <span id="modalExpectedSaving" class="highlight"></span> ì›/ë…„</div>
                        <div style="margin-top: 10px;"><strong>ì‚°ì¶œ ê·¼ê±°:</strong></div>
                        <div id="modalSavingBasis" style="margin-top: 5px; color: #666; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <!-- AI ê¸°ì¤€ ìš”ì²­ ì„¹ì…˜ -->
                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e9ecef;">
                <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ¤– AI ìœ í˜•íš¨ê³¼ ê¸°ì¤€ ë¶„ì„</h4>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                        AIê°€ ì œì•ˆì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìœ í˜•íš¨ê³¼ ê²€ì¦ ê¸°ì¤€ì„ ì œì‹œí•©ë‹ˆë‹¤.
                    </p>
                    <button class="btn btn-primary" onclick="openPromptEditor()" id="aiRequestBtn" style="width: 100%;">
                        ğŸ¤– AI ê¸°ì¤€ ìš”ì²­í•˜ê¸°
                    </button>
                </div>

                <div id="aiAnalysisResult" style="display: none; background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #1976d2; margin: 0;">ğŸ’¡ AI ë¶„ì„ ê²°ê³¼</h4>
                        <button class="btn btn-sm" onclick="closeAIAnalysis()" style="background: #fff; color: #666; padding: 4px 8px;">âœ•</button>
                    </div>
                    <div id="aiAnalysisContent" style="color: #333; font-size: 14px; line-height: 1.6; white-space: pre-wrap;"></div>
                </div>

                <!-- ê²€ì¦ ì…ë ¥ -->
                <h4 style="margin-bottom: 20px; color: #667eea;">ğŸ’° ê²€ì¦ ì •ë³´ ì…ë ¥</h4>

                <div class="form-group">
                    <label class="form-label">í™•ì • ê¸ˆì•¡ (ì›/ë…„) *</label>
                    <input type="number" class="form-input" id="verifiedAmount" placeholder="1000000" min="0" required oninput="calculateEffectScore()">
                    <div id="effectScoreDisplay" style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 8px; display: none;">
                        <strong>ìë™ ê³„ì‚°ëœ ìœ í˜•íš¨ê³¼ ì ìˆ˜:</strong> <span id="effectScoreValue" style="font-size: 20px; color: #28a745; font-weight: 600;">0</span>ì 
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ê¸ˆì•¡ ì¡°ì • ì‚¬ìœ  (ì˜ˆìƒ ê¸ˆì•¡ê³¼ ë‹¤ë¥¼ ê²½ìš° í•„ìˆ˜)</label>
                    <textarea class="form-textarea" id="adjustmentReason" placeholder="ì˜ˆìƒ ê¸ˆì•¡ê³¼ í™•ì • ê¸ˆì•¡ì´ ë‹¤ë¥¸ ê²½ìš° ê·¸ ì´ìœ ë¥¼ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ê²€ì¦ ì˜ê²¬</label>
                    <textarea class="form-textarea" id="verificationNote" placeholder="ê²€ì¦ ê³¼ì •ì—ì„œì˜ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeVerifyModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="rejectVerification()">ê²€ì¦ ë¶ˆê°€</button>
                <button class="btn btn-warning" onclick="requestMoreInfo()">ì¶”ê°€ ìë£Œ ìš”ì²­</button>
                <button class="btn btn-success" onclick="completeVerification()">ê²€ì¦ ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì œì•ˆì„œ ìƒì„¸ë³´ê¸°</h3>
                <button class="close-btn" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <!-- Toast ì•Œë¦¼ -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAv0y8cF86kDC-saDZA6K0Q5fZd6dk9H1Y",
            authDomain: "suggestion-system-58def.firebaseapp.com",
            projectId: "suggestion-system-58def",
            storageBucket: "suggestion-system-58def.firebasestorage.app",
            messagingSenderId: "755050605021",
            appId: "1:755050605021:web:befd52c5516c3a3d3e2e34"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firebase ìºì‹± í™œì„±í™” (ì½ê¸° íšŸìˆ˜ ëŒ€í­ ê°ì†Œ)
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open - caching disabled
                } else if (err.code == 'unimplemented') {
                    // Browser doesn't support caching
                }
            });

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentVerifier = null;
        let currentSuggestion = null;

        // ìœ í˜•íš¨ê³¼ ì ìˆ˜ ê¸°ì¤€
        const effectScoreRanges = [
            { min: 0, max: 500000, score: 15 },
            { min: 500001, max: 1000000, score: 20 },
            { min: 1000001, max: 5000000, score: 25 },
            { min: 5000001, max: 10000000, score: 30 },
            { min: 10000001, max: 20000000, score: 35 },
            { min: 20000001, max: 30000000, score: 40 },
            { min: 30000001, max: 40000000, score: 45 },
            { min: 40000001, max: 50000000, score: 50 },
            { min: 50000001, max: Infinity, score: 55 } // ë³„ë„ì‹¬ì‚¬
        ];

        // ì¸ì¦ í™•ì¸
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = user;

            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    auth.signOut();
                    return;
                }

                const userData = userDoc.data();

                // roles ë°°ì—´ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • (ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜)
                if (!userData.roles || userData.roles.length === 0) {
                    const defaultRoles = ['user'];
                    if (userData.role === 'admin') defaultRoles.push('admin');
                    if (userData.isEvaluator) {
                        if (userData.leaderLevel === 1) defaultRoles.push('firstReviewer');
                        else if (userData.leaderLevel === 2) defaultRoles.push('secondReviewer');
                        else if (userData.leaderLevel === 3) defaultRoles.push('thirdReviewer');
                        else defaultRoles.push('firstReviewer');
                    }
                    try {
                        await db.collection('users').doc(user.uid).update({ roles: defaultRoles });
                        userData.roles = defaultRoles;
                    } catch (updateError) {
                        userData.roles = defaultRoles;
                    }
                }

                currentVerifier = userData;

                // ê²€ì¦ë‹´ë‹¹ì ê¶Œí•œ í™•ì¸
                if (!userData.roles.includes('effectVerifier')) {
                    showToast('ìœ í˜•íš¨ê³¼ ê²€ì¦ë‹´ë‹¹ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    return;
                }

                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                document.getElementById('userInfo').innerHTML = `
                    <strong>${userData.displayName}</strong><br>
                    ${userData.department || ''}<br>
                    ìœ í˜•íš¨ê³¼ ê²€ì¦ë‹´ë‹¹ì
                `;

                // ë°ì´í„° ë¡œë“œ
                loadDashboard();
                loadPendingVerifications();
                loadCompletedVerifications();
                loadStats();

            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });

        // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadDashboard() {
            try {
                // ê²€ì¦ ëŒ€ê¸° ê±´ìˆ˜
                const pendingSnapshot = await db.collection('suggestions')
                    .where('hasTypicalEffect', '==', true)
                    .where('effectVerification.status', '==', 'pending')
                    .get();

                const pendingCount = pendingSnapshot.size;
                document.getElementById('statPending').textContent = pendingCount;
                document.getElementById('pendingCount').textContent = pendingCount;

                // ì˜¤ëŠ˜ ê²€ì¦
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todaySnapshot = await db.collection('suggestions')
                    .where('effectVerification.verifierId', '==', currentVerifier.employeeId)
                    .where('effectVerification.verifiedAt', '>=', today)
                    .get();

                document.getElementById('statToday').textContent = todaySnapshot.size;

                // ì´ë²ˆ ë‹¬ ê²€ì¦
                const monthStart = new Date();
                monthStart.setDate(1);
                monthStart.setHours(0, 0, 0, 0);

                const monthSnapshot = await db.collection('suggestions')
                    .where('effectVerification.verifierId', '==', currentVerifier.employeeId)
                    .where('effectVerification.verifiedAt', '>=', monthStart)
                    .get();

                document.getElementById('statMonth').textContent = monthSnapshot.size;

                // í‰ê·  ì¡°ì •ë¥  ê³„ì‚°
                let totalAdjustRate = 0;
                let count = 0;
                monthSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.effectVerification && data.effectVerification.originalAmount > 0) {
                        const rate = (data.effectVerification.verifiedAmount / data.effectVerification.originalAmount) * 100;
                        totalAdjustRate += rate;
                        count++;
                    }
                });

                const avgRate = count > 0 ? Math.round(totalAdjustRate / count) : 100;
                document.getElementById('statAdjustRate').textContent = avgRate + '%';

                // ìµœê·¼ ê²€ì¦ ëŒ€ê¸° ì œì•ˆì„œ (ìµœëŒ€ 5ê°œ)
                const recentDocs = pendingSnapshot.docs.slice(0, 5);
                displayRecentPending(recentDocs);

            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìµœê·¼ ê²€ì¦ ëŒ€ê¸° ì œì•ˆì„œ í‘œì‹œ
        function displayRecentPending(docs) {
            const tbody = document.getElementById('recentPendingList');

            if (docs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            ê²€ì¦ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = docs.map(doc => {
                const data = doc.data();
                const waitDays = calculateWaitDays(data.createdAt);
                return `
                    <tr>
                        <td>${data.suggestionNumber}</td>
                        <td>${data.proposer}</td>
                        <td>${data.title}</td>
                        <td style="text-align: right; font-weight: 600; color: #28a745;">
                            ${formatNumber(data.expectedSaving)}ì›
                        </td>
                        <td>${waitDays}ì¼</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openVerifyModal('${doc.id}')">
                                ê²€ì¦í•˜ê¸°
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ê²€ì¦ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ
        async function loadPendingVerifications() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('hasTypicalEffect', '==', true)
                    .where('effectVerification.status', '==', 'pending')
                    .get();

                const tbody = document.getElementById('pendingList');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                ê²€ì¦ ëŒ€ê¸° ì¤‘ì¸ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeA - timeB; // ì˜¤ë˜ëœ ìˆœ
                });

                tbody.innerHTML = sortedDocs.map(doc => {
                    const data = doc.data();
                    const waitDays = calculateWaitDays(data.createdAt);
                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.department}</td>
                            <td><strong>${data.title}</strong></td>
                            <td style="text-align: right; font-weight: 600; color: #28a745;">
                                ${formatNumber(data.expectedSaving)}
                            </td>
                            <td>${formatDate(data.createdAt)}</td>
                            <td style="text-align: center;">
                                <span class="${waitDays > 3 ? 'status-rejected' : 'status-pending'}">${waitDays}ì¼</span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="openVerifyModal('${doc.id}')">
                                    ê²€ì¦í•˜ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ê²€ì¦ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€ì¦ ì™„ë£Œ ëª©ë¡ ë¡œë“œ
        async function loadCompletedVerifications() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('effectVerification.verifierId', '==', currentVerifier.employeeId)
                    .where('effectVerification.status', '==', 'completed')
                    .get();

                const tbody = document.getElementById('completedList');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                ê²€ì¦ ì™„ë£Œëœ ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ (ìµœì‹ ìˆœ, 50ê°œ)
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().effectVerification?.verifiedAt?.toDate?.() || new Date(0);
                    const timeB = b.data().effectVerification?.verifiedAt?.toDate?.() || new Date(0);
                    return timeB - timeA; // ìµœì‹ ìˆœ
                }).slice(0, 50);

                tbody.innerHTML = sortedDocs.map(doc => {
                    const data = doc.data();
                    const verification = data.effectVerification;
                    const adjustRate = verification.originalAmount > 0
                        ? Math.round((verification.verifiedAmount / verification.originalAmount) * 100)
                        : 100;

                    return `
                        <tr>
                            <td>${data.suggestionNumber}</td>
                            <td>${data.proposer}</td>
                            <td>${data.title}</td>
                            <td style="text-align: right;">
                                ${formatNumber(verification.originalAmount)}ì›
                            </td>
                            <td style="text-align: right; font-weight: 600; color: #28a745;">
                                ${formatNumber(verification.verifiedAmount)}ì›
                            </td>
                            <td style="text-align: center;">
                                <span class="status-${adjustRate >= 80 ? 'completed' : 'rejected'}">${adjustRate}%</span>
                            </td>
                            <td>${formatDate(verification.verifiedAt)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewVerification('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ê²€ì¦ ì™„ë£Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì „ì²´ ì œì•ˆ ë¡œë“œ
        async function loadAllSuggestions() {
            try {

                // ëª¨ë“  ì‚¬ìš©ìì˜ ì œì•ˆ ì¡°íšŒ (orderBy ì œê±°í•˜ì—¬ ê¶Œí•œ ë¬¸ì œ í•´ê²°)
                const snapshot = await db.collection('suggestions')
                    .limit(1000)
                    .get();

                const tbody = document.getElementById('allSuggestionsList');

                if (snapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ì œì•ˆì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    `;
                    return;
                }

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ (ìµœì‹ ìˆœ)
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate?.() || new Date(0);
                    const timeB = b.data().createdAt?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });

                tbody.innerHTML = sortedDocs.map(doc => {
                    const data = doc.data();
                    const statusText = {
                        'draft': 'ì„ì‹œì €ì¥',
                        'pending': 'ê²°ì¬ëŒ€ê¸°',
                        'reviewing': 'ê²€í† ì¤‘',
                        'approved': 'ìŠ¹ì¸',
                        'rejected': 'ë°˜ë ¤'
                    }[data.status] || data.status;

                    const statusClass = {
                        'draft': 'badge-secondary',
                        'pending': 'badge-warning',
                        'reviewing': 'badge-info',
                        'approved': 'badge-success',
                        'rejected': 'badge-danger'
                    }[data.status] || 'badge-secondary';

                    return `
                        <tr>
                            <td>${data.suggestionNumber || '-'}</td>
                            <td>${data.proposer || '-'}</td>
                            <td>${data.department || '-'}</td>
                            <td>${data.title || '-'}</td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${formatDate(data.createdAt)}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSuggestion('${doc.id}')">
                                    ìƒì„¸ë³´ê¸°
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('ì „ì²´ ì œì•ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const tbody = document.getElementById('allSuggestionsList');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            ì „ì²´ ì œì•ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const snapshot = await db.collection('suggestions')
                    .where('effectVerification.verifierId', '==', currentVerifier.employeeId)
                    .where('effectVerification.status', '==', 'completed')
                    .get();

                const total = snapshot.size;
                let totalAmount = 0;
                let totalAdjustRate = 0;
                let totalProcessTime = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const verification = data.effectVerification;

                    totalAmount += verification.verifiedAmount || 0;

                    if (verification.originalAmount > 0) {
                        totalAdjustRate += (verification.verifiedAmount / verification.originalAmount) * 100;
                    }

                    // ì²˜ë¦¬ ì‹œê°„ ê³„ì‚° (ì œì¶œì¼ ~ ê²€ì¦ì¼)
                    if (data.createdAt && verification.verifiedAt) {
                        const submitDate = data.createdAt.toDate();
                        const verifyDate = verification.verifiedAt.toDate();
                        const diffDays = Math.floor((verifyDate - submitDate) / (1000 * 60 * 60 * 24));
                        totalProcessTime += diffDays;
                    }
                });

                document.getElementById('statsTotal').textContent = total;
                document.getElementById('statsAvgAmount').textContent =
                    total > 0 ? formatNumber(Math.round(totalAmount / total)) + 'ì›' : '0ì›';
                document.getElementById('statsAvgAdjustRate').textContent =
                    total > 0 ? Math.round(totalAdjustRate / total) + '%' : '100%';
                document.getElementById('statsAvgTime').textContent =
                    total > 0 ? Math.round(totalProcessTime / total) + 'ì¼' : '0ì¼';

            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ê²€ì¦ ëª¨ë‹¬ ì—´ê¸°
        async function openVerifyModal(suggestionId) {
            try {
                const doc = await db.collection('suggestions').doc(suggestionId).get();
                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = doc.data();
                currentSuggestion = { id: suggestionId, ...data };

                // ëª¨ë‹¬ì— ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('modalSugNumber').textContent = data.suggestionNumber;
                document.getElementById('modalProposer').textContent = `${data.proposer} (${data.department})`;
                document.getElementById('modalDepartment').textContent = data.department;
                document.getElementById('modalSubmitDate').textContent = formatDate(data.createdAt);
                document.getElementById('modalTitle').textContent = data.title;
                document.getElementById('modalCurrentSituation').textContent = data.currentSituation;
                document.getElementById('modalImprovementPlan').textContent = data.improvementPlan;
                document.getElementById('modalExpectedSaving').textContent = formatNumber(data.expectedSaving);
                document.getElementById('modalSavingBasis').textContent = data.savingBasis || '(ì‚°ì¶œ ê·¼ê±° ì—†ìŒ)';

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('verifiedAmount').value = '';
                document.getElementById('adjustmentReason').value = '';
                document.getElementById('verificationNote').value = '';
                document.getElementById('effectScoreDisplay').style.display = 'none';

                // AI ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
                document.getElementById('aiAnalysisResult').style.display = 'none';
                document.getElementById('aiAnalysisContent').textContent = '';

                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('verifyModal').classList.add('show');

            } catch (error) {
                console.error('ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeVerifyModal() {
            document.getElementById('verifyModal').classList.remove('show');
            currentSuggestion = null;

            // AI ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
            document.getElementById('aiAnalysisResult').style.display = 'none';
            document.getElementById('aiAnalysisContent').textContent = '';

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('verifiedAmount').value = '';
            document.getElementById('adjustmentReason').value = '';
            document.getElementById('verificationNote').value = '';
            document.getElementById('effectScoreDisplay').style.display = 'none';
        }

        // ìœ í˜•íš¨ê³¼ ì ìˆ˜ ìë™ ê³„ì‚°
        function calculateEffectScore() {
            const amount = parseInt(document.getElementById('verifiedAmount').value) || 0;

            if (amount === 0) {
                document.getElementById('effectScoreDisplay').style.display = 'none';
                return;
            }

            let score = 0;
            for (let range of effectScoreRanges) {
                if (amount >= range.min && amount <= range.max) {
                    score = range.score;
                    break;
                }
            }

            document.getElementById('effectScoreValue').textContent = score;
            document.getElementById('effectScoreDisplay').style.display = 'block';
        }

        // ê²€ì¦ ì™„ë£Œ ì²˜ë¦¬
        async function completeVerification() {
            const verifiedAmount = parseInt(document.getElementById('verifiedAmount').value);
            const adjustmentReason = document.getElementById('adjustmentReason').value;
            const verificationNote = document.getElementById('verificationNote').value;

            if (!verifiedAmount && verifiedAmount !== 0) {
                showToast('í™•ì • ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì˜ˆìƒ ê¸ˆì•¡ê³¼ ë‹¤ë¥¼ ê²½ìš° ì¡°ì • ì‚¬ìœ  í•„ìˆ˜
            const originalAmount = currentSuggestion.expectedSaving || 0;
            if (Math.abs(verifiedAmount - originalAmount) > originalAmount * 0.1 && !adjustmentReason) {
                showToast('ê¸ˆì•¡ ì¡°ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆìƒ ê¸ˆì•¡ê³¼ 10% ì´ìƒ ì°¨ì´)', 'error');
                return;
            }

            if (!confirm('ê²€ì¦ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì™„ë£Œ í›„ ì œì•ˆì„œëŠ” í‰ê°€ ë‹¨ê³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.')) return;

            try {
                // ìœ í˜•íš¨ê³¼ ì ìˆ˜ ê³„ì‚°
                let effectScore = 0;
                for (let range of effectScoreRanges) {
                    if (verifiedAmount >= range.min && verifiedAmount <= range.max) {
                        effectScore = range.score;
                        break;
                    }
                }

                const verification = {
                    needsVerification: true,
                    status: 'completed',
                    originalAmount: originalAmount,
                    verifiedAmount: verifiedAmount,
                    typicalEffectScore: effectScore,
                    verificationNote: verificationNote,
                    adjustmentReason: adjustmentReason,
                    verifierId: currentVerifier.employeeId,
                    verifierName: currentVerifier.displayName,
                    verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // ê²°ì¬ì„ ì—ì„œ ì²« ë²ˆì§¸ í‰ê°€ì(ì†Œìœ„ì›íšŒ) ì¡°íšŒ
                const approvalLineDoc = await db.collection('approvalLines')
                    .doc(currentSuggestion.approvalLineId).get();

                if (!approvalLineDoc.exists) {
                    throw new Error('ê²°ì¬ì„  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const approvers = approvalLineDoc.data().approvers || [];
                const firstApprover = approvers.find(a => a.level === 1);

                if (!firstApprover) {
                    throw new Error('ì²« ë²ˆì§¸ í‰ê°€ì(ì†Œìœ„ì›íšŒ)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // ê²€ì¦ ì™„ë£Œ í›„ ì†Œìœ„ì›íšŒ(1ë‹¨ê³„)ë¡œ ì „ë‹¬
                await db.collection('suggestions').doc(currentSuggestion.id).update({
                    effectVerification: verification,
                    currentApproverId: firstApprover.id,
                    stage: 1,
                    status: 'pending',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: currentSuggestion.userId,
                    title: 'ìœ í˜•íš¨ê³¼ ê²€ì¦ ì™„ë£Œ',
                    message: `${currentSuggestion.suggestionNumber} ì œì•ˆì„œì˜ ìœ í˜•íš¨ê³¼ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì • ê¸ˆì•¡: ${formatNumber(verifiedAmount)}ì›/ë…„`,
                    type: 'verification',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í‰ê°€ ë‹¨ê³„ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.', 'success');
                closeVerifyModal();

                // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                loadDashboard();
                loadPendingVerifications();
                loadCompletedVerifications();
                loadStats();

            } catch (error) {
                console.error('ê²€ì¦ ì™„ë£Œ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ê²€ì¦ ë¶ˆê°€ ì²˜ë¦¬
        async function rejectVerification() {
            const reason = document.getElementById('adjustmentReason').value;

            if (!reason) {
                showToast('ê²€ì¦ ë¶ˆê°€ ì‚¬ìœ ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ê²€ì¦ ë¶ˆê°€ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì œì•ˆì„œëŠ” ì œì•ˆìì—ê²Œ ë°˜ë ¤ë©ë‹ˆë‹¤.')) return;

            try {
                const verification = {
                    needsVerification: true,
                    status: 'rejected',
                    originalAmount: currentSuggestion.expectedSaving || 0,
                    verifiedAmount: 0,
                    typicalEffectScore: 0,
                    verificationNote: reason,
                    verifierId: currentVerifier.employeeId,
                    verifierName: currentVerifier.displayName,
                    verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('suggestions').doc(currentSuggestion.id).update({
                    effectVerification: verification,
                    status: 'rejected',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: currentSuggestion.userId,
                    title: 'ìœ í˜•íš¨ê³¼ ê²€ì¦ ë¶ˆê°€',
                    message: `${currentSuggestion.suggestionNumber} ì œì•ˆì„œê°€ ê²€ì¦ ë¶ˆê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
                    type: 'verification',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ê²€ì¦ ë¶ˆê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                closeVerifyModal();

                // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                loadDashboard();
                loadPendingVerifications();

            } catch (error) {
                console.error('ê²€ì¦ ë¶ˆê°€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì¶”ê°€ ìë£Œ ìš”ì²­
        async function requestMoreInfo() {
            const reason = document.getElementById('verificationNote').value;

            if (!reason) {
                showToast('ì¶”ê°€ ìë£Œ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ì¶”ê°€ ìë£Œë¥¼ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                // ì•Œë¦¼ ìƒì„±
                await db.collection('notifications').add({
                    userId: currentSuggestion.userId,
                    title: 'ìœ í˜•íš¨ê³¼ ê²€ì¦ - ì¶”ê°€ ìë£Œ ìš”ì²­',
                    message: `${currentSuggestion.suggestionNumber}: ${reason}`,
                    type: 'verification',
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ì¶”ê°€ ìë£Œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                closeVerifyModal();

            } catch (error) {
                console.error('ì¶”ê°€ ìë£Œ ìš”ì²­ ì˜¤ë¥˜:', error);
                showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€ì¦ ë‚´ì—­ ìƒì„¸ë³´ê¸°
        async function viewVerification(suggestionId) {
            await openVerifyModal(suggestionId);

            // ê¸°ì¡´ ê²€ì¦ ë°ì´í„° ë¡œë“œ
            const doc = await db.collection('suggestions').doc(suggestionId).get();
            const data = doc.data();

            if (data.effectVerification) {
                document.getElementById('verifiedAmount').value = data.effectVerification.verifiedAmount || '';
                document.getElementById('adjustmentReason').value = data.effectVerification.adjustmentReason || '';
                document.getElementById('verificationNote').value = data.effectVerification.verificationNote || '';

                if (data.effectVerification.verifiedAmount) {
                    calculateEffectScore();
                }
            }

            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
            const isAdmin = currentVerifier.roles && currentVerifier.roles.includes('admin');

            if (isAdmin) {
                // ê´€ë¦¬ìëŠ” ìˆ˜ì • ê°€ëŠ¥
                document.getElementById('verifiedAmount').disabled = false;
                document.getElementById('adjustmentReason').disabled = false;
                document.getElementById('verificationNote').disabled = false;
                document.querySelector('.modal-footer').innerHTML = `
                    <button class="btn btn-secondary" onclick="closeVerifyModal()">ë‹«ê¸°</button>
                    <button class="btn btn-success" onclick="updateVerification('${suggestionId}')">ìˆ˜ì • ì €ì¥</button>
                `;
            } else {
                // ì¼ë°˜ ê²€ì¦ìëŠ” ì½ê¸°ë§Œ ê°€ëŠ¥
                document.getElementById('verifiedAmount').disabled = true;
                document.getElementById('adjustmentReason').disabled = true;
                document.getElementById('verificationNote').disabled = true;
                document.querySelector('.modal-footer').innerHTML = `
                    <button class="btn btn-secondary" onclick="closeVerifyModal()">ë‹«ê¸°</button>
                `;
            }
        }

        // ê²€ì¦ ì •ë³´ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)
        async function updateVerification(suggestionId) {
            const verifiedAmount = parseInt(document.getElementById('verifiedAmount').value);
            const adjustmentReason = document.getElementById('adjustmentReason').value;
            const verificationNote = document.getElementById('verificationNote').value;

            if (!verifiedAmount && verifiedAmount !== 0) {
                showToast('í™•ì • ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ê²€ì¦ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                // ìœ í˜•íš¨ê³¼ ì ìˆ˜ ì¬ê³„ì‚°
                let effectScore = 0;
                for (let range of effectScoreRanges) {
                    if (verifiedAmount >= range.min && verifiedAmount <= range.max) {
                        effectScore = range.score;
                        break;
                    }
                }

                const doc = await db.collection('suggestions').doc(suggestionId).get();
                const existingVerification = doc.data().effectVerification || {};

                const updatedVerification = {
                    ...existingVerification,
                    verifiedAmount: verifiedAmount,
                    typicalEffectScore: effectScore,
                    adjustmentReason: adjustmentReason,
                    verificationNote: verificationNote,
                    lastModifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModifiedBy: currentVerifier.displayName
                };

                await db.collection('suggestions').doc(suggestionId).update({
                    effectVerification: updatedVerification,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('ê²€ì¦ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                closeVerifyModal();

                // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                loadDashboard();
                loadCompletedVerifications();

            } catch (error) {
                console.error('ê²€ì¦ ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                showToast('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ko-KR');
        }

        function formatNumber(num) {
            if (!num && num !== 0) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function calculateWaitDays(timestamp) {
            if (!timestamp) return 0;
            const submitDate = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const today = new Date();
            return Math.floor((today - submitDate) / (1000 * 60 * 60 * 24));
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ
            if (sectionId === 'allSuggestions') {
                loadAllSuggestions();
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ì œì•ˆì„œ ìƒì„¸ë³´ê¸° (ì½ê¸° ì „ìš©)
        async function viewSuggestion(suggestionId) {

            try {
                // Firestoreì—ì„œ ì œì•ˆì„œ ì¡°íšŒ
                const doc = await db.collection('suggestions').doc(suggestionId).get();

                if (!doc.exists) {
                    showToast('ì œì•ˆì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const s = { id: doc.id, ...doc.data() };

                const detailHtml = `
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <strong>ì œì•ˆë²ˆí˜¸:</strong> ${s.suggestionNumber || s.id.substring(0, 8)}<br>
                                <strong>ì œì•ˆì:</strong> ${s.proposer}<br>
                                <strong>ì œì•ˆë¶€ì„œ:</strong> ${s.department}<br>
                                <strong>ì ‘ìˆ˜ì¼:</strong> ${formatDate(s.createdAt)}
                            </div>
                            <div>
                                <strong>ì¹´í…Œê³ ë¦¬:</strong> ${s.category || '-'}<br>
                                <strong>ìš°ì„ ìˆœìœ„:</strong> ${s.priority || '-'}<br>
                                <strong>ì‹¤ì‹œì:</strong> ${s.implementor || '-'}<br>
                                <strong>ì‹¤ì‹œë¶€ì„œ:</strong> ${s.implementDept || '-'}
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ì œì•ˆ ë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">${s.title}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ê¸°ì¡´ì‹¤ì‹œë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.currentSituation || '-'}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ë³€ê²½(ì‹ ê·œ)ë‚´ìš©</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap;">${s.improvementPlan || '-'}</div>
                        </div>

                        ${s.hasTypicalEffect ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">ìœ í˜•íš¨ê³¼</h4>
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                                    <div><strong>ì˜ˆìƒ ì ˆê°ì•¡:</strong> ${formatNumber(s.expectedSaving)}ì›/ë…„</div>
                                    ${s.effectVerification && s.effectVerification.verifiedAmount ?
                                        `<div><strong>í™•ì • ê¸ˆì•¡:</strong> ${formatNumber(s.effectVerification.verifiedAmount)}ì›/ë…„</div>
                                         <div><strong>ê²€ì¦ì:</strong> ${s.effectVerification.verifierName || '-'}</div>
                                         <div><strong>ê²€ì¦ì¼:</strong> ${formatDate(s.effectVerification.verifiedAt)}</div>`
                                        : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">ìì²´í‰ê°€</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div><strong>ë…¸ë ¥ë„:</strong> ${s.scores?.self?.effort || 0}ì </div>
                                <div><strong>ì°½ì˜ì„±:</strong> ${s.scores?.self?.creativity || 0}ì </div>
                                <div><strong>ìœ ë¬´í˜•íš¨ê³¼:</strong> ${s.scores?.self?.effect || 0}ì </div>
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6;">
                                    <strong>ì´ì :</strong> ${s.scores?.self?.total || 0}ì 
                                    <strong style="margin-left: 20px;">ë“±ê¸‰:</strong> ${s.scores?.self?.grade || '-'}
                                </div>
                            </div>
                        </div>

                        ${s.contributors && s.contributors.length > 0 ? `
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">ì°¸ì—¬ì ê¸°ì—¬ë„</h4>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ì´ë¦„</th>
                                            <th>ì—­í• </th>
                                            <th>ê¸°ì—¬ë„</th>
                                            <th>ë¶€ì„œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${s.contributors.map(c => `
                                            <tr>
                                                <td>${c.name}</td>
                                                <td>${c.role}</td>
                                                <td>${c.pct}%</td>
                                                <td>${c.department}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;

                document.getElementById('detailContent').innerHTML = detailHtml;
                document.getElementById('detailModal').classList.add('show');

            } catch (error) {
                console.error('ìƒì„¸ë³´ê¸° ì˜¤ë¥˜:', error);
                showToast('ì œì•ˆì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    showToast('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        }

        // AI ë¶„ì„ ìš”ì²­ (Netlify Function ì‚¬ìš©)
        async function requestAIAnalysis() {
            if (!currentSuggestion) {
                showToast('ì œì•ˆì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const btn = document.getElementById('aiRequestBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ¤– AI ë¶„ì„ ì¤‘...';

            try {
                // Netlify Function í˜¸ì¶œ
                const response = await fetch('/.netlify/functions/openai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        suggestionData: {
                            title: currentSuggestion.title,
                            proposer: currentSuggestion.proposer,
                            department: currentSuggestion.department,
                            currentSituation: currentSuggestion.currentSituation,
                            improvementPlan: currentSuggestion.improvementPlan,
                            expectedSaving: formatNumber(currentSuggestion.expectedSaving),
                            savingBasis: currentSuggestion.savingBasis || 'ì œê³µë˜ì§€ ì•ŠìŒ'
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'API ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'AI ë¶„ì„ ì‹¤íŒ¨');
                }

                // AI ì‘ë‹µ í‘œì‹œ
                document.getElementById('aiAnalysisContent').textContent = data.analysis;
                document.getElementById('aiAnalysisResult').style.display = 'block';

                showToast('AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                showToast('AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // AI ë¶„ì„ ê²°ê³¼ ë‹«ê¸°
        function closeAIAnalysis() {
            document.getElementById('aiAnalysisResult').style.display = 'none';
        }

        // ê¸°ë³¸ AI í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
        function getDefaultPrompt() {
            return `[ì—­í• ]
ë„ˆëŠ” ì œì•½íšŒì‚¬ ì œì•ˆì œë„ 'ìœ í˜•íš¨ê³¼ ê¸ˆì•¡ ê²€ì¦ ë‹´ë‹¹ì'ë¡œì„œ ì œì•ˆìì˜ ì ˆê°ì•¡ ì‚°ì •ì˜ íƒ€ë‹¹ì„±ì„ ì—„ê²©íˆ í‰ê°€í•œë‹¤.

[ì…ë ¥ ì •ë³´]
- ì œì•ˆ ì œëª©: {title}
- ì œì•ˆì: {proposer} ({department})
- ê¸°ì¡´ ë‚´ìš©: {currentSituation}
- ê°œì„  ë‚´ìš©: {improvementPlan}
- ì˜ˆìƒ ì ˆê°ì•¡: {expectedSaving}ì›/ë…„
- ì‚°ì¶œ ê·¼ê±°: {savingBasis}

[í‰ê°€ ê¸°ì¤€]
1) ì œì•ˆìê°€ ì‚¬ìš©í•œ ê°€ì •(ë¬¼ëŸ‰Â·ë‹¨ê°€Â·íš¨ìœ¨Â·ì ìš©ë²”ìœ„Â·ê¸°ê°„)ì´ í˜„ì‹¤ì ì´ê³  ê²€ì¦ ê°€ëŠ¥í•œì§€ ì ê²€í•œë‹¤.
2) ì ˆê° êµ¬ì¡°(ì ˆê°í•­ëª© â†’ ë‹¨ê°€ â†’ ë¬¼ëŸ‰ â†’ ì ìš©ê¸°ê°„)ì˜ ë…¼ë¦¬ ì—°ê²°ì„±ì„ í™•ì¸í•œë‹¤.
3) ì •ë³´ ë¶€ì¡±Â·ì¶”ì •ì¹˜ ê³¼ë‹¤Â·100% ì ìš© ê°€ì •Â·ì¶”ê°€ë¹„ìš© ëˆ„ë½ ë“±ì´ ìˆëŠ”ì§€ ê²€í† í•œë‹¤.
4) ë¶ˆëª…í™•í•œ ë¶€ë¶„ì´ ìˆìœ¼ë©´ "ì¶”ê°€ í™•ì¸ í•„ìš”"ë¡œ ë¶„ë¥˜í•œë‹¤.

[ì¶œë ¥ í˜•ì‹]

â‘  ì˜ˆìƒ ì ˆê°ì•¡ íƒ€ë‹¹ì„±
- ì œì‹œ ê¸ˆì•¡: {expectedSaving}ì›/ë…„
- í•µì‹¬ ê°€ì • ìš”ì•½
- ê°€ì •ì˜ í˜„ì‹¤ì„±: (í˜„ì‹¤ì  / ë‹¤ì†Œ ê³¼ëŒ€ / ê³¼ëŒ€ / íŒë‹¨ ê³¤ë€)
- ì ˆê° êµ¬ì¡°ì˜ ë…¼ë¦¬ì„± í‰ê°€

â‘¡ ê¸ˆì•¡ ì‚°ì • ì‹œ í•„ìˆ˜ í™•ì¸ ìš”ì†Œ
- ì ˆê° ëŒ€ìƒ í•­ëª©ì˜ íƒ€ë‹¹ì„±
- ë¬¼ëŸ‰ ê°€ì • ì í•©ì„±(ì‹¤ì Â·í‰ê· ê³¼ì˜ ì°¨ì´)
- ë‹¨ê°€ ê·¼ê±°ì˜ ì‹ ë¢°ì„±
- ì ìš©ë²”ìœ„(ì „ì²´/ì¼ë¶€) ë° ì ìš©ë¥  ê²€ì¦
- 1ë…„ í™˜ì‚°ì˜ ì ì •ì„±(ì§€ì†íš¨ê³¼ì¸ì§€Â·ì¼ì‹œíš¨ê³¼ì¸ì§€)
- ì¶”ê°€ë¹„ìš©(ì„¤ë¹„Â·ì‹œí—˜Â·ì¸ë ¥ ë“±) ë°œìƒ ì—¬ë¶€

â‘¢ ì ì • í™•ì • ê¸ˆì•¡(ë²”ìœ„ ì œì•ˆ)
- ì œì•ˆ ëŒ€ë¹„ í‰ê°€:
  [ ] ì ì •  [ ] ë‹¤ì†Œ ê³¼ëŒ€  [ ] ê³¼ëŒ€  [ ] ê·¼ê±° ë¶€ì¡±
- ì ì • ë²”ìœ„: "ì•½ â—‹â—‹ë§Œì›~â—‹â—‹ë§Œì›/ë…„"
- ì¡°ì • ë¹„ìœ¨ ì œì•ˆ: "ì œì•ˆì•¡ì˜ ì•½ â—‹â—‹% ìˆ˜ì¤€ì´ ì ì ˆ"

â‘£ ê¸°ì¤€ ë¶€í•©ë„(5ì  ì²™ë„)
- ê·¼ê±° ëª…í™•ì„±: â—‹/5
- ê°€ì • í˜„ì‹¤ì„±: â—‹/5
- ì›ê°€ êµ¬ì¡° ë°˜ì˜: â—‹/5
- ì ìš©ë²”ìœ„Â·ê¸°ê°„ íƒ€ë‹¹ì„±: â—‹/5
- ì¶”ê°€ë¹„ìš© ë°˜ì˜: â—‹/5
- ì´í‰: ì œì•ˆì´ íšŒì‚¬ ê¸°ì¤€ì— (ì˜ ë¶€í•© / ë¶€ë¶„ ë¶€í•© / ë‚®ì€ ë¶€í•©)

â‘¤ ì¶”ê°€ í™•ì¸ í•„ìš” í•­ëª©
- í•„ìš” ë°ì´í„° ë˜ëŠ” ì¦ë¹™(ë¬¼ëŸ‰Â·ë‹¨ê°€Â·ì ìš©ë²”ìœ„Â·ì¶”ê°€ë¹„ìš© ë“±)

â‘¥ ìµœì¢… ê²°ë¡ 
- "ë³¸ ì œì•ˆì˜ ì ˆê°ì•¡ {expectedSaving}ì›/ë…„ì€ [í‰ê°€ ê²°ê³¼]ì´ë©°, í™•ì • ê¸ˆì•¡ì€ 'ì•½ â—‹â—‹ë§Œì›/ë…„' ìˆ˜ì¤€ì´ ì ì ˆí•¨."
- í•„ìš” ì‹œ "ì¶”ê°€ í™•ì¸ í›„ í™•ì • ìš”ë§" ëª…ì‹œ`;
        }

        // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
        function getSavedPrompt() {
            return localStorage.getItem('aiPromptTemplate') || getDefaultPrompt();
        }

        // í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
        function openPromptEditor() {
            const modal = document.getElementById('promptEditorModal');
            const textarea = document.getElementById('promptTemplate');
            textarea.value = getSavedPrompt();
            modal.style.display = 'flex';
        }

        // í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ ë‹«ê¸°
        function closePromptEditor() {
            document.getElementById('promptEditorModal').style.display = 'none';
        }

        // í”„ë¡¬í”„íŠ¸ ê¸°ë³¸ê°’ ë³µì›
        function resetPrompt() {
            if (confirm('í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('promptTemplate').value = getDefaultPrompt();
            }
        }

        // í”„ë¡¬í”„íŠ¸ ì €ì¥ ë° AI ë¶„ì„ ìš”ì²­
        async function saveAndRequestAI() {
            const promptTemplate = document.getElementById('promptTemplate').value;

            if (!promptTemplate.trim()) {
                showToast('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // localStorageì— ì €ì¥
            localStorage.setItem('aiPromptTemplate', promptTemplate);
            closePromptEditor();

            // AI ë¶„ì„ ìš”ì²­
            await requestAIAnalysisWithPrompt(promptTemplate);
        }

        // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ë¡œ AI ë¶„ì„ ìš”ì²­
        async function requestAIAnalysisWithPrompt(promptTemplate) {
            if (!currentSuggestion) {
                showToast('ì œì•ˆì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const btn = document.getElementById('aiRequestBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ¤– AI ë¶„ì„ ì¤‘...';

            try {

                // í”„ë¡¬í”„íŠ¸ì˜ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜ (ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
                const customPrompt = promptTemplate
                    .replace(/{title}/g, currentSuggestion.title || 'ì œëª© ì—†ìŒ')
                    .replace(/{proposer}/g, currentSuggestion.proposer || 'ì œì•ˆì ì •ë³´ ì—†ìŒ')
                    .replace(/{department}/g, currentSuggestion.department || 'ë¶€ì„œ ì •ë³´ ì—†ìŒ')
                    .replace(/{currentSituation}/g, currentSuggestion.currentSituation || 'ê¸°ì¡´ ë‚´ìš© ì—†ìŒ')
                    .replace(/{improvementPlan}/g, currentSuggestion.improvementPlan || 'ê°œì„  ë‚´ìš© ì—†ìŒ')
                    .replace(/{expectedSaving}/g, currentSuggestion.expectedSaving ? formatNumber(currentSuggestion.expectedSaving) : '0')
                    .replace(/{savingBasis}/g, currentSuggestion.savingBasis || 'ì‚°ì¶œ ê·¼ê±° ì œê³µë˜ì§€ ì•ŠìŒ');


                // Netlify Function í˜¸ì¶œ
                const response = await fetch('/.netlify/functions/openai-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customPrompt: customPrompt
                    })
                });

                // ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
                const responseText = await response.text();

                // ë¹ˆ ì‘ë‹µ ì²´í¬
                if (!responseText || responseText.trim() === '') {
                    throw new Error('API ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Netlify Functionsê°€ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                // JSON íŒŒì‹± ì‹œë„
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
                    console.error('ì‘ë‹µ ë‚´ìš©:', responseText);
                    throw new Error('ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‘ë‹µ: ' + responseText.substring(0, 100));
                }

                // HTTP ì—ëŸ¬ ì²´í¬
                if (!response.ok) {
                    throw new Error(data.error || `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: ${response.status})`);
                }

                // AI ë¶„ì„ ê²°ê³¼ ì²´í¬
                if (!data.success) {
                    throw new Error(data.error || 'AI ë¶„ì„ ì‹¤íŒ¨');
                }

                if (!data.analysis) {
                    throw new Error('AI ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }

                // AI ì‘ë‹µ í‘œì‹œ
                document.getElementById('aiAnalysisContent').textContent = data.analysis;
                document.getElementById('aiAnalysisResult').style.display = 'block';

                showToast('AI ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                showToast('AI ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>

    <!-- í”„ë¡¬í”„íŠ¸ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="promptEditorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #667eea; margin: 0;">âœï¸ AI í”„ë¡¬í”„íŠ¸ í¸ì§‘</h3>
                <button onclick="closePromptEditor()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>ğŸ“Œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</strong>
                <div style="margin-top: 10px; font-family: monospace; font-size: 13px; color: #666;">
                    <div>{title} - ì œì•ˆ ì œëª©</div>
                    <div>{proposer} - ì œì•ˆì ì´ë¦„</div>
                    <div>{department} - ë¶€ì„œëª…</div>
                    <div>{currentSituation} - ê¸°ì¡´ ì‹¤ì‹œ ë‚´ìš©</div>
                    <div>{improvementPlan} - ë³€ê²½(ì‹ ê·œ) ë‚´ìš©</div>
                    <div>{expectedSaving} - ì˜ˆìƒ ì ˆê°ì•¡</div>
                    <div>{savingBasis} - ì‚°ì¶œ ê·¼ê±°</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</label>
                <textarea id="promptTemplate" style="width: 100%; min-height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="resetPrompt()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ğŸ”„ ê¸°ë³¸ê°’ ë³µì›
                </button>
                <button onclick="closePromptEditor()" style="padding: 10px 20px; background: #e9ecef; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ì·¨ì†Œ
                </button>
                <button onclick="saveAndRequestAI()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    ğŸ’¾ ì €ì¥í•˜ê³  AI ë¶„ì„ ìš”ì²­
                </button>
            </div>
        </div>
    </div>

</body>
</html>
