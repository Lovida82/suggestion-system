<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì£¼ì•½í’ˆ ì œì•ˆì œë„ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(45, 212, 191, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            overflow: hidden;
            max-width: 1100px;
            width: 100%;
            display: flex;
            position: relative;
            z-index: 1;
        }

        .left-panel {
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
            padding: 60px 50px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .left-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 15s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-30px, -30px) rotate(180deg); }
        }

        .left-panel h1 {
            font-size: 36px;
            margin-bottom: 20px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .left-panel p {
            font-size: 17px;
            line-height: 1.7;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .features {
            margin-top: 50px;
            position: relative;
            z-index: 1;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feature-item:hover .feature-icon {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .right-panel {
            flex: 1;
            padding: 60px 40px;
        }

        .form-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-size: 15px;
        }

        .tab:hover {
            color: #0ea5e9;
            background: rgba(14, 165, 233, 0.05);
        }

        .tab.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
            background: rgba(14, 165, 233, 0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f8fafc;
        }

        .form-control:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
            background: white;
        }

        .form-control:hover {
            border-color: #cbd5e1;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            transform: translateX(450px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.info {
            background: #0ea5e9;
        }

        .toast.warning {
            background: #f59e0b;
        }

        .capslock-warning {
            display: none;
            color: #f59e0b;
            font-size: 12px;
            margin-top: 6px;
            padding: 8px 12px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            align-items: center;
            gap: 6px;
        }

        .capslock-warning.show {
            display: flex;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .left-panel {
                padding: 40px 30px;
            }

            .right-panel {
                padding: 40px 30px;
            }

            .left-panel h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h1>ì•„ì£¼ì•½í’ˆ<br>ì œì•ˆì œë„ ì‹œìŠ¤í…œ</h1>
            <p>ë” ë‚˜ì€ ì—…ë¬´ í™˜ê²½ì„ ìœ„í•œ<br>ì—¬ëŸ¬ë¶„ì˜ ì•„ì´ë””ì–´ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤</p>
            
            <div class="features">
                <div class="feature-item">
                    <div class="feature-icon">âœï¸</div>
                    <div>ê°„í¸í•œ ì œì•ˆì„œ ì‘ì„±</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“Š</div>
                    <div>ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í™•ì¸</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ””</div>
                    <div>ì¦‰ê°ì ì¸ í”¼ë“œë°±</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“±</div>
                    <div>ëª¨ë°”ì¼ ì™„ë²½ ì§€ì›</div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="form-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('login', event)">ë¡œê·¸ì¸</div>
                    <div class="tab" onclick="switchTab('signup', event)">íšŒì›ê°€ì…</div>
                </div>

                <!-- ë¡œê·¸ì¸ í¼ -->
                <div id="login" class="tab-content active">
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ì‚¬ë²ˆ</label>
                            <input type="text" class="form-control" name="employeeId" required
                                placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: A197003 ë˜ëŠ” admin)"
                                style="text-transform: uppercase;"
                                oninput="this.value = this.value.toUpperCase()">
                            <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                                Aë¡œ ì‹œì‘í•˜ëŠ” 7ìë¦¬ ì‚¬ë²ˆ (ì˜ˆ: A197003) ë˜ëŠ” admin
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" class="form-control" name="password" id="loginPassword" required
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                onkeyup="checkCapsLock(event, 'loginCapsWarning')"
                                onkeydown="checkCapsLock(event, 'loginCapsWarning')">
                            <div class="capslock-warning" id="loginCapsWarning">
                                <span>âš ï¸</span> Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤
                            </div>
                            <small style="color: #6c757d; font-size: 12px; margin-top: 5px; display: block;">
                                ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: ajupharm
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
                    </form>
                </div>

                <!-- íšŒì›ê°€ì… í¼ -->
                <div id="signup" class="tab-content">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
                        <h3 style="color: #0ea5e9; margin-bottom: 15px;">ê³„ì •ì€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤</h3>
                        <p style="color: #6c757d; line-height: 1.6; margin-bottom: 30px;">
                            ê´€ë¦¬ìê°€ ì¡°ì§ë„ë¥¼ ì—…ë¡œë“œí•˜ë©´<br>
                            ëª¨ë“  ì§ì›ì˜ ê³„ì •ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
                        </p>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: left;">
                            <h4 style="color: #495057; margin-bottom: 15px; font-size: 14px;">ğŸ“Œ ë¡œê·¸ì¸ ì •ë³´</h4>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0ea5e9;">ì•„ì´ë””:</strong>
                                <span style="color: #495057;">ì‚¬ë²ˆ (ì˜ˆ: A197003)</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0ea5e9;">ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸:</strong>
                                <span style="color: #495057;">ajupharm</span>
                            </div>
                            <div style="color: #6c757d; font-size: 12px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                â„¹ï¸ ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="switchTab('login', event)"
                            style="margin-top: 20px;">
                            ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="passwordChangeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 48px; max-width: 520px; width: 90%; box-shadow: 0 25px 70px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
            <h2 style="color: #0ea5e9; margin-bottom: 12px; font-size: 26px; font-weight: 700;">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            <p style="color: #6c757d; margin-bottom: 30px; line-height: 1.6;">
                ì²« ë¡œê·¸ì¸ì…ë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.
            </p>
            
            <form id="passwordChangeForm" onsubmit="handlePasswordChange(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="6"
                        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                        onkeyup="checkCapsLock(event, 'newPwdCapsWarning')"
                        onkeydown="checkCapsLock(event, 'newPwdCapsWarning')">
                    <div class="capslock-warning" id="newPwdCapsWarning">
                        <span>âš ï¸</span> Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 30px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600;">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" class="form-control" id="confirmPassword" required minlength="6"
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                        style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                        onkeyup="checkCapsLock(event, 'confirmPwdCapsWarning')"
                        onkeydown="checkCapsLock(event, 'confirmPwdCapsWarning')">
                    <div class="capslock-warning" id="confirmPwdCapsWarning">
                        <span>âš ï¸</span> Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                    ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                </button>
            </form>
            
            <p style="color: #dc3545; font-size: 12px; margin-top: 15px; text-align: center;">
                âš ï¸ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAv0y8cF86kDC-saDZA6K0Q5fZd6dk9H1Y",
            authDomain: "suggestion-system-58def.firebaseapp.com",
            projectId: "suggestion-system-58def",
            storageBucket: "suggestion-system-58def.firebasestorage.app",
            messagingSenderId: "755050605021",
            appId: "1:755050605021:web:befd52c5516c3a3d3e2e34"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firebase ìºì‹± í™œì„±í™” (ì½ê¸° íšŸìˆ˜ ëŒ€í­ ê°ì†Œ)
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Multiple tabs open - caching disabled
                } else if (err.code == 'unimplemented') {
                    // Browser doesn't support caching
                }
            });

        // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš° ë¦¬ë‹¤ì´ë ‰íŠ¸
        // ìë™ ë¡œê·¸ì¸ ë°©ì§€: ëª…ì‹œì  ë¡œê·¸ì¸ ì‹œë„ê°€ ì—†ìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•ŠìŒ
        let isLoginAttempt = false;

        auth.onAuthStateChanged(async (user) => {
            // ë¡œê·¸ì¸ ì‹œë„ê°€ ì•„ë‹ˆë©´ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ì§€ ì•ŠìŒ
            if (user && isLoginAttempt) {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();

                        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìš” ì—¬ë¶€ í™•ì¸
                        if (userData.passwordChanged !== true) {
                            showToast('ë³´ì•ˆì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.', 'info');
                            showPasswordChangeModal(user, userData);
                            return; // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘ë‹¨
                        }

                        // ë³µìˆ˜ ê¶Œí•œ ì‹œìŠ¤í…œ - ê¶Œí•œë³„ í˜ì´ì§€ ì´ë™
                        redirectBasedOnRoles(userData);
                    }
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì˜¤ë¥˜:', error);
                }
            }
        });

        // Caps Lock ê°ì§€
        function checkCapsLock(event, warningId) {
            const warning = document.getElementById(warningId);
            if (event.getModifierState && event.getModifierState('CapsLock')) {
                warning.classList.add('show');
            } else {
                warning.classList.remove('show');
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // eventê°€ ì—†ì„ ê²½ìš° tabNameì— í•´ë‹¹í•˜ëŠ” íƒ­ì„ í™œì„±í™”
                document.querySelector(`.tab[onclick*="'${tabName}'"]`)?.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
        }

        // ë¡œê·¸ì¸
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const employeeId = formData.get('employeeId').toUpperCase().trim();
            const password = formData.get('password');

            try {
                showToast('ë¡œê·¸ì¸ ì¤‘...', 'info');

                // ë¡œê·¸ì¸ ì‹œë„ í”Œë˜ê·¸ ì„¤ì •
                isLoginAttempt = true;

                // ì‚¬ë²ˆì„ ì´ë©”ì¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (Firebase Auth ë‚´ë¶€ìš©)
                const email = `${employeeId}@ajupharm.co.kr`;

                let userCredential;

                // ë¨¼ì € Firestoreì—ì„œ ì§ì› ì •ë³´ í™•ì¸
                const empDoc = await db.collection('employees').doc(employeeId).get();

                if (!empDoc.exists) {
                    throw new Error('ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }

                const empData = empDoc.data();

                if (!empData.isActive) {
                    throw new Error('ì¬ì§ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }

                // ë¨¼ì € ë¡œê·¸ì¸ ì‹œë„
                try {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                } catch (loginError) {

                    // ê³„ì •ì´ ì—†ëŠ” ê²½ìš°
                    if (loginError.code === 'auth/user-not-found' ||
                        loginError.code === 'auth/invalid-login-credentials' ||
                        loginError.code === 'auth/invalid-credential') {

                        // ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¡œë§Œ ê³„ì • ìƒì„± ê°€ëŠ¥
                        if (password !== 'ajupharm') {
                            throw new Error('ë“±ë¡ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤. ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸(ajupharm)ë¡œ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        }

                        showToast('ê³„ì • ìƒì„± ì¤‘...', 'info');

                        // Firebase Auth ê³„ì • ìƒì„±
                        try {
                            userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        } catch (createError) {
                            if (createError.code === 'auth/email-already-in-use') {
                                // ê³„ì •ì€ ì´ë¯¸ ì¡´ì¬í•¨ - ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì‹œë„
                                try {
                                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                                    showToast('ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤...', 'info');
                                } catch (signInError) {
                                    throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³€ê²½í•˜ì‹  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                }
                            } else {
                                throw createError;
                            }
                        }

                        // ê¶Œí•œ ë°°ì—´ ìƒì„±
                        let roles = ['user']; // ê¸°ë³¸ ê¶Œí•œ

                        // ê´€ë¦¬ìê°€ ë¯¸ë¦¬ ì„¤ì •í•œ ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸
                        if (empData.preassignedRoles && Array.isArray(empData.preassignedRoles)) {
                            roles = empData.preassignedRoles;
                        } else {
                            // ìë™ ê¶Œí•œ ë¶€ì—¬
                            // ê´€ë¦¬ì ê¶Œí•œ
                            if (employeeId === 'A197003' || employeeId === 'ADMIN') {
                                roles.push('admin');
                            }

                            // í‰ê°€ì ê¶Œí•œ (ê¸°ì¡´ isLeader í•„ë“œ í™œìš©)
                            if (empData.isLeader) {
                                const leaderLevel = empData.leaderLevel || 1;
                                if (leaderLevel === 1) roles.push('firstReviewer');
                                if (leaderLevel === 2) roles.push('secondReviewer');
                                if (leaderLevel === 3) roles.push('thirdReviewer');
                            }
                        }

                        // Firestore users ì»¬ë ‰ì…˜ì— í”„ë¡œí•„ ìƒì„±
                        await db.collection('users').doc(userCredential.user.uid).set({
                            employeeId: employeeId,
                            email: email,
                            displayName: empData.name,
                            department: empData.department,
                            position: empData.position,
                            jobTitle: empData.jobTitle,
                            role: (employeeId === 'A197003' || employeeId === 'ADMIN') ? 'admin' : 'user',  // ê¸°ì¡´ í˜¸í™˜ì„±
                            roles: roles, // ìƒˆë¡œìš´ ë³µìˆ˜ ê¶Œí•œ ì‹œìŠ¤í…œ
                            isEvaluator: empData.isLeader || false,
                            leaderLevel: empData.leaderLevel || null,
                            passwordChanged: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        showToast('ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        // ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦° ê²½ìš°
                        throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                }
                
                // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();

                let userData;
                if (!userDoc.exists) {
                    // Firestore users ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ì¬ìƒì„±
                    showToast('ì‚¬ìš©ì ì •ë³´ ì¬ìƒì„± ì¤‘...', 'info');

                    // ê¶Œí•œ ë°°ì—´ ìƒì„±
                    let roles = ['user'];
                    if (empData.preassignedRoles && Array.isArray(empData.preassignedRoles)) {
                        roles = empData.preassignedRoles;
                    } else {
                        if (employeeId === 'A197003' || employeeId === 'ADMIN') roles.push('admin');
                        if (empData.isLeader) {
                            const leaderLevel = empData.leaderLevel || 1;
                            if (leaderLevel === 1) roles.push('firstReviewer');
                            if (leaderLevel === 2) roles.push('secondReviewer');
                            if (leaderLevel === 3) roles.push('thirdReviewer');
                        }
                    }

                    // Firestore users ë¬¸ì„œ ì¬ìƒì„±
                    userData = {
                        employeeId: employeeId,
                        email: email,
                        displayName: empData.name,
                        department: empData.department,
                        position: empData.position,
                        jobTitle: empData.jobTitle,
                        role: (employeeId === 'A197003' || employeeId === 'ADMIN') ? 'admin' : 'user',
                        roles: roles,
                        isEvaluator: empData.isLeader || false,
                        leaderLevel: empData.leaderLevel || null,
                        passwordChanged: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('users').doc(userCredential.user.uid).set(userData);
                } else {
                    userData = userDoc.data();
                }

                // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ìš”ì²­ í™•ì¸
                if (userData.passwordResetRequested === true) {
                    showToast('ê´€ë¦¬ìê°€ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.', 'warning');

                    setTimeout(() => {
                        showPasswordChangeModal(userCredential.user, userData);
                    }, 500);
                    return;
                }

                // ì²« ë¡œê·¸ì¸ ì²´í¬ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìš”)
                if (userData.passwordChanged !== true) {
                    showToast('ì²« ë¡œê·¸ì¸ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”.', 'info');

                    setTimeout(() => {
                        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ í‘œì‹œ
                        showPasswordChangeModal(userCredential.user, userData);
                    }, 500);
                    return;
                }
                
                showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');

                setTimeout(() => {
                    redirectBasedOnRoles(userData);
                }, 500);

            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                let message = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-login-credentials') {
                    message = 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” ajupharmì…ë‹ˆë‹¤.';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ì‚¬ë²ˆ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (Aë¡œ ì‹œì‘í•˜ëŠ” 7ìë¦¬)';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ ì‹œë„. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 'auth/email-already-in-use') {
                    message = 'ì´ë¯¸ ê³„ì •ì´ ìˆìŠµë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.message) {
                    message = error.message;
                }
                
                showToast(message, 'error');
            }
        }

        // íšŒì›ê°€ì…
        async function handleSignup(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const displayName = formData.get('displayName');
            const department = formData.get('department');

            try {
                showToast('íšŒì›ê°€ì… ì¤‘...', 'info');
                
                // Firebase Auth ì‚¬ìš©ì ìƒì„±
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // ê´€ë¦¬ì íŒë‹¨
                const adminEmails = ['admin@ajupharm.co.kr', 'admin@company.com'];
                const role = adminEmails.includes(email.toLowerCase()) ? 'admin' : 'user';
                
                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    displayName: displayName,
                    department: department,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
                
                // ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                await auth.signOut();
                setTimeout(() => {
                    switchTab('login', null);
                    e.target.reset();
                }, 1500);

            } catch (error) {
                console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                let message = 'íšŒì›ê°€ì… ì‹¤íŒ¨';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                }
                
                showToast(message, 'error');
            }
        }

        // Toast ë©”ì‹œì§€
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ í‘œì‹œ
        let currentUserForPasswordChange = null;
        let currentUserDataForPasswordChange = null;

        function showPasswordChangeModal(user, userData) {
            currentUserForPasswordChange = user;
            currentUserDataForPasswordChange = userData;
            
            const modal = document.getElementById('passwordChangeModal');
            modal.style.display = 'flex';
            
            // ESC í‚¤ë¡œ ë‹«ê¸° ë°©ì§€
            document.addEventListener('keydown', preventModalClose);
        }

        function preventModalClose(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                showToast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤!', 'error');
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²˜ë¦¬
        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
            if (newPassword !== confirmPassword) {
                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ìµœì†Œ ê¸¸ì´ í™•ì¸
            if (newPassword.length < 6) {
                showToast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼í•œì§€ í™•ì¸
            if (newPassword === 'ajupharm') {
                showToast('ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘...', 'info');

                // Firebase Authì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                await currentUserForPasswordChange.updatePassword(newPassword);

                // Firestoreì— passwordChanged í”Œë˜ê·¸ ì—…ë°ì´íŠ¸ ë° ì´ˆê¸°í™” ìš”ì²­ ì œê±°
                await db.collection('users').doc(currentUserForPasswordChange.uid).update({
                    passwordChanged: true,
                    passwordChangedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    passwordResetRequested: false,  // ì´ˆê¸°í™” ìš”ì²­ í”Œë˜ê·¸ ì œê±°
                    accountDeletedForReset: false   // ê³„ì • ì‚­ì œ í”Œë˜ê·¸ ì œê±°
                });

                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                // ëª¨ë‹¬ ë‹«ê¸°
                document.getElementById('passwordChangeModal').style.display = 'none';
                document.removeEventListener('keydown', preventModalClose);

                // í˜ì´ì§€ ì´ë™
                setTimeout(() => {
                    redirectBasedOnRoles(currentUserDataForPasswordChange);
                }, 500);

            } catch (error) {
                console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
                let message = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨';

                if (error.code === 'auth/weak-password') {
                    message = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. ë” ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.';
                } else if (error.code === 'auth/requires-recent-login') {
                    message = 'ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                    await auth.signOut();
                    window.location.reload();
                }

                showToast(message, 'error');
            }
        }

        // ë³µìˆ˜ ê¶Œí•œ ì‹œìŠ¤í…œ - ê¶Œí•œë³„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸
        function redirectBasedOnRoles(userData) {
            // roles ë°°ì—´ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ í˜¸í™˜ì„± ìœ ì§€
            if (!userData.roles || userData.roles.length === 0) {
                // ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜
                if (userData.role === 'admin') {
                    window.location.href = 'admin.html';
                } else if (userData.isEvaluator === true) {
                    window.location.href = 'leader.html';
                } else {
                    window.location.href = 'dashboard.html';
                }
                return;
            }

            const roles = userData.roles;

            // ê´€ë¦¬ì ê¶Œí•œ ìµœìš°ì„ 
            if (roles.includes('admin')) {
                window.location.href = 'admin.html';
                return;
            }

            // ë¦¬ë” ê¶Œí•œ í™•ì¸
            if (roles.includes('firstReviewer') || roles.includes('secondReviewer') || roles.includes('thirdReviewer')) {
                window.location.href = 'leader.html';
                return;
            }

            // ì¼ë°˜ ì‚¬ìš©ìëŠ” dashboardë¡œ
            window.location.href = 'dashboard.html';
        }
    </script>
</body>
</html>
